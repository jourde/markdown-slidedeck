<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Deck Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        /* ===== CSS RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-bg: #FAFAFA;
            --color-surface: #FFFFFF;
            --color-text: #111827;
            --color-text-secondary: #374151;
            --slide-font-size: 18px;
            --color-text-muted: #9CA3AF;
            --color-border: #E5E7EB;
            --color-border-light: #F3F4F6;
            --color-hover: #F9FAFB;
            --color-primary: #2563EB;
            --color-primary-light: #EFF6FF;
            --color-primary-dark: #1D4ED8;
            --color-success: #059669;
            --color-success-light: #ECFDF5;
            --color-warning: #D97706;
            --color-warning-light: #FFFBEB;
            --color-sidebar: #FFFFFF;
            --sidebar-width: 280px;
            --header-height: 60px;
            --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* ===== DARK MODE ===== */
        [data-theme="dark"] {
            --color-bg: #111827;
            --color-surface: #1F2937;
            --color-text: #F9FAFB;
            --color-text-secondary: #D1D5DB;
            --color-text-muted: #6B7280;
            --color-border: #374151;
            --color-border-light: #1F2937;
            --color-hover: #374151;
            --color-primary: #3B82F6;
            --color-primary-light: #1E3A5F;
            --color-primary-dark: #2563EB;
            --color-success: #10B981;
            --color-success-light: #064E3B;
            --color-warning: #F59E0B;
            --color-warning-light: #78350F;
            --color-sidebar: #1F2937;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ===== ACCESSIBILITY ===== */
        /* Skip Navigation Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-primary);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 10000;
            font-weight: 600;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Visually Hidden Class */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Enhanced Focus Indicators for Accessibility */
        .footer-icon-btn:focus-visible,
        .zoom-btn:focus-visible,
        .nav-item:focus-visible,
        .nav-activity:focus-visible,
        .search-history-item:focus-visible,
        .btn:focus-visible,
        .toggle-panel-btn:focus-visible,
        .search-clear:focus-visible,
        .nav-action-btn:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .export-option:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
            border-color: var(--color-primary);
        }

        /* Dark mode focus */
        [data-theme="dark"] .footer-icon-btn:focus-visible,
        [data-theme="dark"] .zoom-btn:focus-visible,
        [data-theme="dark"] .nav-item:focus-visible,
        [data-theme="dark"] .nav-activity:focus-visible,
        [data-theme="dark"] .btn:focus-visible,
        [data-theme="dark"] .toggle-panel-btn:focus-visible,
        [data-theme="dark"] .export-option:focus-visible {
            outline-color: var(--color-primary-dark);
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            transform: translateX(-100%);
            border-right: none;
        }

        .sidebar.collapsed > * {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-header {
            padding: 8px 20px;
            background: var(--color-surface);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .sidebar-header-content {
            flex: 1;
        }

        .sidebar-toggle-btn {
            background: var(--color-hover);
            border: 1px solid var(--color-border);
            cursor: pointer;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: var(--color-text);
            transition: all var(--transition);
            margin-left: 8px;
            flex-shrink: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .sidebar-toggle-btn:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .sidebar-toggle-btn .material-symbols-outlined {
            font-size: 20px;
        }

        /* Sidebar open button (when collapsed) */
        .sidebar-open-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            background: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 155;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            transition: all var(--transition);
        }

        .sidebar.collapsed ~ .sidebar-open-btn {
            display: flex;
        }

        .sidebar-open-btn:hover {
            background: var(--color-primary-dark);
            transform: translateX(2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .sidebar-open-btn .material-symbols-outlined {
            font-size: 20px;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 0.8125rem;
            color: var(--color-text-secondary);
        }

        /* Compact Footer with Material Icons */
        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Progress bar in footer */
        .progress-wrapper {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .progress-bar {
            height: 4px;
            background: var(--color-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .footer-buttons {
            display: none; /* Hide old button layout */
        }

        /* New compact icon-based footer */
        .footer-actions {
            display: flex;
            align-items: center;
            justify-content: space-around;
            gap: 4px;
            margin-top: 12px;
            padding: 8px;
            background: var(--color-border-light);
            border-radius: 12px;
        }

        .footer-icon-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 22px;
        }

        .footer-icon-btn:hover {
            background: var(--color-surface);
            color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .footer-icon-btn:active {
            transform: translateY(0);
        }

        .footer-icon-btn .material-symbols-outlined {
            font-size: 22px;
        }

        /* Tooltip on hover */
        .footer-icon-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            padding: 6px 12px;
            background: var(--color-text);
            color: var(--color-surface);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .footer-icon-btn:hover::after {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        /* Tooltip arrow */
        .footer-icon-btn::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--color-text);
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .footer-icon-btn:hover::before {
            opacity: 1;
        }

        /* Highlight specific action buttons */
        /* Active / on state for toggle-type footer buttons */
        .footer-icon-btn.active {
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .footer-icon-btn.export-action {
            color: var(--color-primary);
        }

        .footer-icon-btn.export-action:hover {
            color: var(--color-primary-dark);
            background: var(--color-primary-light);
        }

        .footer-icon-btn.import-action {
            color: var(--color-success);
        }

        .footer-icon-btn.import-action:hover {
            color: #047857;
            background: var(--color-success-light);
        }

        /* Subtle pulse animation for primary actions */
        @keyframes subtlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .footer-icon-btn.export-action .material-symbols-outlined,
        .footer-icon-btn.import-action .material-symbols-outlined {
            animation: subtlePulse 3s ease-in-out infinite;
        }

        .footer-icon-btn:hover .material-symbols-outlined {
            animation: none;
        }

        /* Dark mode special styling */
        [data-theme="dark"] .footer-actions {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .footer-icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

                .import-status {
            margin-top: 10px;
            font-size: 12px;
            color: var(--color-text-muted);
            line-height: 1.3;
            min-height: 16px;
            opacity: 0.9;
            word-break: break-word;
        }

.about-btn,
        .shortcuts-btn,
        .export-btn,
        .import-btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .about-btn svg,
        .shortcuts-btn svg,
        .export-btn svg,
        .import-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .about-btn {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .about-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .shortcuts-btn {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .shortcuts-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

.export-btn {
            background: #3B82F6; /* lighter blue */
            color: white;
        }

.export-btn:hover {
            background: #2563EB; /* previous primary */
            box-shadow: none;
            }
.import-btn {
            background: #10B981; /* lighter green */
            color: white;
        }

.import-btn:hover {
            background: #059669; /* previous success */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .export-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Export Modal */
        .export-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .export-modal.visible {
            display: flex;
        }

        .export-modal-content {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .export-modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--color-text);
        }

        .export-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all var(--transition);
        }

        .export-close-btn:hover {
            background: var(--color-hover);
            color: var(--color-text);
        }

        .export-modal-body {
            margin-bottom: 24px;
        }

        .export-description {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .export-option {
            border: 2px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            background: var(--color-surface);
            color: var(--color-text);
            text-align: left;
            font-family: inherit;
            font-size: inherit;
        }

        .export-option:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .export-option-icon {
            width: 40px;
            height: 40px;
            background: var(--color-border-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all var(--transition);
        }

        .export-option:hover .export-option-icon {
            background: var(--color-primary);
            color: white;
        }

        .export-option-icon svg {
            width: 20px;
            height: 20px;
        }

        .export-option-content {
            flex: 1;
        }

        .export-option-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .export-option-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .export-modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .export-cancel-btn {
            padding: 10px 20px;
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .export-cancel-btn:hover {
            background: var(--color-hover);
        }

        /* ===== EXPORT MULTI-STEP ===== */
        .export-step--hidden {
            display: none;
        }

        .export-modal-content.export-step2-active {
            max-width: 560px;
        }

        .export-modal-footer {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-select-all-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .export-select-all-btn {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-primary);
            cursor: pointer;
            transition: all var(--transition);
        }

        .export-select-all-btn:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
        }

        .export-select-all-btn:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .export-module-count {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .export-module-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 260px;
            overflow-y: auto;
            padding-right: 4px;
            margin-bottom: 4px;
        }

        .export-module-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--color-surface);
            user-select: none;
            list-style: none;
        }

        .export-module-item:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .export-module-item.is-checked {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .export-module-item input[type="checkbox"] {
            margin-top: 2px;
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            accent-color: var(--color-primary);
            cursor: pointer;
        }

        .export-module-item input[type="checkbox"]:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 2px;
        }

        .export-module-item-label {
            flex: 1;
            cursor: pointer;
        }

        .export-module-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text);
            line-height: 1.4;
        }

        .export-module-item-meta {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .export-back-btn {
            padding: 10px 20px;
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .export-back-btn:hover {
            background: var(--color-hover);
        }

        .export-back-btn--hidden {
            display: none;
        }

        .export-confirm-btn {
            padding: 10px 20px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            margin-left: 6px;
        }

        .export-confirm-btn:hover:not(:disabled) {
            background: var(--color-primary-dark, #1565c0);
        }

        .export-confirm-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .export-confirm-btn--hidden {
            display: none;
        }

        /* About Modal */
        .about-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .about-modal.visible {
            display: flex;
        }

        .about-modal-content {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 32px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .about-section {
            margin-bottom: 28px;
        }

        .about-section:last-child {
            margin-bottom: 0;
        }

        .about-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-border-light);
        }

        .about-section-icon {
            width: 32px;
            height: 32px;
            background: var(--color-primary-light);
            color: var(--color-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .about-section-icon svg {
            width: 18px;
            height: 18px;
        }

        .about-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .about-section-content {
            padding-left: 44px;
        }

        .about-info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .about-info-label {
            font-weight: 600;
            color: var(--color-text);
            min-width: 140px;
            flex-shrink: 0;
        }

        .about-info-value {
            color: var(--color-text-secondary);
            line-height: 1.6;
            overflow-wrap: anywhere;
        }

        .about-description {
            font-size: 14px;
            color: var(--color-text-secondary);
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .about-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .about-list li {
            padding: 6px 0;
            font-size: 14px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .about-list li::before {
            content: 'â€¢';
            color: var(--color-primary);
            font-weight: bold;
            flex-shrink: 0;
        }

        .about-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--color-primary-light);
            color: var(--color-primary);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .about-modules {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .about-module-card {
            background: var(--color-border-light);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .about-module-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 6px;
        }

        .about-module-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        .about-module-meta {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 8px;
        }

        /* Search Box */
        .search-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .search-clear:hover {
            background: var(--color-hover);
            color: var(--color-text);
        }

        .search-clear.visible {
            display: flex;
        }

.nav-actions-row {
    padding: 0 12px 12px;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: nowrap;
}

.nav-action-btn {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    background: var(--color-surface);
    color: var(--color-text-secondary);
    cursor: pointer;
    font-size: 13px;
    transition: background var(--transition), color var(--transition), border-color var(--transition);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.nav-action-btn:hover {
    background: var(--color-hover);
    color: var(--color-text);
}

.nav-icon-text-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 6px;
    border-radius: 6px;
    transition: background 0.15s ease;
    flex: 1;
    min-width: 0;
    justify-content: center;
}

.nav-icon-text-btn:hover {
    background: var(--color-hover);
}

.nav-icon-text-btn .material-symbols-outlined {
    font-size: 20px;
    color: var(--color-text-secondary);
    flex-shrink: 0;
}

.nav-icon-text-btn span:last-child {
    font-size: 12px;
    color: #6B7280;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.nav-icon-text-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.nav-icon-text-btn:disabled:hover {
    background: none;
}

.nav-action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.nav-action-icon {
    display: inline-block;
    color: var(--color-text-muted);
    font-size: 14px;
    line-height: 1;
    transition: transform var(--transition);
}

.nav-action-btn[aria-pressed="true"] .nav-action-icon {
    transform: rotate(90deg);
}

/* Ignored elements styles */
.nav-moment.ignored,
.nav-submoment.ignored,
.nav-activity.ignored {
    display: none !important;
}

body.show-ignored .nav-moment.ignored,
body.show-ignored .nav-submoment.ignored,
body.show-ignored .nav-activity.ignored {
    display: block !important;
    opacity: 1;
    background-color: #E5E7EB !important;
    border-left: 3px solid #9CA3AF !important;
    transition: background-color 0.2s ease, border-color 0.2s ease;
}

/* Apply background to child headers for moments/submoments */
body.show-ignored .nav-moment.ignored .nav-item-header,
body.show-ignored .nav-submoment.ignored .nav-item-header {
    background-color: transparent !important;
}

/* Grey text and strikethrough for ignored items */
body.show-ignored .nav-moment.ignored .nav-item-title,
body.show-ignored .nav-submoment.ignored .nav-item-title,
body.show-ignored .nav-activity.ignored .nav-activity-label {
    color: #6B7280 !important;
    text-decoration: line-through;
}

body.show-ignored .nav-moment.ignored .nav-item-title::after,
body.show-ignored .nav-submoment.ignored .nav-item-title::after,
body.show-ignored .nav-activity.ignored .nav-activity-label::after {
    content: " (ignored)";
    font-size: 0.75em;
    color: #9CA3AF;
    font-style: italic;
    text-decoration: none;
}

/* Dark mode adjustments for ignored items */
[data-theme="dark"] body.show-ignored .nav-moment.ignored,
[data-theme="dark"] body.show-ignored .nav-submoment.ignored,
[data-theme="dark"] body.show-ignored .nav-activity.ignored {
    background-color: #374151 !important;
    border-left-color: #6B7280 !important;
}

[data-theme="dark"] body.show-ignored .nav-moment.ignored .nav-item-title,
[data-theme="dark"] body.show-ignored .nav-submoment.ignored .nav-item-title,
[data-theme="dark"] body.show-ignored .nav-activity.ignored .nav-activity-label {
    color: #9CA3AF !important;
}

/* Navigation Tree */
        .nav-tree {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
        }

        .nav-module {
            margin-bottom: 8px;
        }

        .nav-module-header {
            padding: 8px 12px;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: lowercase;
            letter-spacing: 0.5px;
        }

        .nav-moment,
        .nav-submoment {
            margin-left: 8px;
        }

        .nav-item-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: default;
            border-radius: 6px;
            transition: background var(--transition);
            user-select: none;
        }

        .nav-item-header:hover {
            background: var(--color-hover);
        }

        .nav-expand-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            color: var(--color-text-muted);
            transition: transform var(--transition);
            flex-shrink: 0;
        }

        .nav-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .nav-item-title {
            font-size: 14px;
            color: var(--color-text);
            flex: 1;
            text-transform: lowercase;
        }

        .nav-children {
            display: block;
            margin-left: 12px;
            margin-top: 4px;
        }
.nav-activity {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--color-text-secondary);
            transition: all var(--transition);
            border-left: 3px solid transparent;
            text-transform: lowercase;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
        }

        .nav-activity-label {
            flex: 1;
            min-width: 0;
            color: inherit;
        }

        .nav-activity:hover {
            background: var(--color-hover);
        }

        .nav-activity:hover .nav-activity-label {
            color: var(--color-text);
        }

        .nav-activity.active {
            background: var(--color-primary-light);
            border-left-color: var(--color-primary);
            font-weight: 500;
        }

        .nav-activity.active .nav-activity-label {
            color: var(--color-primary);
        }

        /* Covered activity indicator (no ticks): title turns green */
        .nav-activity.completed:not(.active) {
            border-left-color: var(--color-success);
        }

        .nav-activity.completed:not(.active) .nav-activity-label {
            color: var(--color-success);
            font-weight: 500;
        }

        .nav-activity.completed:not(.active):hover {
            background: var(--color-success-light);
        }

        /* Moment and Submoment completion indicators */
        .nav-item-header.has-progress {
            position: relative;
        }

        .nav-progress-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: var(--color-border-light);
            color: var(--color-text-muted);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .nav-progress-badge.completed {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .nav-progress-badge.in-progress {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        /* Module header progress */
        .nav-module-header {
            position: relative;
        }

        .nav-module-progress {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-top: 4px;
            font-weight: 400;
        }

        .nav-module-progress.completed {
            color: var(--color-success);
            font-weight: 500;
        }

        .slide-count {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-left: 8px;
            text-transform: lowercase;
        }

        /* Enhanced Search Results */
        .search-results {
            display: none;
            padding: 8px;
        }

        .search-results.visible {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Search Filters */
        .search-filters {
            padding: 12px;
            background: var(--color-border-light);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-filters-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-surface);
            color: var(--color-text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .search-filter-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .search-filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .search-filter-btn .material-symbols-outlined {
            font-size: 16px;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
            margin-bottom: 8px;
        }

        .search-results-count {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .search-clear-filters {
            font-size: 11px;
            color: var(--color-primary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all var(--transition);
        }

        .search-clear-filters:hover {
            background: var(--color-primary-light);
        }

        /* Search History */
        .search-history {
            padding: 12px;
            background: var(--color-border-light);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .search-history-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-history-clear {
            font-size: 10px;
            color: var(--color-text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: all var(--transition);
            text-transform: none;
        }

        .search-history-clear:hover {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .search-history-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .search-history-item {
            padding: 6px 10px;
            background: var(--color-surface);
            border-radius: 4px;
            font-size: 12px;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-history-item:hover {
            background: var(--color-hover);
            color: var(--color-text);
        }

        .search-history-item .material-symbols-outlined {
            font-size: 14px;
            color: var(--color-text-muted);
        }

        /* Enhanced Search Result Item with Thumbnail */
        .search-result-item {
            padding: 10px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .search-result-item:hover {
            background: var(--color-hover);
            border-color: var(--color-primary);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-result-thumbnail {
            width: 60px;
            height: 45px;
            border-radius: 6px;
            background: var(--color-border-light);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-border);
            overflow: hidden;
            position: relative;
        }

        .search-result-thumbnail .material-symbols-outlined {
            font-size: 24px;
            color: var(--color-text-muted);
        }

        .search-result-thumbnail-text {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-align: center;
            padding: 4px;
            line-height: 1.2;
        }

        .search-result-content {
            flex: 1;
            min-width: 0;
        }

        .search-result-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-result-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--color-primary-light);
            color: var(--color-primary);
            font-weight: 600;
        }

        .search-result-context {
            font-size: 11px;
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .search-result-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 10px;
            color: var(--color-text-muted);
        }

        .search-result-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .search-result-meta-item .material-symbols-outlined {
            font-size: 14px;
        }

        .search-highlight {
            background: #FFF59D;
            color: #111827;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }

        [data-theme="dark"] .search-highlight {
            background: #F59E0B;
            color: #1F2937;
        }

        .no-results {
            padding: 40px 20px;
            text-align: center;
            color: var(--color-text-secondary);
        }

        .no-results .material-symbols-outlined {
            font-size: 48px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
        }

        .no-results-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .no-results-text {
            font-size: 13px;
            line-height: 1.5;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: 64px;
            padding-bottom: 60px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: 0;
        }

        .content-header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 20px 32px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        /* Top Right Controls Container */
        .top-right-controls {
            position: absolute;
            top: 60px;
            right: 24px;
            z-index: 160;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
        }

        /* Timer Top Right */
        .timer-top-right {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            min-width: 200px;
        }

        .timer-top-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-top-right .timer-display {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--color-text);
            flex: 1;
        }

        .timer-top-right .timer-display.green .timer-elapsed {
            color: #10B981;
        }

        .timer-top-right .timer-display.yellow .timer-elapsed {
            color: #F59E0B;
        }

        .timer-top-right .timer-display.red .timer-elapsed {
            color: #EF4444;
        }

        .timer-top-right .timer-separator {
            color: var(--color-text-muted);
        }

        .timer-top-right .timer-planned {
            color: var(--color-text-muted);
        }

        .timer-top-right .timer-controls {
            display: flex;
            gap: 4px;
        }

        .timer-top-right .timer-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color var(--transition);
        }

        .timer-top-right .timer-btn:hover {
            background: var(--color-border-light);
        }

        .timer-top-right .timer-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Timer Progress Bar */
        .timer-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--color-border-light);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .timer-progress-fill {
            height: 100%;
            background: #10B981;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .timer-progress-fill.yellow {
            background: #F59E0B;
        }

        .timer-progress-fill.red {
            background: #EF4444;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid var(--color-border);
        }

        .font-size-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text);
            min-width: 32px;
            text-align: center;
            user-select: none;
        }

        /* Hide the old select dropdown */
        .font-size-select {
            display: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            color: var(--color-text);
        }

        .zoom-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .zoom-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .zoom-btn:disabled:hover {
            background: none;
            border-color: var(--color-border);
        }

        .zoom-btn svg {
            width: 16px;
            height: 16px;
        }

        .zoom-level {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
            min-width: 45px;
            text-align: center;
        }

        /* Collapsible Sections */
        .collapsible-section {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 4px;
            cursor: pointer;
            user-select: none;
            transition: background-color var(--transition);
        }

        .section-header:hover {
            background: var(--color-hover);
            border-radius: 6px;
        }

        .section-toggle-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            font-size: 20px;
            font-family: 'Material Symbols Outlined';
            color: var(--color-text);
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
        }

        .section-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .section-toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Hide section headers (now in bottom controls bar) */
        .section-header {
            display: none;
        }

        /* Bottom Control Bar for Zoom/Timer Toggles */
        .section-toggle-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 8px;
            margin: 8px 0;
        }

        .section-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--color-text);
            transition: all var(--transition);
            padding: 0;
            font-size: 0;
        }

        .section-toggle-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .section-toggle-btn:active {
            transform: scale(0.93);
        }

        .section-toggle-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
        }

        .section-toggle-btn.active:hover {
            opacity: 0.88;
        }

        .section-toggle-btn .material-symbols-outlined {
            font-size: 18px;
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
        }

        .section-toggle-btn.active .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 20;
        }

        /* Zoomed content - centered in viewport */
        .slide {
            transform-origin: center center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .activity-context {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 6px;
            min-height: 22px;
        }

        .activity-context-chip {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--color-text-muted);
            background: var(--color-hover);
            border-radius: 4px;
            padding: 2px 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 260px;
        }

        .activity-context-chip.chip-module {
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .activity-context-separator {
            font-size: 10px;
            color: var(--color-border);
            user-select: none;
            flex-shrink: 0;
        }

        /* Activity metadata chips (logistics: duration, group size, place, trainer) */
        .activity-meta-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            min-height: 0;
            margin-bottom: 4px;
        }
        .activity-meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 500;
            color: var(--color-text-muted);
            background: var(--color-hover);
            border-radius: 4px;
            padding: 2px 7px 2px 5px;
        }
        .activity-meta-chip .material-symbols-outlined {
            font-size: 13px;
            line-height: 1;
        }

        .activity-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0;
        }

        /* Slide Container */
        .slide-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 56px 48px;
            max-width: 1100px;
            margin: 0 auto;
            width: 100%;
            overflow: visible;
            position: relative;
            scroll-behavior: smooth;
        }

        /* When content might overflow due to zoom, allow scrolling on main-content instead */
        .main-content {
            overflow-x: auto;
            overflow-y: auto;
        }

        .slide {
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 48px;
            width: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
            box-sizing: border-box;
        }

        /* Title slides need special handling for absolute positioning */
        .slide-title-full {
            padding: 0 !important;
            position: relative;
            min-height: 500px;
            overflow: hidden;
        }

        /* Ensure zoomed slides don't get cut off */
        .slide[style*="scale"] {
            margin: auto;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-title {
            display: none; /* Force hide any slide titles */
        }

        /* Ignored slide banner */
        .ignored-slide-banner {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #E5E7EB;
            border-left: 4px solid #9CA3AF;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 16px;
            color: #6B7280;
        }

        .ignored-slide-banner .material-symbols-outlined {
            font-size: 24px;
        }

        /* Dark mode for ignored banner */
        [data-theme="dark"] .ignored-slide-banner {
            background: #374151;
            border-left-color: #6B7280;
            color: #9CA3AF;
        }

        /* Grey out ignored slide content */
        .slide-ignored .slide-content {
            background: #F3F4F6;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
        }

        .slide-ignored .slide-content * {
            color: #9CA3AF !important;
            text-decoration: line-through;
        }

        /* Dark mode for ignored slide content */
        [data-theme="dark"] .slide-ignored .slide-content {
            background: #1F2937;
            border-color: #374151;
        }

        [data-theme="dark"] .slide-ignored .slide-content * {
            color: #6B7280 !important;
        }

        .slide-content {
            font-size: var(--slide-font-size);
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        /* More compact typography inside slides */
        .slide-content h1,
        .slide-content h2,
        .slide-content h3,
        .slide-content h4 {
            line-height: 1.2;
            margin: 0 0 10px;
        }

        .slide-content ul,
        .slide-content ol {
            margin-left: 22px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .slide-content li {
            margin-bottom: 4px;
        }

        .slide-content p {
            margin: 0 0 4px;
        }

        .slide-content img.md-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 16px auto;
            border-radius: 10px;
        }

        .slide-content strong {
            color: var(--color-text);
            font-weight: 600;
        }

        .slide-content code {
            background: var(--color-border-light);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .slide-content pre {
            background: var(--color-border-light);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .slide-content pre code {
            background: none;
            padding: 0;
        }

        .slide-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.95em;
        }

        .slide-content th,
        .slide-content td {
            border: 1px solid var(--color-border);
            padding: 8px 12px;
            text-align: left;
        }

        .slide-content th {
            background: var(--color-border-light);
            font-weight: 600;
            color: var(--color-text);
        }

        .slide-content tr:nth-child(even) td {
            background: var(--color-hover);
        }

        .slide-content blockquote {
            border-left: 4px solid var(--color-primary);
            margin: 12px 0;
            padding: 8px 16px;
            background: var(--color-primary-light);
            color: var(--color-text-secondary);
            border-radius: 0 6px 6px 0;
        }

        /* Navigation Controls */
        .slide-controls {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            position: fixed;
            bottom: 0;
            left: var(--sidebar-width);
            right: 0;
            z-index: 100;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed ~ .main-content .slide-controls {
            left: 0;
        }

        /* Navigation bar - always visible */
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 24px;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
        }

        .nav-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-panel-btn {
            display: none;
            color: var(--color-text);
            transition: all var(--transition);
        }

        .toggle-panel-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .toggle-panel-btn svg {
            width: 14px;
            height: 14px;
            transition: transform var(--transition);
        }

        .toggle-panel-btn.expanded svg {
            transform: rotate(180deg);
        }

        .slide-counter {
            font-size: 13px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .nav-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Collapsible panel */
        .details-panel {
            display: none;
        }

        .details-panel.expanded {
            max-height: 400px;
        }

        .details-panel-content {
            padding: 12px 24px;
            display: grid;
            grid-template-columns: auto auto;
            gap: 10px 20px;
        }

        .panel-section {
            display: contents;
        }

        .panel-timers {
            grid-column: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .timers-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .timers-row .timer-container {
            flex: 1 1 260px;
        }


        .panel-progress {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .slide-counter {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .slide-nav-buttons {
            display: flex;
            gap: 6px;
        }

        .btn-next-section {
            background: var(--color-success);
            color: white;
            border: 2px solid var(--color-success);
        }

        .btn-next-section:hover {
            background: #047857;
            border-color: #047857;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-next-section:disabled {
            background: var(--color-border);
            border-color: var(--color-border);
            color: var(--color-text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-next-section:disabled:hover {
            background: var(--color-border);
            border-color: var(--color-border);
            box-shadow: none;
        }

        .btn-next-section svg {
            width: 16px;
            height: 16px;
        }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-dark);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-hover);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Mobile Menu */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
            z-index: 1001;
        }

        .mobile-menu-btn {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text);
        }

        .mobile-menu-btn:active {
            background: var(--color-hover);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .mobile-overlay.visible {
            display: block;
            opacity: 1;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            max-width: 700px;
            margin: 0 auto;
            padding: 60px 32px;
        }

        .welcome-title {
            font-size: 48px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .welcome-subtitle {
            font-size: 20px;
            color: var(--color-text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .welcome-description {
            font-size: 16px;
            color: var(--color-text-secondary);
            margin-bottom: 40px;
            line-height: 1.7;
        }

        .welcome-cta {
            padding: 14px 32px;
            font-size: 16px;
        }

        .welcome-options-container {
            max-width: 960px;
            margin: 40px auto 0;
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
            gap: 32px;
            align-items: stretch;
        }

        .welcome-option {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            padding: 28px;
            text-align: center;
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 280px;
            min-width: 0;
        }

        .welcome-option:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .welcome-option-header {
            margin-bottom: 16px;
        }

        .welcome-option-number {
            display: inline-block;
            font-size: 12px;
            font-weight: 700;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .welcome-option-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
            margin: 8px 0 0 0;
            line-height: 1.4;
        }

        .welcome-option-description {
            font-size: 14px;
            color: var(--color-text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .welcome-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .welcome-divider::before,
        .welcome-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }

        .welcome-divider::before {
            margin-right: 12px;
        }

        .welcome-divider::after {
            margin-left: 12px;
        }

        .welcome-github-section {
            margin-top: 24px;
        }

        .welcome-github-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .welcome-github-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
            transition: all var(--transition);
        }

        .welcome-github-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        .welcome-github-input::placeholder {
            color: var(--color-text-muted);
        }

        .welcome-github-btn {
            padding: 12px 24px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .welcome-github-input {
            background: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .welcome-github-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .welcome-options-container {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .welcome-divider {
                grid-column: 1;
                flex-direction: column;
            }

            .welcome-divider::before,
            .welcome-divider::after {
                display: none;
            }

            .welcome-divider span {
                display: none;
            }

            .welcome-option {
                padding: 24px;
            }

            .welcome-github-input-group {
                flex-direction: column;
            }

            .welcome-github-input {
                width: 100%;
            }

            .welcome-github-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ===== TIMELINE INTRO SLIDE ===== */
        .timeline-intro-slide {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 32px;
            height: 100%;
        }

        .timeline-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .timeline-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .timeline-subtitle {
            font-size: 1.125rem;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .timeline-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            font-size: 0.9375rem;
            color: var(--color-text-muted);
        }

        .timeline-stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Timeline Content - Scrollable */
        .timeline-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
            margin-bottom: 24px;
        }

        /* Module Card */
        .timeline-module {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .timeline-module:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .timeline-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .timeline-module-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .timeline-module-duration {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--color-primary);
            background: var(--color-primary-light);
            padding: 4px 12px;
            border-radius: 6px;
        }

        /* Moments Container */
        .timeline-moments {
            margin-top: 12px;
        }

        .timeline-moment {
            margin-bottom: 16px;
            padding-left: 16px;
            border-left: 3px solid var(--color-border-light);
        }

        .timeline-moment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-moment-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .timeline-moment-duration {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        /* Submoments Container */
        .timeline-submoments {
            margin-top: 8px;
            padding-left: 16px;
        }

        .timeline-submoment {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: var(--color-hover);
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .timeline-submoment:hover {
            background: var(--color-border-light);
        }

        .timeline-submoment-title {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
        }

        .timeline-submoment-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8125rem;
            color: var(--color-text-muted);
        }

        .timeline-submoment-duration {
            font-weight: 500;
        }

        /* Footer Button */
        .timeline-footer {
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        .timeline-start-btn {
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-start-btn svg {
            width: 20px;
            height: 20px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 280px;
            }

            .slide {
                padding: 32px;
            }

            .slide-title {
                font-size: 28px;
            }

            .slide-content {
                font-size: 16px;
            }

            /* Train line - Tablet */
            .train-line-wrapper {
                padding: 0 16px;
            }

            .station-label {
                font-size: 9px;
                max-width: 60px;
            }

            .station-marker {
                width: 28px;
                height: 28px;
            }

            .station-marker.current {
                width: 32px;
                height: 32px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: calc(var(--header-height) + 44px);
            }

            .slide-controls {
                left: 0;
            }

            .mobile-header {
                display: flex;
            }

            /* Train line - Mobile */
            .train-line-container {
                height: 44px;
                left: 0;
            }

            .train-line-wrapper {
                display: none;
            }

            .train-line-mobile {
                display: flex;
                flex-direction: column;
                justify-content: center;
                height: 100%;
                padding: 0 16px;
            }

            .mobile-progress-text {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 6px;
            }

            .mobile-progress-text span {
                font-size: 11px;
                font-weight: 600;
                color: var(--color-text-secondary);
            }

            .mobile-progress-count {
                color: var(--color-text-muted);
            }

            .mobile-progress-track {
                width: 100%;
                height: 4px;
                background: var(--color-border-light);
                border-radius: 2px;
                overflow: hidden;
            }

            .mobile-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dark));
                border-radius: 2px;
                transition: width 0.5s ease;
            }

            .content-header {
                top: 0;
            }

            .slide-container {
                padding: 24px 16px;
            }

            .slide {
                padding: 24px;
                min-height: 300px;
            }

            .slide-title {
                font-size: 24px;
            }

            /* Timeline responsive */
            .timeline-intro-slide {
                padding: 24px 16px;
            }

            .timeline-title {
                font-size: 2rem;
            }

            .timeline-stats {
                flex-direction: column;
                gap: 8px;
            }

            .slide-content {
                font-size: 15px;
            }

            .slide-controls {
                padding: 0;
            }

            .nav-bar {
                flex-direction: column;
                align-items: stretch;
                padding: 8px 12px;
                gap: 8px;
            }

            .nav-bar-left,
            .nav-bar-right {
                width: 100%;
                justify-content: space-between;
            }

            .nav-bar-left {
                order: 2;
            }

            .nav-bar-right {
                order: 1;
            }

            .details-panel-content {
                grid-template-columns: 1fr;
                padding: 10px 12px;
                gap: 12px;
            }

            .panel-timers,
            .panel-progress {
                grid-column: 1;
            }

            .timer-container {
                padding: 5px 12px;
                gap: 8px;
            }

            .timer-label {
                font-size: 10px;
            }

            .timer-display {
                font-size: 13px;
            }

            .timer-elapsed,
            .timer-planned {
                min-width: 50px;
            }

            .timer-btn {
                width: 26px;
                height: 26px;
            }

            .timer-btn svg {
                width: 12px;
                height: 12px;
            }

            .slide-nav-buttons {
                width: 100%;
                flex-wrap: wrap;
            }

            .btn {
                flex: 1;
                min-width: 120px;
            }

            .btn-next-section {
                flex: 1 1 100%;
                margin-top: 8px;
            }

            .welcome-title {
                font-size: 32px;
            }

            .welcome-subtitle {
                font-size: 18px;
            }

            /* Timer responsive adjustments */
            .timer-container {
                font-size: 13px;
                padding: 6px 12px;
                gap: 8px;
            }

            .timer-display {
                font-size: 14px;
            }

            .timer-elapsed,
            .timer-planned {
                min-width: 55px;
            }

            .timer-btn {
                width: 28px;
                height: 28px;
            }

            .timer-btn svg {
                width: 12px;
                height: 12px;
            }

            .activity-timer {
                width: 100%;
                margin-right: 0;
                margin-bottom: 12px;
            }

            .module-timer {
                margin-top: 12px;
            }

            /* Export modal responsive */
            .export-modal-content {
                padding: 24px;
                max-width: 100%;
                margin: 0 16px;
            }

            .export-modal-title {
                font-size: 20px;
            }

            .export-option {
                padding: 12px;
            }

            .export-option-icon {
                width: 36px;
                height: 36px;
            }

            .export-option-title {
                font-size: 15px;
            }

            .export-option-desc {
                font-size: 12px;
            }

            /* About modal responsive */
            .about-modal-content {
                padding: 24px;
                max-width: 100%;
                margin: 0;
            }

            .about-section-content {
                padding-left: 0;
            }

            .about-info-row {
                flex-direction: column;
            }

            .about-info-label {
                min-width: auto;
                margin-bottom: 2px;
            }

            /* Progress bars responsive */
            .progress-bar-label {
                font-size: 11px;
            }

            .progress-bar-track {
                height: 5px;
            }

            .activity-timer {
                flex-direction: column;
                align-items: stretch;
            }

            .activity-progress {
                margin-top: 8px;
            }

            /* Zoom controls responsive */
            .zoom-controls {
                top: 8px;
                right: 8px;
                padding: 6px;
                gap: 6px;
            }

            .zoom-btn {
                width: 28px;
                height: 28px;
            }

            .zoom-btn svg {
                width: 14px;
                height: 14px;
            }

            .zoom-level {
                font-size: 12px;
                min-width: 40px;
            }
        }

        /* ===== TIMERS ===== */
        .timer-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }

        .timer-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timer-display {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 4px;
            transition: all var(--transition);
        }

        .timer-display.green {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .timer-display.orange {
            background: #FFF3E0;
            color: #E65100;
        }

        .timer-display.red {
            background: #FFEBEE;
            color: #C62828;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 140px;
        }

        .timer-progress-track {
            height: 6px;
            background: var(--color-border-light);
            border-radius: 999px;
            overflow: hidden;
        }

        .timer-progress-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .timer-progress-fill.green {
            background: #2E7D32;
        }

        .timer-progress-fill.orange {
            background: #E65100;
        }

        .timer-progress-fill.red {
            background: #C62828;
        }

        .timer-elapsed {
            min-width: 55px;
        }

        .timer-separator {
            color: var(--color-text-muted);
        }

        .timer-planned {
            color: var(--color-text-secondary);
            min-width: 55px;
        }

        .timer-controls {
            display: flex;
            gap: 4px;
        }

        .timer-btn {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--color-text-secondary);
        }

        .timer-btn:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .timer-btn:active {
            transform: scale(0.95);
        }

        .timer-btn.playing {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .timer-btn svg {
            width: 13px;
            height: 13px;
        }

        /* Progress Bars */
        .progress-bar-container {
            margin-top: 8px;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .progress-bar-title {
            font-weight: 600;
        }

        .progress-bar-percentage {
            color: var(--color-text-muted);
        }

        .progress-bar-track {
            height: 5px;
            background: var(--color-border-light);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dark));
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-bar-fill.complete {
            background: linear-gradient(90deg, var(--color-success), #047857);
        }

        .module-progress {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        .general-progress {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
        }

        .activity-progress {
            margin-top: 12px;
        }

        .module-timer {
            margin-top: 8px;
        }

        .activity-timer {
            margin-right: auto;
        }

        /* ===== UTILITY ===== */
        .hidden {
            display: none !important;
        }

        /* Scrollbar styling */
        .nav-tree::-webkit-scrollbar {
            width: 8px;
        }

        .nav-tree::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-tree::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        .nav-tree::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-muted);
        }
        /* ===== DARK MODE TOGGLE ===== */
        .dark-mode-toggle {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .dark-mode-toggle:hover {
            background: var(--color-hover);
            border-color: var(--color-text-muted);
        }

        .dark-mode-toggle svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .sidebar,
            .mobile-header,
            .mobile-overlay,
            .zoom-controls,
            .slide-controls,
            .search-container,
            .nav-actions-row,
            .sidebar-footer,
            .export-modal,
            .about-modal,
            .dark-mode-toggle,
            .train-line-container {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding-top: 0 !important;
            }

            .slide-container {
                padding: 20px !important;
                max-width: 100% !important;
            }

            .slide {
                page-break-inside: avoid;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }

            .content-header {
                position: static !important;
                border-bottom: 2px solid #333 !important;
                margin-bottom: 20px;
            }

            body {
                background: white !important;
                color: black !important;
                font-size: 12pt;
            }

            .slide-content {
                font-size: 12pt !important;
                color: black !important;
            }

            .slide-content a {
                color: black !important;
                text-decoration: underline;
            }

            .slide-content a::after {
                content: " (" attr(href) ")";
                font-size: 9pt;
                color: #555;
            }

            .slide-content table {
                border: 1px solid #333;
            }

            .slide-content th,
            .slide-content td {
                border: 1px solid #333;
            }
        }

        /* ===== ENHANCEMENT 1: GLASSMORPHISM EFFECTS ===== */
        .export-modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .export-modal-content {
            background: rgba(31, 41, 55, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .about-modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .about-modal-content {
            background: rgba(31, 41, 55, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .zoom-controls {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1),
                        0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .zoom-controls {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .sidebar {
            background: rgba(31, 41, 55, 0.95);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.3);
        }

        /* ===== ENHANCEMENT 2: SLIDE NUMBER INDICATOR ===== */
        .slide-number-indicator {
            position: absolute;
            top: 20px;
            right: 24px;
            background: var(--color-primary);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            z-index: 50;
            animation: slideNumberFadeIn 0.4s ease;
        }

        @keyframes slideNumberFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        [data-theme="dark"] .slide-number-indicator {
            background: var(--color-primary);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        /* ===== ENHANCEMENT 4: MODULE SEPARATORS ===== */
        .nav-module-separator {
            height: 1px;
            background: linear-gradient(
                to right,
                transparent,
                var(--color-border) 20%,
                var(--color-border) 80%,
                transparent
            );
            margin: 12px 0;
            position: relative;
        }

        .nav-module-separator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 1px;
            background: var(--color-primary);
            opacity: 0.3;
        }

        /* ===== TRAIN LINE VISUALIZATION ===== */
        .train-line-container {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 64px;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            z-index: 150;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: visible;
        }

        .sidebar.collapsed ~ .main-content .train-line-container {
            left: 0;
        }

        .train-line-wrapper {
            max-width: 1400px;
            height: 100%;
            margin: 0 auto;
            padding: 0 48px;
            position: relative;
            display: flex;
            align-items: center;
            overflow: visible;
        }

        .train-line-mobile {
            display: none;
        }

        .train-track {
            position: absolute;
            top: 62%;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(
                to right,
                var(--color-border) 0%,
                var(--color-primary) 0%,
                var(--color-primary) var(--train-progress, 0%),
                var(--color-border) var(--train-progress, 0%)
            );
            transform: translateY(-50%);
            border-radius: 2px;
            transition: background 0.5s ease;
        }

        .train-stations {
            display: block; /* ChangÃ© de flex Ã  block pour positionnement absolu */
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 2;
            overflow: visible;
        }

        .train-station {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: absolute; /* ChangÃ© pour positionnement manuel */
            top: 62%;
            transform: translate(-50%, -50%);
            transition: transform var(--transition);
        }

        .train-station:hover {
            transform: translate(-50%, -50%) translateY(-2px);
        }


        .train-station:focus-visible {
            outline: 3px solid var(--color-primary);
            outline-offset: 4px;
            border-radius: 8px;
        }

        .train-station.current .station-marker {
        }

        .station-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-surface);
            border: 3px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 6px;
        }

        .station-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: transparent;
            transition: all 0.3s ease;
        }

        .station-number {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-muted);
            position: absolute;
            transition: all 0.3s ease;
        }

        .station-marker.completed {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }

        .station-marker.completed .station-dot {
            background: white;
        }

        .station-marker.completed .station-number {
            color: white;
        }

        .station-marker.current {
            background: var(--color-primary);
            border-color: var(--color-primary);
            border-width: 4px;
            width: 36px;
            height: 36px;
        }

        .station-marker.current .station-number {
            color: white;
            font-weight: 700;
        }

        .station-marker.future {
            background: var(--color-surface);
            border-color: var(--color-border-light);
        }

        .station-marker.future .station-number {
            color: var(--color-text-muted);
        }

        .station-label {
            display: none;
        }

        /* Segments de moments - structural markers only (progress shown by track gradient) */
        .moment-segment {
            position: absolute;
            height: 8px;
            top: 62%;
            transform: translateY(-50%);
            background: transparent;
            border-left: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            transition: all 0.3s ease;
            z-index: 0;
            cursor: pointer;
        }

        .moment-segment:hover {
            height: 12px;
        }

        /* Tooltip pour segments de moments */
        .moment-segment::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 200;
        }

        .moment-segment:hover::after {
            opacity: 1;
        }

        /* Sous-moments - petits points sur la ligne */
        .submoment-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-surface);
            border: 2px solid var(--color-border-light);
            position: absolute;
            top: 62%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .submoment-dot:hover {
            transform: translate(-50%, -50%) scale(1.3);
        }

        /* All dots stay neutral â€” progress is shown by the track gradient only */
        .submoment-dot.completed,
        .submoment-dot.current,
        .submoment-dot.future {
            background: var(--color-surface);
            border-color: var(--color-border-light);
        }

        .submoment-dot.current {
            border-width: 3px;
            width: 10px;
            height: 10px;
        }

        /* Tooltip pour sous-moments */
        .submoment-dot::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 4px;
            z-index: 200;
        }

        .submoment-dot:hover::after {
            opacity: 1;
        }

        [data-theme="dark"] .train-line-container {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* ===== ENHANCEMENT 5: CIRCULAR PROGRESS INDICATORS ===== */
        .circular-progress {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circular-progress-bg {
            fill: none;
            stroke: var(--color-border);
            stroke-width: 6;
        }

        .circular-progress-fill {
            fill: none;
            stroke: var(--color-primary);
            stroke-width: 6;
            stroke-linecap: round;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.6s ease;
        }

        .circular-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text);
        }

        .progress-milestone {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            transition: all var(--transition);
        }

        .progress-milestone.completed {
            background: var(--color-primary);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .progress-milestone:hover {
            transform: translateY(-50%) scale(1.2);
        }

        /* ===== ENHANCEMENT 6: TIME ESTIMATE ===== */
        .time-estimate {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--color-border-light);
            border-radius: 6px;
            width: fit-content;
        }

        .time-estimate-icon {
            width: 14px;
            height: 14px;
            color: var(--color-text-muted);
        }

        .time-estimate-text {
            font-weight: 500;
        }

        /* ===== ENHANCEMENT 7: KEYBOARD SHORTCUTS OVERLAY ===== */
        .shortcuts-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .shortcuts-modal.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .shortcuts-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        [data-theme="dark"] .shortcuts-panel {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shortcuts-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--color-border);
        }

        .shortcuts-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shortcuts-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all var(--transition);
        }

        .shortcuts-close:hover {
            background: var(--color-hover);
            color: var(--color-text);
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            transition: all var(--transition);
        }

        .shortcut-item:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .shortcut-label {
            font-size: 14px;
            color: var(--color-text);
            font-weight: 500;
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .shortcut-key {
            background: var(--color-border-light);
            color: var(--color-text-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Monaco', 'Consolas', monospace;
            border: 1px solid var(--color-border);
            min-width: 28px;
            text-align: center;
        }

        [data-theme="dark"] .shortcut-key {
            background: var(--color-hover);
        }

        /* ===== ENHANCEMENT 8: PRESENTATION MODE ===== */
        body.presentation-mode .sidebar {
            transform: translateX(-100%);
        }

        body.presentation-mode .main-content {
            margin-left: 0;
            padding-top: 0; /* train-line is invisible â€” reclaim vertical space */
        }

        body.presentation-mode .content-header {
            display: none; /* remove from flow so slide can truly centre vertically */
        }

        /* Train map hidden by user */
        body.train-line-hidden .train-line-container {
            display: none !important;
        }

        body.train-line-hidden .main-content {
            padding-top: 0;
        }

        body.presentation-mode .train-line-container {
            opacity: 0;
            pointer-events: none;
        }

        body.presentation-mode .zoom-controls,
        body.presentation-mode .timer-top-right {
            opacity: 0;
            transition: opacity var(--transition);
        }

        body.presentation-mode:hover .zoom-controls,
        body.presentation-mode:hover .timer-top-right {
            opacity: 1;
        }

        body.presentation-mode .slide-container {
            max-width: 100%;
            padding: 60px var(--pres-h-margin, 200px);
        }

        /* Margin slider section (inside slide-controls, same pattern as zoom/timer) */
        .margin-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 8px 16px;
        }

        .margin-controls .margin-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-text-secondary);
            white-space: nowrap;
            user-select: none;
        }

        #presMarginSlider {
            width: 140px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .margin-controls .margin-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text);
            min-width: 38px;
            text-align: center;
            user-select: none;
        }


        .laser-pointer-effect {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.8), rgba(255, 0, 0, 0));
            pointer-events: none;
            z-index: 9999;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }

        body.presentation-mode.laser-active .laser-pointer-effect {
            display: block;
        }

        /* Presentation mode toggle button */
        .presentation-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--color-primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            z-index: 150;
        }

        .presentation-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5);
        }

        .presentation-toggle svg {
            width: 24px;
            height: 24px;
        }

        body.presentation-mode .presentation-toggle {
            background: var(--color-warning);
        }
    </style>
</head>
<body>
    <!-- Skip Navigation Link -->
    <a href="#slideContainer" class="skip-link">Skip to main content</a>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="app.toggleSidebar()" title="Hide sidebar" aria-label="Hide navigation sidebar">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
            </div>

            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <label for="searchInput" class="visually-hidden">Search activities and slides</label>
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Search activities and slides..."
                        autocomplete="off"
                    >
                    <button class="search-clear" id="searchClear" aria-label="Clear search">Ã—</button>
                </div>
            </div>
                        <!-- Navigation Fold/Unfold -->
            <div class="nav-actions-row">
                <button class="nav-icon-text-btn" id="navFoldAllBtn" type="button" aria-pressed="false">
                    <span class="material-symbols-outlined nav-action-icon" aria-hidden="true">unfold_less</span>
                    <span class="nav-action-label">Fold all</span>
                </button>
                <button class="nav-icon-text-btn" id="toggleIgnoredBtn" type="button" aria-pressed="false" title="Show/hide ignored items">
                    <span class="material-symbols-outlined" aria-hidden="true">visibility_off</span>
                    <span>Ignored</span>
                </button>
                <button class="nav-icon-text-btn" onclick="app.showTimeline()" aria-label="Show training timeline" type="button">
                    <span class="material-symbols-outlined" aria-hidden="true">schedule</span>
                    <span>Plan</span>
                </button>
                <button class="nav-icon-text-btn" onclick="app.openAboutModal()" aria-label="About this training" type="button">
                    <span class="material-symbols-outlined" aria-hidden="true">info</span>
                    <span>info</span>
                </button>
            </div>

            <!-- Navigation Tree -->
            <nav class="nav-tree" id="navTree" aria-label="Training navigation"></nav>

            <!-- Search Results -->
            <div class="search-results" id="searchResults">
                <!-- Search History (shown when no active search) -->
                <div class="search-history" id="searchHistory" style="display: none;">
                    <div class="search-history-title">
                        Recent Searches
                        <button class="search-history-clear" id="clearSearchHistory">Clear</button>
                    </div>
                    <div class="search-history-items" id="searchHistoryItems"></div>
                </div>

                <!-- Search Filters -->
                <div class="search-filters" id="searchFilters" style="display: none;">
                    <div class="search-filters-row">
                        <button class="search-filter-btn" data-filter="all">
                            <span class="material-symbols-outlined">select_all</span>
                            All
                        </button>
                        <button class="search-filter-btn" data-filter="completed">
                            <span class="material-symbols-outlined">check_circle</span>
                            Completed
                        </button>
                        <button class="search-filter-btn" data-filter="incomplete">
                            <span class="material-symbols-outlined">radio_button_unchecked</span>
                            Incomplete
                        </button>
                    </div>
                </div>

                <!-- Results Header -->
                <div class="search-results-header" id="searchResultsHeader" style="display: none;">
                    <span class="search-results-count" id="searchResultsCount" role="status" aria-live="polite">0 results</span>
                    <button class="search-clear-filters" id="clearFiltersBtn" style="display: none;">Clear filters</button>
                </div>

                <!-- Results List -->
                <div id="searchResultsList" role="region" aria-live="polite"></div>
            </div>

            <!-- Export Button -->
            <div class="sidebar-footer">
                <div class="progress-wrapper">
                    <div class="progress-label" aria-live="polite" aria-atomic="true">
                        <span>Progress</span>
                        <span id="sidebar-progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="sidebar-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Compact Icon-Based Footer Actions -->
                <div class="footer-actions">
                    <button class="footer-icon-btn" onclick="app.toggleDarkMode()" data-tooltip="Dark Mode" aria-label="Toggle dark mode" id="darkModeToggle">
                        <span class="material-symbols-outlined" id="darkModeIcon" aria-hidden="true">dark_mode</span>
                    </button>
                    <button class="footer-icon-btn" onclick="toggleShortcutsModal()" data-tooltip="Shortcuts" aria-label="View keyboard shortcuts">
                        <span class="material-symbols-outlined" aria-hidden="true">keyboard</span>
                    </button>
                    <button class="footer-icon-btn" onclick="app.openAboutModal()" data-tooltip="About" aria-label="About this application">
                        <span class="material-symbols-outlined" aria-hidden="true">info</span>
                    </button>
                    <button class="footer-icon-btn" id="trainLineToggleBtn" onclick="app.toggleTrainLine()" data-tooltip="Train map" aria-label="Toggle train map">
                        <span class="material-symbols-outlined" aria-hidden="true">route</span>
                    </button>
                    <button class="footer-icon-btn export-action" onclick="app.openExportModal()" data-tooltip="Export" aria-label="Export data to JSON file">
                        <span class="material-symbols-outlined" aria-hidden="true">download</span>
                    </button>
                </div>
                <div class="import-status" id="importStatus" aria-live="polite"></div>

            </div>
        </aside>

        <!-- Sidebar Open Button (shown when collapsed) -->
        <button class="sidebar-open-btn" id="sidebarOpenBtn" onclick="app.toggleSidebar()" title="Show sidebar" aria-label="Show navigation sidebar">
            <span class="material-symbols-outlined">chevron_right</span>
        </button>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Right Controls Container (now empty, kept for potential future use) -->
            <div class="top-right-controls" style="display: none;">
            </div>

            <!-- Train Line Visualization -->
            <div class="train-line-container" id="trainLineContainer" style="display: none;">
                <div class="train-line-wrapper">
                    <!-- Ligne de train (rail) -->
                    <div class="train-track"></div>

                    <!-- Stations (gÃ©nÃ©rÃ©es dynamiquement par JS) -->
                    <div class="train-stations" id="trainStations"></div>
                </div>

                <!-- Version mobile compacte -->
                <div class="train-line-mobile" id="trainLineMobile">
                    <div class="mobile-progress-text">
                        <span id="mobileCurrentModule">Module 1</span>
                        <span class="mobile-progress-count" id="mobileProgressCount">1 / 5</span>
                    </div>
                    <div class="mobile-progress-track">
                        <div class="mobile-progress-fill" id="mobileProgressFill" style="width: 20%"></div>
                    </div>
                </div>
            </div>

            <!-- Content Header -->
            <div class="content-header" id="contentHeader">
                <div class="activity-context" id="activityContext" aria-label="Location"></div>
                <div class="activity-meta-row" id="activityMeta" aria-label="Activity logistics"></div>
                <h2 class="activity-title" id="activityTitle">Welcome</h2>
            </div>

            <!-- Slide Container -->
            <div class="slide-container" id="slideContainer" role="region" aria-label="Slide content" aria-live="polite">
                <div class="welcome-screen">
                    <h1 class="welcome-title">Slide Deck Platform</h1>
                    <p class="welcome-subtitle">Select your import method</p>
                    <p class="welcome-description">
                        Load your training content from a local file or directly from a GitHub repository.
                        Supports JSON format or Markdown files with slides separated by <code>---</code>.
                    </p>

                    <!-- Option 1: Local File -->
                    <div class="welcome-options-container">
                        <div class="welcome-option">
                            <div class="welcome-option-header">
                                <span class="welcome-option-number">Option 1</span>
                                <h3 class="welcome-option-title">Import from File</h3>
                            </div>
                            <p class="welcome-option-description">Upload a JSON or Markdown file from your computer</p>
                            <button class="btn btn-success welcome-cta" onclick="app.openImportDialog()" aria-label="Import JSON or Markdown file to begin training" style="background: #10B981; border-color: #10B981; width: 100%;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; margin-right: 8px;" aria-hidden="true">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Choose File
                            </button>
                        </div>

                        <div class="welcome-divider">
                            <span>or</span>
                        </div>

                        <!-- Option 2: GitHub -->
                        <div class="welcome-option">
                            <div class="welcome-option-header">
                                <span class="welcome-option-number">Option 2</span>
                                <h3 class="welcome-option-title">Load from GitHub</h3>
                            </div>
                            <p class="welcome-option-description">Paste the URL of a JSON or Markdown file hosted on GitHub</p>
                            <div class="welcome-github-input-group">
                                <input
                                    type="text"
                                    id="welcomeGithubUrlInput"
                                    class="welcome-github-input"
                                    placeholder="user/repo/branch/path/file.json or file.md"
                                    aria-label="GitHub URL for JSON or Markdown file import"
                                >
                                <button class="btn btn-primary welcome-github-btn" onclick="app.loadFromWelcomeGithub()" aria-label="Load JSON or Markdown from GitHub">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;" aria-hidden="true">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M12 6v6l4 2"></path>
                                    </svg>
                                    Load
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slide Controls -->
            <div class="slide-controls hidden" id="slideControls">
                <!-- Zoom Controls - collapses above nav bar -->
                <div class="collapsible-section" id="zoomSection">
                    <div class="section-content collapsed" id="zoomContent">
                        <div class="zoom-controls" id="zoomControls">
                            <button class="zoom-btn" id="zoomOutBtn" onclick="app.zoomOut()" title="Zoom out" aria-label="Zoom out">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    <line x1="8" y1="11" x2="14" y2="11"></line>
                                </svg>
                            </button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="zoom-btn" id="zoomInBtn" onclick="app.zoomIn()" title="Zoom in" aria-label="Zoom in">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    <line x1="11" y1="8" x2="11" y2="14"></line>
                                    <line x1="8" y1="11" x2="14" y2="11"></line>
                                </svg>
                            </button>
                            <button class="zoom-btn" id="zoomResetBtn" onclick="app.zoomReset()" title="Reset zoom" aria-label="Reset zoom to 100%">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M1 4v6h6"></path>
                                    <path d="M23 20v-6h-6"></path>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                            </button>
                            <div class="font-size-control">
                                <button class="zoom-btn" id="fontSizeDecreaseBtn" onclick="app.decreaseFontSize()" title="Decrease text size" aria-label="Decrease text size">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span class="font-size-value" id="fontSizeValue">18px</span>
                                <button class="zoom-btn" id="fontSizeIncreaseBtn" onclick="app.increaseFontSize()" title="Increase text size" aria-label="Increase text size">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                                <select class="font-size-select" id="fontSizeSelect" aria-label="Text size" style="display: none;">
                                    <option value="14">Very small (14px)</option>
                                    <option value="16">Small (16px)</option>
                                    <option value="18" selected>Medium (18px)</option>
                                    <option value="20">Large (20px)</option>
                                    <option value="22">Extra large (22px)</option>
                                    <option value="24">XXL (24px)</option>
                                    <option value="26">Huge (26px)</option>
                                    <option value="28">Max (28px)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Timer - collapses above nav bar -->
                <div class="collapsible-section" id="timerSection">
                    <div class="section-content collapsed" id="timerContent">
                        <div class="timer-top-right" id="timerTopRight">
                            <div class="timer-top-row">
                                <div class="timer-display green" role="timer" aria-live="off" aria-atomic="true">
                                    <span class="timer-elapsed" id="topTimerElapsed">00:00</span>
                                    <span class="timer-separator">/</span>
                                    <span class="timer-planned" id="topTimerPlanned">00:00</span>
                                </div>
                                <div class="timer-controls">
                                    <button class="timer-btn" id="topTimerPlayBtn" onclick="app.toggleActivityTimer()" title="Start/Pause" aria-label="Start or pause activity timer">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </button>
                                    <button class="timer-btn" id="topTimerResetBtn" onclick="app.resetActivityTimer()" title="Reset" aria-label="Reset activity timer">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="timer-progress-bar">
                                <div class="timer-progress-fill" id="topTimerProgressFill" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Margin Controls - collapses above nav bar -->
                <div class="collapsible-section" id="marginSection">
                    <div class="section-content collapsed" id="marginContent">
                        <div class="margin-controls" id="marginControls">
                            <span class="margin-label">Margins</span>
                            <input type="range" id="presMarginSlider"
                                   min="40" max="420" step="20" value="200"
                                   oninput="app.setPresentationMargin(this.value)"
                                   aria-label="Slide lateral margin">
                            <span class="margin-value" id="marginValue">200px</span>
                        </div>
                    </div>
                </div>
                <!-- Navigation Bar - Always Visible -->
                <div class="nav-bar">
                    <div class="nav-bar-left">
                        <button class="toggle-panel-btn" id="togglePanelBtn" onclick="app.toggleDetailsPanel()" aria-label="Toggle details panel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <span id="togglePanelText">Details</span>
                        </button>
                        <span class="slide-counter" id="slideCounter">Slide 1 / 1</span>
                        <!-- Zoom & Timer Toggle Controls -->
                        <div class="section-toggle-bar" style="margin: 0 0 0 auto; gap: 4px;">
                            <button class="section-toggle-btn" id="zoomToggleBtn"
                                    onclick="app.toggleSection('zoom')"
                                    title="Toggle zoom controls"
                                    aria-label="Toggle zoom controls">
                                <span class="material-symbols-outlined" aria-hidden="true">zoom_in</span>
                            </button>
                            <button class="section-toggle-btn" id="timerToggleBtn"
                                    onclick="app.toggleSection('timer')"
                                    title="Toggle timer"
                                    aria-label="Toggle timer">
                                <span class="material-symbols-outlined" aria-hidden="true">timer</span>
                            </button>
                            <button class="section-toggle-btn" id="marginToggleBtn"
                                    onclick="app.toggleSection('margin')"
                                    title="Toggle slide margins"
                                    aria-label="Toggle slide margins">
                                <span class="material-symbols-outlined" aria-hidden="true">width</span>
                            </button>
                        </div>
                    </div>
                    <div class="nav-bar-right">
                        <div class="slide-nav-buttons">
                            <button class="btn btn-secondary" id="prevSlideBtn" onclick="app.prevSlide()" aria-label="Go to previous slide">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                                Previous
                            </button>
                            <button class="btn btn-primary" id="nextSlideBtn" onclick="app.nextSlide()" aria-label="Go to next slide">
                                Next
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                            <button class="btn btn-next-section" id="nextSectionBtn" onclick="app.goToNextSection()" aria-label="Go to next section">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                    <polyline points="15 18 21 12 15 6"></polyline>
                                </svg>
                                <span id="nextSectionLabel">Next Section</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Details Panel -->
                <div class="details-panel" id="detailsPanel">
                    <div class="details-panel-content">
                        <!-- Timers Column -->
                        <div class="panel-timers">
                            <div class="section-label">Timers</div>
                            <div class="timers-row">
                                                                <!-- Activity Timer -->
                                                        <div class="timer-container activity-timer" id="activityTimer">
                                <span class="timer-label">Activity</span>
                                <div class="timer-main">
                                    <div class="timer-display green" role="timer" aria-live="off" aria-atomic="true">
                                        <span class="timer-elapsed" id="activityElapsed">00:00</span>
                                        <span class="timer-separator">/</span>
                                        <span class="timer-planned" id="activityPlanned">00:00</span>
                                    </div>
                                    <div class="timer-progress-track" aria-label="Activity time progress">
                                        <div class="timer-progress-fill green" id="activityTimeProgressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="timer-controls">
                                    <button class="timer-btn" id="activityPlayBtn" onclick="app.toggleActivityTimer()" title="Start/Pause">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </button>
                                    <button class="timer-btn" id="activityResetBtn" onclick="app.resetActivityTimer()" title="Reset">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            </div>
</div>

                        <!-- Progress Column -->
                        <div class="panel-progress">
                            <div class="section-label">Progress</div>
                            <!-- General Progress Bar -->
                            <div class="progress-bar-container general-progress-bottom" id="generalProgress">
                                <div class="progress-bar-label">
                                    <span class="progress-bar-title">Overall</span>
                                    <span class="progress-bar-percentage" id="generalProgressText">0%</span>
                                </div>
                                <div class="progress-bar-track">
                                    <div class="progress-bar-fill" id="generalProgressFill" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Activity Progress Bar -->
                            <div class="progress-bar-container activity-progress-bottom" id="activityProgressBottom">
                                <div class="progress-bar-label">
                                    <span class="progress-bar-title">Slides</span>
                                    <span class="progress-bar-percentage" id="activityProgressText">0%</span>
                                </div>
                                <div class="progress-bar-track">
                                    <div class="progress-bar-fill" id="activityProgressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden File Input for JSON/Markdown Import -->
    <input type="file" id="importFileInput" accept=".json,application/json,.md,text/markdown" style="display: none;" onchange="app.handleFileSelect(event)">

    <!-- About Modal -->
    <div class="about-modal" id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutModalTitle" onclick="if(event.target === this) app.closeAboutModal()">
        <div class="about-modal-content">
            <div class="export-modal-header">
                <h2 class="export-modal-title" id="aboutModalTitle">About This Training</h2>
                <button class="export-close-btn" onclick="app.closeAboutModal()" aria-label="Close about modal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

                        <!-- Course Overview (dynamic, from imported JSON) -->
            <div class="about-section">
                <div class="about-section-header">
                    <div class="about-section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </div>
                    <h3 class="about-section-title">Training overview</h3>
                </div>
                <div class="about-section-content">
                    <div class="about-info-row">
                        <span class="about-info-label">Title:</span>
                        <span class="about-info-value" id="aboutTitleValue">No content loaded</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Author(s):</span>
                        <span class="about-info-value" id="aboutAuthorsValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Trainer(s):</span>
                        <span class="about-info-value" id="aboutTrainersValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Level:</span>
                        <span class="about-info-value" id="aboutLevelValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Mode:</span>
                        <span class="about-info-value" id="aboutModeValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Cohort size:</span>
                        <span class="about-info-value" id="aboutCohortValue">â€“</span>
                    </div>
                    <div class="about-info-row">
    <span class="about-info-label">Target audience:</span>
    <span class="about-info-value" id="aboutAudienceValue">â€“</span>
</div>
<div class="about-info-row">
    <span class="about-info-label">Prerequisites:</span>
    <span class="about-info-value" id="aboutPrerequisitesValue">â€“</span>
</div>
<div class="about-info-row">
                        <span class="about-info-label">Learning time:</span>
                        <span class="about-info-value" id="aboutLearningTimeValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Licence:</span>
                        <span class="about-info-value" id="aboutLicenceValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Version:</span>
                        <span class="about-info-value" id="aboutVersionValue">â€“</span>
                    </div>

                    <div class="about-info-row">
                        <span class="about-info-label">Modules:</span>
                        <span class="about-info-value" id="aboutModulesValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Activities:</span>
                        <span class="about-info-value" id="aboutActivitiesValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Slides:</span>
                        <span class="about-info-value" id="aboutSlidesValue">â€“</span>
                    </div>
                    <div class="about-info-row">
                        <span class="about-info-label">Planned time:</span>
                        <span class="about-info-value" id="aboutPlannedValue">â€“</span>
                    </div>
                    <p class="about-description" id="aboutDescriptionValue" style="margin-top: 12px;">
                        Import a JSON file to populate this section.
                    </p>
                </div>
            </div>

            <!-- Structure (dynamic) -->
            <div class="about-section">
                <div class="about-section-header">
                    <div class="about-section-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <h3 class="about-section-title">Structure</h3>
                </div>
                <div class="about-section-content">
                    <div class="about-modules" id="aboutModulesList"></div>
                </div>
            </div>
            <!-- Footer -->
            <div class="export-modal-footer">
                <button class="export-cancel-btn" onclick="app.closeAboutModal()">Close</button>
            </div>
        </div>
    </div>


    <!-- Export Modal -->
    <div class="export-modal" id="exportModal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle" onclick="if(event.target === this) app.closeExportModal()">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <h2 class="export-modal-title" id="exportModalTitle">Export Content</h2>
                <button class="export-close-btn" onclick="app.closeExportModal()" aria-label="Close export">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="export-modal-body">

                <!-- Step 1: Format selection -->
                <div class="export-step" id="exportStep1">
                    <p class="export-description">
                        Choose a format to export the imported training content.
                    </p>

                    <div class="export-options">
                        <button type="button" class="export-option" onclick="app.beginExport('markdown')">
                            <div class="export-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <path d="M8 13h8"></path>
                                    <path d="M8 17h6"></path>
                                </svg>
                            </div>
                            <div class="export-option-content">
                                <div class="export-option-title">Markdown (.md)</div>
                                <div class="export-option-desc">Plain text, easy to edit and share.</div>
                            </div>
                        </button>

                        <button type="button" class="export-option" onclick="app.beginExport('rtf')">
                            <div class="export-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <path d="M8 13h8"></path>
                                    <path d="M8 17h8"></path>
                                </svg>
                            </div>
                            <div class="export-option-content">
                                <div class="export-option-title">RTF (.rtf)</div>
                                <div class="export-option-desc">Word-friendly export for document workflows.</div>
                            </div>
                        </button>

                        <button type="button" class="export-option" onclick="app.beginExport('json')">
                            <div class="export-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M20 7h-7"></path>
                                    <path d="M20 12h-7"></path>
                                    <path d="M20 17h-7"></path>
                                    <path d="M4 7h.01"></path>
                                    <path d="M4 12h.01"></path>
                                    <path d="M4 17h.01"></path>
                                </svg>
                            </div>
                            <div class="export-option-content">
                                <div class="export-option-title">JSON (.json)</div>
                                <div class="export-option-desc">Structured data for re-importing and archiving.</div>
                            </div>
                        </button>

                        <button type="button" class="export-option" onclick="app.beginExport('html')">
                            <div class="export-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <polyline points="16 18 22 12 16 6"></polyline>
                                    <polyline points="8 6 2 12 8 18"></polyline>
                                </svg>
                            </div>
                            <div class="export-option-content">
                                <div class="export-option-title">HTML (.html)</div>
                                <div class="export-option-desc">Web page for viewing in browsers.</div>
                            </div>
                        </button>

                        <button type="button" class="export-option" onclick="app.beginExport('pdf')">
                            <div class="export-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <path d="M10 12h4"></path>
                                    <path d="M10 16h4"></path>
                                    <path d="M10 8h1"></path>
                                </svg>
                            </div>
                            <div class="export-option-content">
                                <div class="export-option-title">PDF (.pdf)</div>
                                <div class="export-option-desc">Print-ready document via browser print dialog.</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Module selection -->
                <div class="export-step export-step--hidden" id="exportStep2"
                     role="group" aria-labelledby="exportModuleStepLabel">
                    <p class="export-description" id="exportModuleStepLabel">
                        Select which modules to include in the export.
                    </p>
                    <div class="export-select-all-row">
                        <button type="button" class="export-select-all-btn" id="exportSelectAllBtn"
                                onclick="app.toggleSelectAllModules()">Select all</button>
                        <span class="export-module-count" id="exportModuleCount">0 of 0 selected</span>
                    </div>
                    <div class="export-module-list" id="exportModuleList" role="list"></div>
                </div>

            </div>

            <div class="export-modal-footer">
                <button class="export-back-btn export-back-btn--hidden" id="exportBackBtn"
                        onclick="app.goToExportStep(1)">Back</button>
                <div style="flex:1"></div>
                <button class="export-cancel-btn" onclick="app.closeExportModal()">Cancel</button>
                <button class="export-confirm-btn export-confirm-btn--hidden" id="exportConfirmBtn"
                        onclick="app.confirmExport()" disabled>Export</button>
            </div>
        </div>
    </div>


    <script>
        // ===== DATA STRUCTURE =====
        // Course data is now loaded dynamically via JSON import
        // (Removed broken syntax here)

        // ===== APPLICATION STATE =====
        const app = window.app = {
            // Course data - starts empty, populated via import
            courseData: null,
            
            currentActivity: null,
            currentSlideIndex: 0,
            searchQuery: '',
            expandedNodes: new Set(),
navAllFolded: false,
showIgnored: false,
            // Timer state
            activityTimer: {
                elapsed: 0,
                planned: 0,
                running: false,
                interval: null,
                activityId: null
            },

            // Store timer interval reference for cleanup
            timerIntervalId: null,

            // Progress tracking
            completedActivities: new Set(),
            visitedActivities: new Set(),
            visitedSlides: new Set(),

            // Zoom state
            zoomLevel: 100,
            slideFontSize: 18,
            zoomMin: 80,
            zoomMax: 200,
            zoomStep: 20,

            // Details panel state
            detailsPanelExpanded: false,

            // Sections collapse state
            sectionsCollapsed: {
                zoom: true,      // collapsed by default
                timer: true,     // collapsed by default
                margin: true     // collapsed by default
            },

            // Export flow state
            exportPendingFormat: null,
            exportSelectedModuleIds: new Set(),

            // Train line visualization
            trainLine: {
                container: null,
                stationsContainer: null,
                initialized: false,

                init() {
                    if (this.initialized) return;

                    this.container = document.getElementById('trainLineContainer');
                    this.stationsContainer = document.getElementById('trainStations');

                    if (!this.container || !this.stationsContainer) {
                        console.error('Train line elements not found');
                        return;
                    }

                    this.initialized = true;
                },

                build() {
                    if (!this.stationsContainer || !app.courseData) return;

                    this.stationsContainer.innerHTML = '';

                    const modules = app.courseData.modules || [];

                    if (modules.length === 0) {
                        this.container.style.display = 'none';
                        return;
                    }

                    this.container.style.display = 'block';

                    const totalModules = modules.length;

                    modules.forEach((module, moduleIndex) => {
                        // CrÃ©er et positionner les segments de moments (en premier, z-index le plus bas)
                        const momentSegments = this.createMomentSegments(module, moduleIndex, totalModules);
                        momentSegments.forEach(segment => this.stationsContainer.appendChild(segment));

                        // CrÃ©er et positionner les points de sous-moments
                        const submomentDots = this.createSubmomentDots(module, moduleIndex, totalModules);
                        submomentDots.forEach(dot => this.stationsContainer.appendChild(dot));

                        // CrÃ©er et positionner la station du module (en dernier, z-index le plus Ã©levÃ©)
                        const station = this.createStation(module, moduleIndex, totalModules);
                        this.stationsContainer.appendChild(station);
                    });

                    this.update();
                },

                createStation(module, moduleIndex, totalModules) {
                    const stationDiv = document.createElement('div');
                    stationDiv.className = 'train-station';
                    stationDiv.setAttribute('data-module-index', moduleIndex);
                    stationDiv.setAttribute('data-module-id', module.id);
                    stationDiv.setAttribute('role', 'button');
                    stationDiv.setAttribute('tabindex', '0');
                    stationDiv.setAttribute('aria-label', `Module ${moduleIndex + 1}: ${module.title}`);

                    // Position absolue : rÃ©partir Ã©quitablement sur la largeur
                    const positionPercent = totalModules > 1
                        ? (moduleIndex / (totalModules - 1)) * 100
                        : 50;
                    stationDiv.style.left = `${positionPercent}%`;

                    const marker = document.createElement('div');
                    marker.className = 'station-marker future';

                    const number = document.createElement('div');
                    number.className = 'station-number';
                    number.textContent = moduleIndex + 1;

                    marker.appendChild(number);

                    const label = document.createElement('div');
                    label.className = 'station-label';
                    label.textContent = module.title;
                    label.title = module.title;

                    stationDiv.appendChild(marker);
                    stationDiv.appendChild(label);

                    stationDiv.addEventListener('click', () => this.navigateToModule(moduleIndex));
                    stationDiv.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.navigateToModule(moduleIndex);
                        }
                    });

                    return stationDiv;
                },

                createSubmomentDots(module, moduleIndex, totalModules) {
                    const dots = [];

                    if (!module.moments || !Array.isArray(module.moments)) {
                        return dots;
                    }

                    // Compter tous les sous-moments dans ce module
                    let allSubmoments = [];
                    module.moments.forEach((moment, momentIndex) => {
                        if (moment.ignored === true) return;
                        if (moment.submoments && Array.isArray(moment.submoments)) {
                            moment.submoments.forEach((submoment, submomentIndex) => {
                                if (submoment.ignored === true) return;
                                allSubmoments.push({
                                    moment,
                                    momentIndex,
                                    submoment,
                                    submomentIndex
                                });
                            });
                        }
                    });

                    if (allSubmoments.length === 0) {
                        return dots;
                    }

                    // Calculer l'espace entre ce module et le suivant
                    const moduleStartPercent = totalModules > 1
                        ? (moduleIndex / (totalModules - 1)) * 100
                        : 50;
                    const moduleEndPercent = totalModules > 1 && moduleIndex < totalModules - 1
                        ? ((moduleIndex + 1) / (totalModules - 1)) * 100
                        : 100;
                    const moduleSpan = moduleEndPercent - moduleStartPercent;

                    // RÃ©partir les sous-moments dans cet espace
                    allSubmoments.forEach((item, index) => {
                        const dot = document.createElement('div');
                        dot.className = 'submoment-dot future';
                        dot.setAttribute('data-module-index', moduleIndex);
                        dot.setAttribute('data-moment-index', item.momentIndex);
                        dot.setAttribute('data-submoment-index', item.submomentIndex);
                        dot.setAttribute('data-title', item.submoment.title);
                        dot.setAttribute('role', 'button');
                        dot.setAttribute('tabindex', '0');

                        // Position : rÃ©partir entre moduleStart et moduleEnd
                        const dotPositionInModule = (index + 1) / (allSubmoments.length + 1);
                        const dotPositionPercent = moduleStartPercent + (dotPositionInModule * moduleSpan);
                        dot.style.left = `${dotPositionPercent}%`;

                        // Navigation au clic
                        dot.addEventListener('click', () => this.navigateToSubmoment(moduleIndex, item.momentIndex, item.submomentIndex));
                        dot.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                this.navigateToSubmoment(moduleIndex, item.momentIndex, item.submomentIndex);
                            }
                        });

                        dots.push(dot);
                    });

                    return dots;
                },

                createMomentSegments(module, moduleIndex, totalModules) {
                    const segments = [];

                    if (!module.moments || !Array.isArray(module.moments)) {
                        return segments;
                    }

                    // Filtrer les moments non-ignorÃ©s
                    const validMoments = module.moments.filter(m => m.ignored !== true);
                    if (validMoments.length === 0) {
                        return segments;
                    }

                    // Calculer l'espace entre ce module et le suivant
                    const moduleStartPercent = totalModules > 1
                        ? (moduleIndex / (totalModules - 1)) * 100
                        : 0;
                    const moduleEndPercent = totalModules > 1 && moduleIndex < totalModules - 1
                        ? ((moduleIndex + 1) / (totalModules - 1)) * 100
                        : 100;
                    const moduleSpan = moduleEndPercent - moduleStartPercent;

                    // CrÃ©er un segment pour chaque moment
                    validMoments.forEach((moment, validIndex) => {
                        const segment = document.createElement('div');
                        segment.className = 'moment-segment future';

                        // Trouver l'index original du moment dans le tableau complet
                        const momentIndex = module.moments.indexOf(moment);

                        segment.setAttribute('data-module-index', moduleIndex);
                        segment.setAttribute('data-moment-index', momentIndex);
                        segment.setAttribute('data-title', `${moment.title}`);
                        segment.setAttribute('role', 'button');
                        segment.setAttribute('tabindex', '0');

                        // Calculer position et largeur du segment
                        const segmentStartInModule = validIndex / validMoments.length;
                        const segmentWidth = 1 / validMoments.length;

                        const segmentStartPercent = moduleStartPercent + (segmentStartInModule * moduleSpan);
                        const segmentEndPercent = moduleStartPercent + ((segmentStartInModule + segmentWidth) * moduleSpan);

                        segment.style.left = `${segmentStartPercent}%`;
                        segment.style.width = `${segmentEndPercent - segmentStartPercent}%`;

                        // Navigation au clic - aller au premier sous-moment du moment
                        segment.addEventListener('click', () => {
                            if (moment.submoments && moment.submoments.length > 0) {
                                const firstSubmoment = moment.submoments.find(sm => sm.ignored !== true);
                                if (firstSubmoment) {
                                    const submomentIndex = moment.submoments.indexOf(firstSubmoment);
                                    this.navigateToSubmoment(moduleIndex, momentIndex, submomentIndex);
                                }
                            }
                        });

                        segment.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                if (moment.submoments && moment.submoments.length > 0) {
                                    const firstSubmoment = moment.submoments.find(sm => sm.ignored !== true);
                                    if (firstSubmoment) {
                                        const submomentIndex = moment.submoments.indexOf(firstSubmoment);
                                        this.navigateToSubmoment(moduleIndex, momentIndex, submomentIndex);
                                    }
                                }
                            }
                        });

                        segments.push(segment);
                    });

                    return segments;
                },

                navigateToSubmoment(moduleIndex, momentIndex, submomentIndex) {
                    if (!app.courseData || !app.courseData.modules[moduleIndex]) return;

                    const module = app.courseData.modules[moduleIndex];
                    const moment = module.moments && module.moments[momentIndex];
                    const submoment = moment && moment.submoments && moment.submoments[submomentIndex];

                    if (!submoment || !submoment.activities || submoment.activities.length === 0) {
                        console.warn('No activities in submoment', moduleIndex, momentIndex, submomentIndex);
                        return;
                    }

                    // Naviguer vers la premiÃ¨re activitÃ© du sous-moment (exclure title slides)
                    const firstActivity = submoment.activities.find(act => !act.isTitleSlide) || submoment.activities[0];
                    app.loadActivity(firstActivity);
                },

                getCurrentPositionInfo() {
                    if (!app.currentActivity || !app.courseData) return null;

                    const modules = app.courseData.modules;

                    // Trouver dans quel module/moment/sous-moment se trouve l'activitÃ© actuelle
                    for (let modIdx = 0; modIdx < modules.length; modIdx++) {
                        const module = modules[modIdx];

                        // Chercher dans les moments/sous-moments
                        if (module.moments && Array.isArray(module.moments)) {
                            for (let momIdx = 0; momIdx < module.moments.length; momIdx++) {
                                const moment = module.moments[momIdx];
                                if (moment.ignored === true) continue;

                                if (moment.submoments && Array.isArray(moment.submoments)) {
                                    for (let subIdx = 0; subIdx < moment.submoments.length; subIdx++) {
                                        const submoment = moment.submoments[subIdx];
                                        if (submoment.ignored === true) continue;

                                        if (submoment.activities && Array.isArray(submoment.activities)) {
                                            const activityIndex = submoment.activities.findIndex(act =>
                                                act.id === app.currentActivity.id
                                            );

                                            if (activityIndex !== -1) {
                                                // Found â€” compute progress based on current position,
                                                // not on completed count, so the bar never jumps ahead.
                                                const moduleActivities = this.getAllActivitiesInModule(module);
                                                const currentActivityInModule = moduleActivities.findIndex(
                                                    act => act.id === app.currentActivity.id
                                                );
                                                const totalSlides = (app.currentActivity.slides && app.currentActivity.slides.length) || 1;
                                                const slidesFraction = app.currentSlideIndex / totalSlides;
                                                // progress = (activities before current + fractional position within current) / total
                                                const moduleProgress = moduleActivities.length > 0
                                                    ? ((currentActivityInModule + slidesFraction) / moduleActivities.length) * 100
                                                    : 0;

                                                return {
                                                    moduleIndex: modIdx,
                                                    momentIndex: momIdx,
                                                    submomentIndex: subIdx,
                                                    moduleProgress
                                                };
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    return null;
                },

                update() {
                    if (!app.currentActivity || !app.courseData) return;

                    const currentInfo = this.getCurrentPositionInfo();

                    if (!currentInfo) {
                        console.warn('Could not determine current position');
                        return;
                    }

                    const { moduleIndex, momentIndex, submomentIndex, moduleProgress } = currentInfo;
                    const totalModules = app.courseData.modules.length;

                    // Mettre Ã  jour les stations de modules
                    const stations = this.stationsContainer.querySelectorAll('.train-station');
                    stations.forEach((station, index) => {
                        const marker = station.querySelector('.station-marker');

                        marker.classList.remove('completed', 'current', 'future');
                        station.classList.remove('current');

                        if (index < moduleIndex) {
                            marker.classList.add('completed');
                        } else if (index === moduleIndex) {
                            marker.classList.add('current');
                            station.classList.add('current');
                        } else {
                            marker.classList.add('future');
                        }
                    });

                    // Mettre Ã  jour les segments de moments
                    const segments = this.stationsContainer.querySelectorAll('.moment-segment');
                    segments.forEach(segment => {
                        const segmentModuleIndex = parseInt(segment.getAttribute('data-module-index'));
                        const segmentMomentIndex = parseInt(segment.getAttribute('data-moment-index'));

                        segment.classList.remove('completed', 'current', 'future');

                        if (segmentModuleIndex < moduleIndex) {
                            // Moment dans un module dÃ©jÃ  complÃ©tÃ©
                            segment.classList.add('completed');
                        } else if (segmentModuleIndex === moduleIndex && segmentMomentIndex < momentIndex) {
                            // Moment dans le module actuel mais prÃ©cÃ©dent
                            segment.classList.add('completed');
                        } else if (segmentModuleIndex === moduleIndex && segmentMomentIndex === momentIndex) {
                            // Moment actuel
                            segment.classList.add('current');
                        } else {
                            // Moment futur
                            segment.classList.add('future');
                        }
                    });

                    // Mettre Ã  jour les points de sous-moments
                    const dots = this.stationsContainer.querySelectorAll('.submoment-dot');
                    dots.forEach(dot => {
                        const dotModuleIndex = parseInt(dot.getAttribute('data-module-index'));
                        const dotMomentIndex = parseInt(dot.getAttribute('data-moment-index'));
                        const dotSubmomentIndex = parseInt(dot.getAttribute('data-submoment-index'));

                        dot.classList.remove('completed', 'current', 'future');

                        if (dotModuleIndex < moduleIndex) {
                            // Sous-moment dans un module dÃ©jÃ  complÃ©tÃ©
                            dot.classList.add('completed');
                        } else if (dotModuleIndex === moduleIndex && dotMomentIndex < momentIndex) {
                            // Sous-moment dans le module actuel mais moment prÃ©cÃ©dent
                            dot.classList.add('completed');
                        } else if (dotModuleIndex === moduleIndex && dotMomentIndex === momentIndex && dotSubmomentIndex < submomentIndex) {
                            // Sous-moment dans le moment actuel mais prÃ©cÃ©dent
                            dot.classList.add('completed');
                        } else if (dotModuleIndex === moduleIndex && dotMomentIndex === momentIndex && dotSubmomentIndex === submomentIndex) {
                            // Sous-moment actuel
                            dot.classList.add('current');
                        } else {
                            // Sous-moment futur
                            dot.classList.add('future');
                        }
                    });

                    this.updateTrackProgress(moduleIndex, moduleProgress, totalModules);
                    this.updateMobile(moduleIndex, moduleProgress, totalModules);
                },

                getAllActivitiesInModule(module) {
                    const activities = [];

                    if (module.activities && Array.isArray(module.activities)) {
                        activities.push(...module.activities.filter(act => !act.isTitleSlide && act.ignored !== true));
                    }

                    if (module.moments && Array.isArray(module.moments)) {
                        module.moments.forEach(moment => {
                            if (moment.ignored === true) return;
                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                moment.submoments.forEach(submoment => {
                                    if (submoment.ignored === true) return;
                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        activities.push(...submoment.activities.filter(act => !act.isTitleSlide && act.ignored !== true));
                                    }
                                });
                            }
                        });
                    }

                    return activities;
                },

                updateTrackProgress(moduleIndex, moduleProgress, totalModules) {
                    if (!this.container || totalModules === 0) return;

                    // Derive progress purely from position in the ordered flat activity
                    // list (getAllActivitiesInOrder). This is the exact same list used
                    // for prev/next navigation, so it includes title slides and respects
                    // ignored items â€” guaranteeing the blue tip tracks the current slide.

                    const allActivities = app.getAllActivitiesInOrder();
                    if (allActivities.length === 0) return;

                    const currentId = app.currentActivity && app.currentActivity.id;
                    const globalIndex = allActivities.findIndex(a => a.id === currentId);
                    if (globalIndex === -1) return;

                    // Build module boundaries by scanning the ordered list once (O(N)).
                    // Each module starts with its "module-title-<id>" activity.
                    const modules = app.courseData.modules;
                    const moduleIds = new Set(modules.map(m => m.id));
                    const moduleBoundaries = []; // [{start, end}] inclusive/exclusive global indices
                    let currentModuleStart = 0;
                    let currentModuleIdIndex = -1;

                    allActivities.forEach((a, i) => {
                        // Detect a new module title slide
                        if (a.isTitleSlide && a.titleType === 'module') {
                            if (currentModuleIdIndex >= 0) {
                                // Close the previous module
                                moduleBoundaries.push({ start: currentModuleStart, end: i });
                            }
                            currentModuleStart = i;
                            currentModuleIdIndex++;
                        }
                    });
                    // Close the last module
                    if (currentModuleIdIndex >= 0) {
                        moduleBoundaries.push({ start: currentModuleStart, end: allActivities.length });
                    }

                    // Fallback: if no module title slides found, treat whole list as one module
                    if (moduleBoundaries.length === 0) {
                        moduleBoundaries.push({ start: 0, end: allActivities.length });
                    }

                    // Find which module the current activity belongs to
                    const mIdx = moduleBoundaries.findIndex(b => globalIndex >= b.start && globalIndex < b.end);
                    const resolvedModuleIndex = mIdx !== -1 ? mIdx : moduleBoundaries.length - 1;
                    const boundary = moduleBoundaries[resolvedModuleIndex];

                    // Position within this module's slice (0â€“1), including slide fraction
                    const posInModule = globalIndex - boundary.start;
                    const moduleSize = boundary.end - boundary.start;
                    const totalSlides = (app.currentActivity.slides && app.currentActivity.slides.length) || 1;
                    const slideFraction = app.currentSlideIndex / totalSlides;
                    const withinModule = moduleSize > 0 ? (posInModule + slideFraction) / moduleSize : 0;

                    // Map onto station coordinate space.
                    // Station i is at: i / (totalModules - 1) * 100%
                    // So the segment for module i spans from i/(N-1) to (i+1)/(N-1).
                    let progressPercent;
                    if (totalModules === 1) {
                        progressPercent = withinModule * 100;
                    } else {
                        const stationSpan = 1 / (totalModules - 1);
                        progressPercent = (resolvedModuleIndex * stationSpan + withinModule * stationSpan) * 100;
                    }

                    this.container.style.setProperty('--train-progress', `${Math.min(100, Math.max(0, progressPercent))}%`);
                },

                updateMobile(moduleIndex, moduleProgress, totalModules) {
                    const mobileCurrentModule = document.getElementById('mobileCurrentModule');
                    const mobileProgressCount = document.getElementById('mobileProgressCount');
                    const mobileProgressFill = document.getElementById('mobileProgressFill');

                    if (!mobileCurrentModule || !mobileProgressCount || !mobileProgressFill) return;

                    if (app.courseData && app.courseData.modules[moduleIndex]) {
                        mobileCurrentModule.textContent = app.courseData.modules[moduleIndex].title;
                    }

                    mobileProgressCount.textContent = `${moduleIndex + 1} / ${totalModules}`;

                    const overallProgress = (moduleIndex + (moduleProgress / 100)) / totalModules;
                    mobileProgressFill.style.width = `${overallProgress * 100}%`;
                },

                navigateToModule(moduleIndex) {
                    if (!app.courseData || !app.courseData.modules[moduleIndex]) return;

                    const module = app.courseData.modules[moduleIndex];
                    let firstActivity = null;

                    if (module.activities && module.activities.length > 0) {
                        firstActivity = module.activities.find(act => !act.isTitleSlide) || module.activities[0];
                    }

                    if (!firstActivity && module.moments && module.moments.length > 0) {
                        const firstMoment = module.moments[0];
                        if (firstMoment.submoments && firstMoment.submoments.length > 0) {
                            const firstSubmoment = firstMoment.submoments[0];
                            if (firstSubmoment.activities && firstSubmoment.activities.length > 0) {
                                firstActivity = firstSubmoment.activities.find(act => !act.isTitleSlide)
                                    || firstSubmoment.activities[0];
                            }
                        }
                    }

                    if (firstActivity) {
                        app.loadActivity(firstActivity);
                    } else {
                        console.warn('No activities found in module', moduleIndex);
                    }
                },

                hide() {
                    if (this.container) {
                        this.container.style.display = 'none';
                    }
                },

                show() {
                    if (this.container) {
                        this.container.style.display = 'block';
                    }
                }
            },

            init() {
                console.log('App initializing...');
                console.log('App object:', this);

                this.buildNavigation();
                this.attachEventListeners();
                this.loadNavFoldAllState();
                this.loadIgnoredState();
                this.loadStateFromHash();
                this.loadLastPosition();
                this.loadTimerState();
                // Seen-state markers removed (no persistent "visited/completed" ticks)
                this.clearSeenState();
                this.loadThemePreference();
                this.loadSidebarState();
                this.loadFontSizePreference();
                this.loadZoomPreference();
                this.loadSectionState();
                this.loadDetailsPanelState();
                this.initPresentationMargin();
                this.loadTrainLineVisibility();
                this.startTimerTicks();
                this.initSearchHandlers(); // Initialize enhanced search

                // Initialize train line
                this.trainLine.init();

                console.log('App initialized successfully');
                console.log('courseData:', this.courseData);
            },

            clearSeenState() {
                // Remove legacy persisted "seen" state keys (green ticks system removed)
                this.completedActivities = new Set();
                this.visitedActivities = new Set();
                this.visitedSlides = new Set();
                try {
                    localStorage.removeItem('completedActivities');
                    localStorage.removeItem('visitedActivities');
                    localStorage.removeItem('visitedSlides');
                
                    localStorage.removeItem('navCollapsed');} catch (e) {}
            },

// ===== NAV FOLD/UNFOLD ALL =====
toggleNavFoldAll() {
    this.navAllFolded = !this.navAllFolded;
    this.applyNavFoldAllState(true);
},

applyNavFoldAllState(persist) {
    const navTree = document.getElementById('navTree');
    const btn = document.getElementById('navFoldAllBtn');

    if (navTree) {
        // Find all nav-children and expand icons
        const allChildren = navTree.querySelectorAll('.nav-children');
        const allIcons = navTree.querySelectorAll('.nav-expand-icon');

        if (this.navAllFolded) {
            // Collapse all sections
            allChildren.forEach(child => {
                child.style.display = 'none';
            });
            allIcons.forEach(icon => {
                icon.classList.remove('expanded');
            });
        } else {
            // Expand all sections
            allChildren.forEach(child => {
                child.style.display = 'block';
            });
            allIcons.forEach(icon => {
                icon.classList.add('expanded');
            });
        }
    }

    if (btn) {
        btn.setAttribute('aria-pressed', this.navAllFolded ? 'true' : 'false');
        const labelEl = btn.querySelector('.nav-action-label');
        const iconEl = btn.querySelector('.nav-action-icon');
        if (labelEl) labelEl.textContent = this.navAllFolded ? 'Unfold all' : 'Fold all';
        if (iconEl) iconEl.textContent = this.navAllFolded ? 'unfold_more' : 'unfold_less';
    }

    if (persist) {
        this.safeLocalStorageSet('navAllFolded', this.navAllFolded ? '1' : '0');
    }
},

loadNavFoldAllState() {
    const saved = this.safeLocalStorageGet('navAllFolded');
    this.navAllFolded = (saved === '1');
    this.updateNavFoldAllAvailability();
    this.applyNavFoldAllState(false);
},

updateNavFoldAllAvailability() {
    const btn = document.getElementById('navFoldAllBtn');
    if (!btn) return;

    const hasContent = !!(this.courseData && Array.isArray(this.courseData.modules) && this.courseData.modules.length > 0);
    btn.disabled = !hasContent;
    btn.setAttribute('aria-disabled', (!hasContent).toString());
},

// ===== TOGGLE IGNORED ITEMS =====
toggleIgnored() {
    this.showIgnored = !this.showIgnored;
    console.log('Toggle ignored items:', this.showIgnored);
    this.applyIgnoredState(true);
},

applyIgnoredState(persist) {
    const btn = document.getElementById('toggleIgnoredBtn');

    if (this.showIgnored) {
        document.body.classList.add('show-ignored');
        console.log('Added show-ignored class to body');
    } else {
        document.body.classList.remove('show-ignored');
        console.log('Removed show-ignored class from body');
    }

    if (btn) {
        btn.setAttribute('aria-pressed', this.showIgnored ? 'true' : 'false');
        const iconEl = btn.querySelector('.material-symbols-outlined');
        if (iconEl) {
            iconEl.textContent = this.showIgnored ? 'visibility' : 'visibility_off';
        }
    }

    if (persist) {
        this.safeLocalStorageSet('showIgnored', this.showIgnored ? '1' : '0');
    }

    // Log ignored elements for debugging
    const ignoredElements = document.querySelectorAll('.nav-moment.ignored, .nav-submoment.ignored, .nav-activity.ignored');
    console.log('Found', ignoredElements.length, 'ignored elements');
},

loadIgnoredState() {
    const saved = this.safeLocalStorageGet('showIgnored');
    this.showIgnored = (saved === '1');
    this.applyIgnoredState(false);
},

            buildNavigation() {

                const navTree = document.getElementById('navTree');
                navTree.innerHTML = '';

                if (!this.courseData || !this.courseData.modules) {
                    navTree.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-text-muted);">No content loaded. Please import a JSON or Markdown file.</div>';
                    return;
                }

                this.courseData.modules.forEach((module, moduleIndex) => {
                    const moduleEl = this.createModuleElement(module, moduleIndex);
                    navTree.appendChild(moduleEl);
                });

                this.updateNavFoldAllAvailability();

                this.applyNavFoldAllState(false);

                // Apply visual state after building navigation
                this.updateCompletedActivitiesInNav();
                this.updateActiveNav();

                // Build train line
                if (this.trainLine && this.trainLine.initialized) {
                    this.trainLine.build();
                }
            },

            createModuleElement(module, moduleIndex) {
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'nav-module';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'nav-module-header';
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = `${moduleIndex + 1}. ${module.title}`;
                titleSpan.style.flex = '1';
                headerDiv.appendChild(titleSpan);
                moduleDiv.appendChild(headerDiv);

                // Render moments if they exist
                (module.moments || []).forEach((moment, momentIndex) => {
                    const momentEl = this.createMomentElement(moment, moduleIndex, momentIndex);
                    moduleDiv.appendChild(momentEl);
                });

                // Render module-level activities if they exist (without moments/submoments)
                if (module.activities && Array.isArray(module.activities) && module.activities.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'nav-children';

                    module.activities.forEach((activity, activityIndex) => {
                        const activityEl = this.createActivityElement(activity, moduleIndex, -1, -1, activityIndex);
                        childrenDiv.appendChild(activityEl);
                    });

                    moduleDiv.appendChild(childrenDiv);
                }

                return moduleDiv;
            },

            createMomentElement(moment, moduleIndex, momentIndex) {
    const momentDiv = document.createElement('div');
    momentDiv.className = 'nav-moment';

    // Add ignored class if moment is marked as ignored
    if (moment.ignored === true) {
        momentDiv.classList.add('ignored');
    }

    const headerDiv = document.createElement('div');
    headerDiv.className = 'nav-item-header nav-moment-header';
    headerDiv.innerHTML = `
        <svg class="nav-expand-icon expanded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
        <span class="nav-item-title">${moduleIndex + 1}.${momentIndex + 1} ${this.sanitizeHTML(String(moment.title || ''))}</span>
    `;
    const childrenDiv = document.createElement('div');
    childrenDiv.className = 'nav-children';

    (moment.submoments || []).forEach((submoment, submomentIndex) => {
        const submomentEl = this.createSubmomentElement(submoment, moduleIndex, momentIndex, submomentIndex);
        childrenDiv.appendChild(submomentEl);
    });

    // Add click handler to toggle expand/collapse
    headerDiv.style.cursor = 'pointer';
    headerDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        const icon = headerDiv.querySelector('.nav-expand-icon');
        const isExpanded = icon.classList.contains('expanded');

        if (isExpanded) {
            icon.classList.remove('expanded');
            childrenDiv.style.display = 'none';
        } else {
            icon.classList.add('expanded');
            childrenDiv.style.display = 'block';
        }
    });

    momentDiv.appendChild(headerDiv);
    momentDiv.appendChild(childrenDiv);

    return momentDiv;
},

            createSubmomentElement(submoment, moduleIndex, momentIndex, submomentIndex) {
    const submomentDiv = document.createElement('div');
    submomentDiv.className = 'nav-submoment';

    // Add ignored class if submoment is marked as ignored
    if (submoment.ignored === true) {
        submomentDiv.classList.add('ignored');
    }

    const headerDiv = document.createElement('div');
    headerDiv.className = 'nav-item-header nav-submoment-header';
    headerDiv.innerHTML = `
        <svg class="nav-expand-icon expanded" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
        <span class="nav-item-title">${moduleIndex + 1}.${momentIndex + 1}.${submomentIndex + 1} ${this.sanitizeHTML(String(submoment.title || ''))}</span>
    `;
    const childrenDiv = document.createElement('div');
    childrenDiv.className = 'nav-children';

    (submoment.activities || []).forEach((activity, activityIndex) => {
        const activityEl = this.createActivityElement(activity, moduleIndex, momentIndex, submomentIndex, activityIndex);
        childrenDiv.appendChild(activityEl);
    });

    // Add click handler to toggle expand/collapse
    headerDiv.style.cursor = 'pointer';
    headerDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        const icon = headerDiv.querySelector('.nav-expand-icon');
        const isExpanded = icon.classList.contains('expanded');

        if (isExpanded) {
            icon.classList.remove('expanded');
            childrenDiv.style.display = 'none';
        } else {
            icon.classList.add('expanded');
            childrenDiv.style.display = 'block';
        }
    });

    submomentDiv.appendChild(headerDiv);
    submomentDiv.appendChild(childrenDiv);

    return submomentDiv;
},

            createActivityElement(activity, moduleIndex, momentIndex, submomentIndex, activityIndex) {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'nav-activity';
                activityDiv.setAttribute('role', 'button');
                activityDiv.setAttribute('tabindex', '0');
                activityDiv.dataset.activityId = activity.id;

                // Add ignored class if activity is marked as ignored
                if (activity.ignored === true) {
                    activityDiv.classList.add('ignored');
                }

                const slideCount = (activity.slides && activity.slides.length) ? activity.slides.length : 0;

                // Generate label based on whether it's a module-level activity or nested
                let labelText;
                if (momentIndex === -1 && submomentIndex === -1) {
                    // Module-level activity (no moment or submoment)
                    labelText = `${moduleIndex + 1}.${activityIndex + 1} ${this.sanitizeHTML(String(activity.title || ''))}`;
                } else {
                    // Nested activity within moment and submoment
                    labelText = `${moduleIndex + 1}.${momentIndex + 1}.${submomentIndex + 1}.${activityIndex + 1} ${this.sanitizeHTML(String(activity.title || ''))}`;
                }

                activityDiv.innerHTML = `
                    <span class="nav-activity-label">${labelText}</span>
                    <span class="slide-count">${slideCount} slide${slideCount !== 1 ? 's' : ''}</span>
                `;

                return activityDiv;
            },
            loadActivity(activity) {
                this.loadActivityAtSlide(activity, 0);

                // Update train line
                if (this.trainLine && this.trainLine.initialized) {
                    this.trainLine.update();
                }
            },

            loadActivityAtSlide(activity, slideIndex) {
                if (!activity || !activity.slides || activity.slides.length === 0) return;

                this.currentActivity = activity;
                const idx = Math.max(
                    0,
                    Math.min((typeof slideIndex === 'number' ? slideIndex : 0), activity.slides.length - 1)
                );
                this.currentSlideIndex = idx;
                this.updateActivityHeader();
                this.renderSlide();
                this.updateActiveNav();
                this.updateNextSectionButton();
                this.closeMobileMenu();
                this.updateHash();

                // Load timers
                this.loadActivityTimer(activity.id);

                // Show and update general progress
                this.showGeneralProgress();

                // Show slide controls and progress
                document.getElementById('slideControls').classList.remove('hidden');

                // Show zoom controls and apply current zoom
                this.showZoomControls();
                setTimeout(() => this.applyZoom(), 100);

                // Initialize activity progress
                this.updateActivityProgress();

                // Save progress
            },

            updateActivityHeader() {
                const activity = this.currentActivity;
                const context = this.getActivityContext(activity.id);

                document.getElementById('activityTitle').textContent = activity.title;

                const contextEl = document.getElementById('activityContext');
                if (!contextEl) return;

                if (!context.module) {
                    contextEl.innerHTML = '';
                    return;
                }

                const escape = (s) => {
                    const d = document.createElement('div');
                    d.textContent = s;
                    return d.innerHTML;
                };

                const sep = `<span class="activity-context-separator" aria-hidden="true">â€º</span>`;
                let html = `<span class="activity-context-chip chip-module" title="${escape(context.module)}">${escape(context.module)}</span>`;
                if (context.moment) {
                    html += sep + `<span class="activity-context-chip" title="${escape(context.moment)}">${escape(context.moment)}</span>`;
                }
                if (context.submoment) {
                    html += sep + `<span class="activity-context-chip" title="${escape(context.submoment)}">${escape(context.submoment)}</span>`;
                }
                contextEl.innerHTML = html;

                // Metadata chips (logistics)
                const metaEl = document.getElementById('activityMeta');
                if (metaEl) {
                    const a = activity;
                    const isTitleSlide = a && a.isTitleSlide;
                    const chips = [];
                    if (!isTitleSlide && a) {
                        if (a.plannedMinutes) chips.push({ icon: 'timer',        label: `${a.plannedMinutes} min` });
                        if (a.groupSize)      chips.push({ icon: 'group',        label: a.groupSize });
                        if (a.place)          chips.push({ icon: 'location_on',  label: a.place });
                        if (a.trainer)        chips.push({ icon: 'person',       label: a.trainer });
                        if (a.evaluation && a.evaluation !== 'Aucune')
                                              chips.push({ icon: 'check_circle', label: a.evaluation });
                    }
                    metaEl.innerHTML = chips.map(c =>
                        `<span class="activity-meta-chip">` +
                        `<span class="material-symbols-outlined" aria-hidden="true">${c.icon}</span>` +
                        `${escape(String(c.label))}` +
                        `</span>`
                    ).join('');
                }
            },

            getActivityContext(activityId) {
                if (!this.courseData || !this.courseData.modules) return {};

                for (const module of this.courseData.modules) {
                    // Module-level activities (no moments/submoments)
                    if (module.activities && Array.isArray(module.activities)) {
                        for (const activity of module.activities) {
                            if (activity.id === activityId) {
                                return { module: module.title };
                            }
                        }
                    }

                    // Activities within moments â†’ submoments
                    if (module.moments && Array.isArray(module.moments)) {
                        for (const moment of module.moments) {
                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                for (const submoment of moment.submoments) {
                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        for (const activity of submoment.activities) {
                                            if (activity.id === activityId) {
                                                return {
                                                    module: module.title,
                                                    moment: moment.title,
                                                    submoment: submoment.title
                                                };
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                return {};
            },

            // ===== SECURITY & SANITIZATION =====

            sanitizeHTML(html) {
                const div = document.createElement('div');
                div.textContent = html;
                return div.innerHTML;
            },

            /**
             * Sanitize rich HTML content (slides) â€” allows safe formatting tags
             * but strips dangerous elements (script, iframe, event handlers, etc.).
             */
            sanitizeRichHTML(html) {
                if (!html) return '';
                const temp = document.createElement('div');
                temp.innerHTML = html;

                const ALLOWED_TAGS = new Set([
                    'p', 'br', 'strong', 'b', 'em', 'i', 'u', 's', 'del',
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'ul', 'ol', 'li', 'dl', 'dt', 'dd',
                    'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td', 'caption',
                    'blockquote', 'pre', 'code', 'hr', 'div', 'span',
                    'a', 'img', 'figure', 'figcaption', 'sup', 'sub', 'mark',
                ]);
                const ALLOWED_ATTRS = new Set([
                    'href', 'src', 'alt', 'title', 'class', 'id', 'style',
                    'target', 'rel', 'loading', 'width', 'height',
                    'colspan', 'rowspan', 'scope',
                ]);

                const walk = (node) => {
                    const toRemove = [];
                    for (const child of node.childNodes) {
                        if (child.nodeType === Node.ELEMENT_NODE) {
                            const tag = child.tagName.toLowerCase();
                            if (!ALLOWED_TAGS.has(tag)) {
                                toRemove.push(child);
                                continue;
                            }
                            // Strip disallowed attributes (especially event handlers)
                            const attrs = Array.from(child.attributes);
                            for (const attr of attrs) {
                                const name = attr.name.toLowerCase();
                                if (!ALLOWED_ATTRS.has(name) || name.startsWith('on')) {
                                    child.removeAttribute(attr.name);
                                }
                            }
                            // Sanitize href/src to prevent javascript: URLs
                            for (const urlAttr of ['href', 'src']) {
                                const val = (child.getAttribute(urlAttr) || '').trim().toLowerCase();
                                if (val.startsWith('javascript:') || val.startsWith('data:text/html')) {
                                    child.removeAttribute(urlAttr);
                                }
                            }
                            walk(child);
                        }
                    }
                    for (const el of toRemove) {
                        el.remove();
                    }
                };

                walk(temp);
                return temp.innerHTML;
            },

            renderSlide() {
                const slide = this.currentActivity.slides[this.currentSlideIndex];
                const container = document.getElementById('slideContainer');

                // We purposefully do NOT render the title here as per requirements.
                // Only the content is shown.

                // Check if activity is ignored
                const isIgnored = this.currentActivity.ignored === true;
                const ignoredBanner = isIgnored
                    ? '<div class="ignored-slide-banner"><span class="material-symbols-outlined">visibility_off</span> Ignored: please skip</div>'
                    : '';

                // Check if this is a title slide (module, moment, or submoment)
                const isTitleSlide = this.currentActivity.isTitleSlide === true;

                console.log('Rendering slide:', {
                    activityId: this.currentActivity.id,
                    activityTitle: this.currentActivity.title,
                    isTitleSlide: isTitleSlide,
                    titleType: this.currentActivity.titleType
                });

                if (isTitleSlide) {
                    console.log('Rendering TITLE slide for:', this.currentActivity.titleType);
                    // For title slides, render content directly without wrapper to allow absolute positioning
                    container.innerHTML = `
                        <div class="slide slide-title-full">
                            ${this.sanitizeRichHTML(slide.content)}
                        </div>
                    `;
                } else {
                    // For regular activity slides, use normal wrapper
                    container.innerHTML = `
                        <div class="slide ${isIgnored ? 'slide-ignored' : ''}">
                            ${ignoredBanner}
                            <div class="slide-content">${this.sanitizeRichHTML(slide.content)}</div>
                        </div>
                    `;
                }

                this.updateSlideCounter();
                this.updateNavigationButtons();
                this.updateActivityProgress();
                this.updateGeneralProgress();

                // Mark activity as covered when the final slide has been reached
                const totalSlides = (this.currentActivity.slides && this.currentActivity.slides.length) ? this.currentActivity.slides.length : 0;
                if (totalSlides > 0 && this.currentSlideIndex >= totalSlides - 1) {
                    this.markActivityCovered(this.currentActivity.id);
                }

                // Reapply zoom after slide content changes
                setTimeout(() => this.applyZoom(), 0);
            },

            updateSlideCounter() {
                const total = this.currentActivity.slides.length;
                const current = this.currentSlideIndex + 1;
                document.getElementById('slideCounter').textContent = `Slide ${current} / ${total}`;
            },

            updateNavigationButtons() {
                const prevBtn = document.getElementById('prevSlideBtn');
                const nextBtn = document.getElementById('nextSlideBtn');

                const hasPrev = (this.currentSlideIndex > 0) || !!this.getPrevActivity();
                const hasNext = (this.currentSlideIndex < this.currentActivity.slides.length - 1) || !!this.getNextActivity();

                prevBtn.disabled = !hasPrev;
                nextBtn.disabled = !hasNext;
            },

            updateActiveNav() {
                if (!this.currentActivity) return;

                // Remove all active classes
                document.querySelectorAll('.nav-activity').forEach(el => {
                    el.classList.remove('active');
                });

                // Add active class to current activity
                const activeEl = document.querySelector(`[data-activity-id="${this.currentActivity.id}"]`);
                if (activeEl) {
                    activeEl.classList.add('active');
                }

                // Ensure covered-state colouring is applied as well
                this.updateCompletedActivitiesInNav();

                // Update train line
                if (this.trainLine && this.trainLine.initialized) {
                    this.trainLine.update();
                }
            },

            updateCompletedActivitiesInNav() {
                document.querySelectorAll('.nav-activity').forEach(el => {
                    const id = el.dataset.activityId;
                    if (!id) return;
                    el.classList.toggle('completed', this.completedActivities.has(id));
                });
            },

            markActivityCovered(activityId) {
                const id = (activityId === undefined || activityId === null) ? '' : String(activityId).trim();
                if (!id) return;
                if (!this.completedActivities.has(id)) {
                    this.completedActivities.add(id);
                    this.updateCompletedActivitiesInNav();

                    // Update train line
                    if (this.trainLine && this.trainLine.initialized) {
                        this.trainLine.update();
                    }
                }
            },

            nextSlide() {
                if (this.currentSlideIndex < this.currentActivity.slides.length - 1) {
                    this.currentSlideIndex++;
                    this.renderSlide();
                    this.updateHash();
                    return;
                }

                // We are on the last slide of the current activity
                this.updateGeneralProgress();

                const nextActivity = this.getNextActivity();
                if (nextActivity) {
                    this.loadActivityAtSlide(nextActivity, 0);
                }
            },

            prevSlide() {
                if (this.currentSlideIndex > 0) {
                    this.currentSlideIndex--;
                    this.renderSlide();
                    this.updateHash();
                    return;
                }

                const prevActivity = this.getPrevActivity();
                if (prevActivity) {
                    this.loadActivityAtSlide(prevActivity, prevActivity.slides.length - 1);
                }
            },

            startTraining() {
                if (!this.courseData || !this.courseData.modules || this.courseData.modules.length === 0) {
                    alert('âš ï¸ No content loaded.\n\nPlease import a JSON or Markdown file to begin.');
                    return;
                }

                // Load the first activity from getAllActivitiesInOrder
                const allActivities = this.getAllActivitiesInOrder();
                if (allActivities.length > 0) {
                    this.loadActivity(allActivities[0]);
                } else {
                    alert('âš ï¸ No activities found in the course data.');
                }
            },

            // Search functionality
            // Enhanced Search System
            searchHistory: [],
            searchFilters: {
                completion: 'all', // 'all', 'completed', 'incomplete'
            },
            maxSearchHistory: 5,

            performSearch(query) {
                this.searchQuery = query.toLowerCase().trim();

                if (!this.searchQuery) {
                    this.clearSearch();
                    return;
                }

                // Save to search history
                this.addToSearchHistory(this.searchQuery);

                if (!this.courseData || !this.courseData.modules) return;

                const results = [];

                // Helper function to search through activities
                const searchActivities = (activities, module, moment = null, submoment = null) => {
                    activities.forEach(activity => {
                        // Skip ignored activities
                        if (activity.ignored === true) return;

                        // Check activity title
                        if (activity.title.toLowerCase().includes(this.searchQuery)) {
                            results.push({
                                type: 'activity',
                                activity: activity,
                                module: module,
                                moment: moment,
                                submoment: submoment,
                                title: activity.title,
                                context: 'Activity match',
                                timestamp: Date.now()
                            });
                        }

                        // Check slide content
                        if (activity.slides && Array.isArray(activity.slides)) {
                            activity.slides.forEach((slide, index) => {
                                const slideText = (slide.title + ' ' + slide.content).toLowerCase();
                                if (slideText.includes(this.searchQuery)) {
                                    // Extract context with search term
                                    const contextText = slide.content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                                    const queryIndex = contextText.toLowerCase().indexOf(this.searchQuery);
                                    const contextStart = Math.max(0, queryIndex - 50);
                                    const contextEnd = Math.min(contextText.length, queryIndex + this.searchQuery.length + 50);
                                    const contextSnippet = (contextStart > 0 ? '...' : '') +
                                                         contextText.substring(contextStart, contextEnd) +
                                                         (contextEnd < contextText.length ? '...' : '');

                                    results.push({
                                        type: 'slide',
                                        activity: activity,
                                        module: module,
                                        moment: moment,
                                        submoment: submoment,
                                        slideIndex: index,
                                        title: `${activity.title}`,
                                        slideTitle: slide.title || `Slide ${index + 1}`,
                                        context: contextSnippet || slide.title || 'Slide content',
                                        timestamp: Date.now()
                                    });
                                }
                            });
                        }
                    });
                };

                // Search through all activities and slides
                this.courseData.modules.forEach(module => {
                    // Search module-level activities
                    if (module.activities && Array.isArray(module.activities)) {
                        searchActivities(module.activities, module, null, null);
                    }

                    // Search activities within moments and submoments
                    if (module.moments && Array.isArray(module.moments)) {
                        module.moments.forEach(moment => {
                            // Skip ignored moments
                            if (moment.ignored === true) return;

                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                moment.submoments.forEach(submoment => {
                                    // Skip ignored submoments
                                    if (submoment.ignored === true) return;

                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        searchActivities(submoment.activities, module, moment, submoment);
                                    }
                                });
                            }
                        });
                    }
                });

                this.displaySearchResults(results);
            },

            addToSearchHistory(query) {
                // Remove if already exists
                this.searchHistory = this.searchHistory.filter(item => item !== query);
                // Add to beginning
                this.searchHistory.unshift(query);
                // Limit to max items
                if (this.searchHistory.length > this.maxSearchHistory) {
                    this.searchHistory = this.searchHistory.slice(0, this.maxSearchHistory);
                }
                // Save to localStorage
                this.safeLocalStorageSet('searchHistory', JSON.stringify(this.searchHistory));
            },

            loadSearchHistory() {
                const saved = this.safeLocalStorageGet('searchHistory');
                if (saved) {
                    try {
                        this.searchHistory = JSON.parse(saved);
                    } catch (e) {
                        this.searchHistory = [];
                    }
                }
            },

            clearSearchHistory() {
                this.searchHistory = [];
                this.safeLocalStorageSet('searchHistory', JSON.stringify([]));
                this.renderSearchHistory();
            },

            renderSearchHistory() {
                const historyContainer = document.getElementById('searchHistory');
                const historyItems = document.getElementById('searchHistoryItems');

                if (this.searchHistory.length === 0) {
                    historyContainer.style.display = 'none';
                    return;
                }

                historyContainer.style.display = 'block';
                historyItems.innerHTML = this.searchHistory.map(query => `
                    <div class="search-history-item" data-query="${this.sanitizeHTML(query)}">
                        <span class="material-symbols-outlined">history</span>
                        ${this.sanitizeHTML(query)}
                    </div>
                `).join('');

                // Add click handlers
                historyItems.querySelectorAll('.search-history-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const query = el.dataset.query;
                        document.getElementById('searchInput').value = query;
                        this.performSearch(query);
                    });
                });
            },

            displaySearchResults(results) {
                const navTree = document.getElementById('navTree');
                const searchResults = document.getElementById('searchResults');
                const searchResultsList = document.getElementById('searchResultsList');
                const searchFilters = document.getElementById('searchFilters');
                const searchResultsHeader = document.getElementById('searchResultsHeader');
                const searchResultsCount = document.getElementById('searchResultsCount');
                const searchHistory = document.getElementById('searchHistory');

                navTree.style.display = 'none';
                searchResults.classList.add('visible');
                searchHistory.style.display = 'none';

                // Apply filters
                let filteredResults = results;
                if (this.searchFilters.completion !== 'all') {
                    filteredResults = results.filter(result => {
                        const isCompleted = this.isActivityCompleted(result.activity);
                        return this.searchFilters.completion === 'completed' ? isCompleted : !isCompleted;
                    });
                }

                // Show filters and header
                searchFilters.style.display = 'block';
                searchResultsHeader.style.display = 'flex';
                searchResultsCount.textContent = `${filteredResults.length} result${filteredResults.length !== 1 ? 's' : ''}`;

                if (filteredResults.length === 0) {
                    searchResultsList.innerHTML = `
                        <div class="no-results">
                            <span class="material-symbols-outlined">search_off</span>
                            <div class="no-results-title">No results found</div>
                            <div class="no-results-text">Try adjusting your search terms or filters</div>
                        </div>
                    `;
                    return;
                }

                searchResultsList.innerHTML = filteredResults.map(result => {
                    const highlightedContext = this.highlightText(result.context, this.searchQuery);
                    const highlightedTitle = this.highlightText(result.title, this.searchQuery);
                    const isCompleted = this.isActivityCompleted(result.activity);

                    // Generate thumbnail
                    const thumbnailContent = result.type === 'slide'
                        ? `<div class="search-result-thumbnail-text">${result.slideTitle}</div>`
                        : `<span class="material-symbols-outlined">description</span>`;

                    return `
                        <div class="search-result-item" data-activity-id="${result.activity.id}" data-slide-index="${result.slideIndex || 0}">
                            <div class="search-result-thumbnail">
                                ${thumbnailContent}
                            </div>
                            <div class="search-result-content">
                                <div class="search-result-title">
                                    ${highlightedTitle}
                                    ${result.type === 'slide' ? '<span class="search-result-badge">Slide ' + (result.slideIndex + 1) + '</span>' : ''}
                                </div>
                                <div class="search-result-context">${highlightedContext}</div>
                                <div class="search-result-meta">
                                    <div class="search-result-meta-item">
                                        <span class="material-symbols-outlined">folder</span>
                                        ${result.module.title}
                                    </div>
                                    ${isCompleted ? '<div class="search-result-meta-item"><span class="material-symbols-outlined">check_circle</span>Completed</div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add click handlers to search results
                searchResultsList.querySelectorAll('.search-result-item').forEach(el => {
                    el.addEventListener('click', () => {
                        const activityId = el.dataset.activityId;
                        const slideIndex = parseInt(el.dataset.slideIndex);
                        const activity = this.findActivityById(activityId);

                        if (activity) {
                            this.currentActivity = activity;
                            this.currentSlideIndex = slideIndex;
                            this.updateActivityHeader();
                            this.renderSlide();
                            this.updateActiveNav();

                            // Highlight search terms in the slide content
                            this.highlightSearchTermsInSlide();

                            this.clearSearch();
                            this.closeMobileMenu();
                            this.updateHash();
                            document.getElementById('slideControls').classList.remove('hidden');
                        }
                    });
                });
            },

            highlightSearchTermsInSlide() {
                if (!this.searchQuery) return;

                setTimeout(() => {
                    const slideContent = document.querySelector('.slide-content');
                    if (!slideContent) return;

                    // Walk through text nodes and highlight
                    const walk = (node) => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const text = node.textContent;
                            const lowerText = text.toLowerCase();
                            const queryLower = this.searchQuery.toLowerCase();

                            if (lowerText.includes(queryLower)) {
                                const span = document.createElement('span');
                                span.innerHTML = this.highlightText(text, this.searchQuery);
                                node.parentNode.replaceChild(span, node);
                            }
                        } else if (node.nodeType === Node.ELEMENT_NODE && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
                            Array.from(node.childNodes).forEach(child => walk(child));
                        }
                    };

                    walk(slideContent);
                }, 100);
            },

            isActivityCompleted(activity) {
                // Check if activity is in completedActivities (if you're tracking that)
                // For now, return false as placeholder
                return false;
            },

            highlightText(text, query) {
                if (!query) return text;

                // Remove HTML tags for highlighting
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const plainText = tempDiv.textContent || tempDiv.innerText;

                // Escape regex special characters to prevent regex injection
                const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escaped})`, 'gi');
                return plainText.substring(0, 150).replace(regex, '<span class="search-highlight">$1</span>');
            },

            findActivityById(activityId) {
                if (!this.courseData || !this.courseData.modules) return null;
                for (const module of this.courseData.modules) {
                    // Check module-level activities first
                    if (module.activities && Array.isArray(module.activities)) {
                        for (const activity of module.activities) {
                            if (activity.id === activityId) {
                                return activity;
                            }
                        }
                    }

                    // Check activities within moments and submoments
                    if (module.moments && Array.isArray(module.moments)) {
                        for (const moment of module.moments) {
                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                for (const submoment of moment.submoments) {
                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        for (const activity of submoment.activities) {
                                            if (activity.id === activityId) {
                                                return activity;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                return null;
            },

            clearSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchClear = document.getElementById('searchClear');
                const navTree = document.getElementById('navTree');
                const searchResults = document.getElementById('searchResults');
                const searchFilters = document.getElementById('searchFilters');
                const searchResultsHeader = document.getElementById('searchResultsHeader');
                const searchHistory = document.getElementById('searchHistory');

                searchInput.value = '';
                searchClear.classList.remove('visible');
                navTree.style.display = 'block';
                searchResults.classList.remove('visible');

                // Hide filters and header
                if (searchFilters) searchFilters.style.display = 'none';
                if (searchResultsHeader) searchResultsHeader.style.display = 'none';

                // Show search history if available
                this.renderSearchHistory();

                this.searchQuery = '';
                this.searchFilters.completion = 'all';
                this.updateFilterButtons();
            },

            updateFilterButtons() {
                document.querySelectorAll('.search-filter-btn').forEach(btn => {
                    const filter = btn.dataset.filter;
                    if (filter === this.searchFilters.completion) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            },

            initSearchHandlers() {
                // Search history clear button
                const clearHistoryBtn = document.getElementById('clearSearchHistory');
                if (clearHistoryBtn) {
                    clearHistoryBtn.addEventListener('click', () => {
                        this.clearSearchHistory();
                    });
                }

                // Filter buttons
                document.querySelectorAll('.search-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.searchFilters.completion = btn.dataset.filter;
                        this.updateFilterButtons();
                        // Re-run search with new filters
                        if (this.searchQuery) {
                            const searchInput = document.getElementById('searchInput');
                            this.performSearch(searchInput.value);
                        }
                    });
                });

                // Load search history on init
                this.loadSearchHistory();
            },

            // Mobile menu
            toggleMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                
                sidebar.classList.toggle('open');
                overlay.classList.toggle('visible');
            },

            closeMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                
                sidebar.classList.remove('open');
                overlay.classList.remove('visible');
            },

            // Hash navigation
            updateHash() {
                if (this.currentActivity) {
                    window.location.hash = `${this.currentActivity.id}-slide-${this.currentSlideIndex}`;
                    this.safeLocalStorageSet('lastPosition', JSON.stringify({
                        activityId: this.currentActivity.id,
                        slideIndex: this.currentSlideIndex
                    }));
                }
            },

            loadStateFromHash() {
                const hash = window.location.hash.substring(1);
                if (!hash) return;

                const match = hash.match(/^(.+)-slide-(\d+)$/);
                if (match) {
                    const activityId = match[1];
                    const slideIndex = parseInt(match[2]);
                    const activity = this.findActivityById(activityId);
                    
                    if (activity && slideIndex < activity.slides.length) {
                        this.currentActivity = activity;
                        this.currentSlideIndex = slideIndex;
                        this.updateActivityHeader();
                        this.renderSlide();
                        this.updateActiveNav();
                        document.getElementById('slideControls').classList.remove('hidden');
                    }
                }
            },

            attachEventListeners() {

                // Font size (slide content)
                const fontSizeSelect = document.getElementById('fontSizeSelect');
                if (fontSizeSelect) {
                    fontSizeSelect.addEventListener('change', () => {
                        this.setSlideFontSize(fontSizeSelect.value, true);
                    });
                }
                const navFoldAllBtn = document.getElementById('navFoldAllBtn');
                if (navFoldAllBtn) {
                    navFoldAllBtn.addEventListener('click', () => this.toggleNavFoldAll());
                }

                const toggleIgnoredBtn = document.getElementById('toggleIgnoredBtn');
                if (toggleIgnoredBtn) {
                    toggleIgnoredBtn.addEventListener('click', () => this.toggleIgnored());
                }

                // Navigation click (event delegation) - robust even after re-render
                const navTree = document.getElementById('navTree');
                if (navTree) {
                    const handleNavActivation = (e) => {
                        try {
                            const activityEl = e.target.closest('.nav-activity');
                            if (!activityEl) return;
                            const activityId = activityEl.dataset.activityId;
                            if (!activityId) return;
                            const activity = this.findActivityById(activityId);
                            if (activity) {
                                this.loadActivity(activity);
                            }
                        } catch (err) {
                            console.error('Navigation click error:', err);
                            this.setStatus('Navigation error: ' + (err && err.message ? err.message : String(err)), 'error');
                        }
                    };

                    navTree.addEventListener('click', handleNavActivation);
                    navTree.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleNavActivation(e);
                        }
                    });
                }
// Search
                const searchInput = document.getElementById('searchInput');
                const searchClear = document.getElementById('searchClear');

                searchInput.addEventListener('input', (e) => {
                    const value = e.target.value;
                    searchClear.classList.toggle('visible', value.length > 0);
                    this.performSearch(value);
                });

                searchClear.addEventListener('click', () => {
                    this.clearSearch();
                });

                // Mobile menu
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    this.toggleMobileMenu();
                });

                document.getElementById('mobileOverlay').addEventListener('click', () => {
                    this.closeMobileMenu();
                });

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (!this.currentActivity) return;

                    // Ignore if user is typing in search
                    if (document.activeElement === searchInput) return;

                    switch(e.key) {
                        case 'ArrowRight':
                        case ' ':
                            e.preventDefault();
                            this.nextSlide();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.prevSlide();
                            break;
                        case 'Home':
                            e.preventDefault();
                            this.currentSlideIndex = 0;
                            this.renderSlide();
                            this.updateHash();
                            break;
                        case 'End':
                            e.preventDefault();
                            this.currentSlideIndex = this.currentActivity.slides.length - 1;
                            this.renderSlide();
                            this.updateHash();
                            break;
                        case 'Escape':
                            if (window.innerWidth <= 768) {
                                this.closeMobileMenu();
                            }
                            // Close modals if open
                            const aboutModal = document.getElementById('aboutModal');
                            const exportModal = document.getElementById('exportModal');
                            if (aboutModal && aboutModal.classList.contains('visible')) {
                                this.closeAboutModal();
                            } else if (exportModal && exportModal.classList.contains('visible')) {
                                this.closeExportModal();
                            }
                            break;
                    }
                });

                // Hash change
                window.addEventListener('hashchange', () => {
                    this.loadStateFromHash();
                });
            },

            // ===== DETAILS PANEL TOGGLE =====

            toggleDetailsPanel() {
                this.detailsPanelExpanded = !this.detailsPanelExpanded;
                const panel = document.getElementById('detailsPanel');
                const btn = document.getElementById('togglePanelBtn');
                const text = document.getElementById('togglePanelText');

                if (this.detailsPanelExpanded) {
                    panel.classList.add('expanded');
                    btn.classList.add('expanded');
                    text.textContent = 'Hide Details';
                } else {
                    panel.classList.remove('expanded');
                    btn.classList.remove('expanded');
                    text.textContent = 'Details';
                }

                // Save state
                this.safeLocalStorageSet('detailsPanelExpanded', this.detailsPanelExpanded);
            },

            loadDetailsPanelState() {
                const saved = this.safeLocalStorageGet('detailsPanelExpanded');
                if (saved === 'true') {
                    this.detailsPanelExpanded = false; // Will be toggled to true
                    this.toggleDetailsPanel();
                }
            },

            loadLastPosition() {
                if (this.currentActivity) return; // hash already restored position
                const raw = this.safeLocalStorageGet('lastPosition');
                if (!raw) return;
                try {
                    const { activityId, slideIndex } = JSON.parse(raw);
                    const activity = this.findActivityById(activityId);
                    if (activity && activity.slides && slideIndex < activity.slides.length) {
                        this.loadActivityAtSlide(activity, slideIndex);
                    }
                } catch (e) { /* stale/corrupt data â€” silently ignore */ }
            },

            // ===== ZOOM METHODS =====

            zoomIn() {
                if (this.zoomLevel < this.zoomMax) {
                    this.zoomLevel += this.zoomStep;
                    this.applyZoom();
                }
            },

            zoomOut() {
                if (this.zoomLevel > this.zoomMin) {
                    this.zoomLevel -= this.zoomStep;
                    this.applyZoom();
                }
            },

            zoomReset() {
                this.zoomLevel = 100;
                this.applyZoom();
            },

            // ===== FONT SIZE (SLIDE CONTENT) =====
            loadFontSizePreference() {
                const allowed = [14, 16, 18, 20, 22, 24, 26, 28];
                let px = 18;
                const saved = this.safeLocalStorageGet('slideFontSize');
                const n = parseInt(saved, 10);
                if (allowed.includes(n)) px = n;
                this.setSlideFontSize(px, false);
            },

            setSlideFontSize(px, persist = true) {
                const allowed = [14, 16, 18, 20, 22, 24, 26, 28];
                const n = parseInt(px, 10);
                const finalPx = allowed.includes(n) ? n : 18;

                document.documentElement.style.setProperty('--slide-font-size', `${finalPx}px`);
                this.slideFontSize = finalPx;

                const select = document.getElementById('fontSizeSelect');
                if (select) select.value = String(finalPx);

                const valueDisplay = document.getElementById('fontSizeValue');
                if (valueDisplay) valueDisplay.textContent = `${finalPx}px`;

                if (persist) this.safeLocalStorageSet('slideFontSize', String(finalPx));
            },

            increaseFontSize() {
                const allowed = [14, 16, 18, 20, 22, 24, 26, 28];
                const currentIndex = allowed.indexOf(this.slideFontSize);
                if (currentIndex < allowed.length - 1) {
                    this.setSlideFontSize(allowed[currentIndex + 1], true);
                }
            },

            decreaseFontSize() {
                const allowed = [14, 16, 18, 20, 22, 24, 26, 28];
                const currentIndex = allowed.indexOf(this.slideFontSize);
                if (currentIndex > 0) {
                    this.setSlideFontSize(allowed[currentIndex - 1], true);
                }
            },


            applyZoom() {
                const slide = document.querySelector('.slide');
                const slideContainer = document.querySelector('.slide-container');
                const mainContent = document.querySelector('.main-content');

                if (slide) {
                    const scale = this.zoomLevel / 100;
                    slide.style.transform = `scale(${scale})`;

                    // Adjust container padding based on zoom level to prevent cutoff
                    if (slideContainer) {
                        const inPresMode = document.body.classList.contains('presentation-mode');
                        if (inPresMode) {
                            // In presentation mode the lateral margin is driven by the
                            // CSS variable --pres-h-margin. Clear any inline override so
                            // the CSS rule takes effect.
                            slideContainer.style.removeProperty('padding');
                        } else if (scale > 1) {
                            // Reduce padding proportionally when zoomed in
                            const basePadding = 48;
                            const adjustedPadding = Math.max(basePadding / scale, 20);
                            slideContainer.style.padding = `${adjustedPadding}px`;
                        } else {
                            // Restore normal padding
                            slideContainer.style.padding = '56px 48px';
                        }
                    }

                    // Ensure main content area handles overflow properly when zoomed
                    if (mainContent) {
                        if (scale > 1) {
                            // Enable scrolling on main-content for zoomed content
                            mainContent.style.overflowX = 'auto';
                            mainContent.style.overflowY = 'auto';
                        } else {
                            // Normal scrolling at 100% or less
                            mainContent.style.overflowX = 'hidden';
                            mainContent.style.overflowY = 'auto';
                        }
                    }
                }

                // Update zoom level display
                const zoomLevelEl = document.getElementById('zoomLevel');
                if (zoomLevelEl) {
                    zoomLevelEl.textContent = `${this.zoomLevel}%`;
                }

                // Update button states
                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
                
                if (zoomInBtn) {
                    zoomInBtn.disabled = this.zoomLevel >= this.zoomMax;
                }
                if (zoomOutBtn) {
                    zoomOutBtn.disabled = this.zoomLevel <= this.zoomMin;
                }

                // Save zoom preference
                this.safeLocalStorageSet('zoomLevel', this.zoomLevel.toString());
            },

            loadZoomPreference() {
                const savedZoom = this.safeLocalStorageGet('zoomLevel');
                if (savedZoom) {
                    const parsed = parseInt(savedZoom, 10);
                    if (!isNaN(parsed) && parsed >= this.zoomMin && parsed <= this.zoomMax) {
                        this.zoomLevel = parsed;
                        this.applyZoom();
                    }
                }
            },

            // ===== COLLAPSIBLE SECTIONS =====
            toggleSection(sectionName) {
                this.sectionsCollapsed[sectionName] = !this.sectionsCollapsed[sectionName];
                this.updateSectionDisplay(sectionName);
                this.saveSectionState();
            },

            updateSectionDisplay(sectionName) {
                const content = document.querySelector(`#${sectionName}Content`);
                const btn = document.querySelector(`#${sectionName}ToggleBtn`);

                if (!content) return;

                if (this.sectionsCollapsed[sectionName]) {
                    content.classList.add('collapsed');
                    if (btn) btn.classList.remove('active');
                } else {
                    content.classList.remove('collapsed');
                    if (btn) btn.classList.add('active');
                }
            },

            saveSectionState() {
                this.safeLocalStorageSet('sectionsCollapsed', JSON.stringify(this.sectionsCollapsed));
            },

            loadSectionState() {
                // Always start collapsed â€” sections are never restored from localStorage
                this.sectionsCollapsed = { zoom: true, timer: true, margin: true };
                ['zoom', 'timer', 'margin'].forEach(section => {
                    this.updateSectionDisplay(section);
                });
            },

            showZoomControls() {
                // Zoom controls are managed via collapsible sections.
                // Clear any legacy inline display:none that may have been set previously.
                const zoomControls = document.getElementById('zoomControls');
                if (zoomControls) zoomControls.style.removeProperty('display');
                const timerTopRight = document.getElementById('timerTopRight');
                if (timerTopRight) timerTopRight.style.removeProperty('display');
            },

            // â”€â”€ Train map visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            toggleTrainLine() {
                const hidden = document.body.classList.toggle('train-line-hidden');
                const btn = document.getElementById('trainLineToggleBtn');
                if (btn) btn.classList.toggle('active', !hidden);
                try { localStorage.setItem('trainLineVisible', !hidden); } catch (e) {}
            },

            loadTrainLineVisibility() {
                const saved = localStorage.getItem('trainLineVisible');
                // Default: hidden (no saved value â†’ treat as false)
                const visible = saved === 'true';
                if (!visible) {
                    document.body.classList.add('train-line-hidden');
                    const btn = document.getElementById('trainLineToggleBtn');
                    if (btn) btn.classList.remove('active');
                }
            },

            // â”€â”€ Presentation lateral margin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            setPresentationMargin(px) {
                const value = Math.min(420, Math.max(40, parseInt(px, 10)));
                document.documentElement.style.setProperty('--pres-h-margin', value + 'px');
                // Clear any inline padding that applyZoom may have left so the
                // CSS-variable rule takes effect immediately.
                const sc = document.querySelector('.slide-container');
                if (sc) sc.style.removeProperty('padding');
                const slider = document.getElementById('presMarginSlider');
                if (slider) slider.value = value;
                const label = document.getElementById('marginValue');
                if (label) label.textContent = value + 'px';
                try { localStorage.setItem('presentationMargin', value); } catch (e) {}
            },

            initPresentationMargin() {
                const saved = localStorage.getItem('presentationMargin');
                const value = saved ? parseInt(saved, 10) : 200;
                document.documentElement.style.setProperty('--pres-h-margin', value + 'px');
                const slider = document.getElementById('presMarginSlider');
                if (slider) slider.value = value;
                const label = document.getElementById('marginValue');
                if (label) label.textContent = value + 'px';
            },

            _cachedActivitiesInOrder: null,

            getAllActivitiesInOrder() {
                if (this._cachedActivitiesInOrder) {
                    console.log('Returning cached activities, count:', this._cachedActivitiesInOrder.length);
                    return this._cachedActivitiesInOrder;
                }

                console.log('Building activities list with title slides...');
                const list = [];
                if (!this.courseData || !this.courseData.modules) return list;

                this.courseData.modules.forEach((module, moduleIndex) => {
                    // Add module title slide - SOFT BLUE BACKGROUND, CENTERED
                    list.push({
                        id: `module-title-${module.id}`,
                        title: module.title,
                        isTitleSlide: true,
                        titleType: 'module',
                        slides: [{
                            content: `<div style="
                                position: absolute;
                                inset: 0;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                background: #E3F2FD;
                                text-align: center;
                                padding: 4rem;
                            ">
                                <div style="
                                    display: inline-block;
                                    font-size: 0.75rem;
                                    font-weight: 500;
                                    letter-spacing: 0.15em;
                                    text-transform: uppercase;
                                    color: #1976D2;
                                    margin-bottom: 2rem;
                                    padding: 0.5rem 1.5rem;
                                    background: white;
                                    border-radius: 20px;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                ">Module ${moduleIndex + 1}</div>
                                <h1 style="
                                    font-size: 3rem;
                                    font-weight: 300;
                                    line-height: 1.3;
                                    margin: 0;
                                    color: #1565C0;
                                    max-width: 800px;
                                ">${this.sanitizeHTML(module.title)}</h1>
                            </div>`
                        }]
                    });

                    // Add module-level activities first (if they exist)
                    if (module.activities && Array.isArray(module.activities)) {
                        module.activities.forEach(activity => {
                            // Skip ignored activities
                            if (activity.ignored !== true) {
                                list.push(activity);
                            }
                        });
                    }

                    // Add activities from moments and submoments
                    if (module.moments && Array.isArray(module.moments)) {
                        module.moments.forEach((moment, momentIndex) => {
                            // Skip ignored moments
                            if (moment.ignored === true) return;

                            // Add moment title slide - SOFT GREY BACKGROUND, CENTERED
                            list.push({
                                id: `moment-title-${moment.id || moduleIndex + '-' + momentIndex}`,
                                title: moment.title,
                                isTitleSlide: true,
                                titleType: 'moment',
                                slides: [{
                                    content: `<div style="
                                        position: absolute;
                                        inset: 0;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        justify-content: center;
                                        background: #F5F5F5;
                                        text-align: center;
                                        padding: 4rem;
                                    ">
                                        <div style="
                                            display: inline-block;
                                            font-size: 0.7rem;
                                            font-weight: 500;
                                            letter-spacing: 0.12em;
                                            text-transform: uppercase;
                                            color: #5E35B1;
                                            margin-bottom: 1.5rem;
                                            padding: 0.4rem 1.2rem;
                                            background: white;
                                            border-radius: 16px;
                                            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                                        ">Moment ${moduleIndex + 1}.${momentIndex + 1}</div>
                                        <h2 style="
                                            font-size: 2.5rem;
                                            font-weight: 300;
                                            line-height: 1.4;
                                            color: #4527A0;
                                            margin: 0;
                                            max-width: 700px;
                                        ">${this.sanitizeHTML(moment.title)}</h2>
                                    </div>`
                                }]
                            });

                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                moment.submoments.forEach((submoment, submomentIndex) => {
                                    // Skip ignored submoments
                                    if (submoment.ignored === true) return;

                                    // Add submoment title slide - WHITE BACKGROUND, CENTERED, MINIMAL BORDER
                                    list.push({
                                        id: `submoment-title-${submoment.id || moduleIndex + '-' + momentIndex + '-' + submomentIndex}`,
                                        title: submoment.title,
                                        isTitleSlide: true,
                                        titleType: 'submoment',
                                        slides: [{
                                            content: `<div style="
                                                position: absolute;
                                                inset: 0;
                                                display: flex;
                                                flex-direction: column;
                                                align-items: center;
                                                justify-content: center;
                                                background: white;
                                                text-align: center;
                                                padding: 4rem;
                                            ">
                                                <div style="
                                                    display: inline-block;
                                                    font-size: 0.65rem;
                                                    font-weight: 500;
                                                    letter-spacing: 0.1em;
                                                    text-transform: uppercase;
                                                    color: #00897B;
                                                    margin-bottom: 1.25rem;
                                                    padding: 0.35rem 1rem;
                                                    background: #E0F2F1;
                                                    border-radius: 12px;
                                                ">Sous-moment ${moduleIndex + 1}.${momentIndex + 1}.${submomentIndex + 1}</div>
                                                <h3 style="
                                                    font-size: 2rem;
                                                    font-weight: 300;
                                                    line-height: 1.5;
                                                    color: #00695C;
                                                    margin: 0;
                                                    max-width: 650px;
                                                    padding-top: 1rem;
                                                    border-top: 2px solid #B2DFDB;
                                                ">${this.sanitizeHTML(submoment.title)}</h3>
                                            </div>`
                                        }]
                                    });

                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        submoment.activities.forEach(activity => {
                                            // Skip ignored activities
                                            if (activity.ignored !== true) {
                                                list.push(activity);
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                this._cachedActivitiesInOrder = list;
                console.log('Total activities with title slides:', list.length);
                console.log('Title slides:', list.filter(a => a.isTitleSlide).length);
                return list;
            },

            getNextActivity() {
                const activities = this.getAllActivitiesInOrder();
                const idx = activities.findIndex(a => a.id === this.currentActivity?.id);
                if (idx === -1) return null;
                return (idx < activities.length - 1) ? activities[idx + 1] : null;
            },

            getPrevActivity() {
                const activities = this.getAllActivitiesInOrder();
                const idx = activities.findIndex(a => a.id === this.currentActivity?.id);
                if (idx === -1) return null;
                return (idx > 0) ? activities[idx - 1] : null;
            },

// ===== NAVIGATION METHODS =====

            getNextSection() {
                if (!this.currentActivity) return null;

                const nextActivity = this.getNextActivity();
                if (nextActivity) {
                    return {
                        type: 'activity',
                        data: nextActivity,
                        label: 'Next Activity'
                    };
                }

                return null;
            },

            goToNextSection() {
                const nextSection = this.getNextSection();
                if (nextSection) {
                    this.loadActivity(nextSection.data);
                }
            },

            updateNextSectionButton() {
                const nextSection = this.getNextSection();
                const button = document.getElementById('nextSectionBtn');
                const label = document.getElementById('nextSectionLabel');

                if (!button || !label) return;

                if (nextSection) {
                    // Set appropriate label
                    switch (nextSection.type) {
                        case 'activity':
                            label.textContent = 'Next Activity';
                            break;
                        case 'submoment':
                            label.textContent = 'Next Sub-moment';
                            break;
                        case 'moment':
                            label.textContent = 'Next Moment';
                            break;
                        case 'module':
                            label.textContent = 'Next Module';
                            break;
                    }
                    button.disabled = false;
                } else {
                    // No next section - disable button
                    label.textContent = 'End of Training';
                    button.disabled = true;
                }
            },

            // ===== PROGRESS METHODS =====

            updateNavigationVisualState() {
                // Seen-state markers removed (no green ticks / visited/completed states)
            },

            updateMomentProgress() {
                // Seen-state markers removed (no per-moment progress ticks/badges)
            },

            updateModuleHeaderProgress() {
                // Seen-state markers removed (no per-module progress indicators)
            },

            hasAnyVisitedActivitiesInModule(module) {
                return false;
            },


            updateActivityProgress() {
                if (!this.currentActivity) return;

                const totalSlides = (this.currentActivity.slides && this.currentActivity.slides.length) ? this.currentActivity.slides.length : 0;
                const current = totalSlides > 0
                    ? Math.min(Math.max(this.currentSlideIndex + 1, 1), totalSlides)
                    : 0;
                const percentage = totalSlides > 0 ? Math.round((current / totalSlides) * 100) : 0;

                const fillElement = document.getElementById('activityProgressFill');
                const textElement = document.getElementById('activityProgressText');

                if (fillElement && textElement) {
                    fillElement.style.width = `${percentage}%`;
                    textElement.textContent = `${percentage}%`;

                    if (percentage === 100) {
                        fillElement.classList.add('complete');
                    } else {
                        fillElement.classList.remove('complete');
                    }
                }
            },

            updateGeneralProgress() {
                // Overall progress across the entire deck (all slides in all activities)
                if (!this.courseData || !this.courseData.modules) return;

                let totalSlides = 0;
                let slidesBeforeCurrent = 0;
                let currentGlobalSlide = 0;
                let foundCurrent = false;

                const currentActivityId = this.currentActivity ? this.currentActivity.id : null;
                const currentSlideIndex = Number.isInteger(this.currentSlideIndex) ? this.currentSlideIndex : 0;

                this.courseData.modules.forEach(module => {
                    (module.moments || []).forEach(moment => {
                        // Skip ignored moments
                        if (moment.ignored === true) return;

                        (moment.submoments || []).forEach(submoment => {
                            // Skip ignored submoments
                            if (submoment.ignored === true) return;

                            (submoment.activities || []).forEach(activity => {
                                // Skip ignored activities
                                if (activity.ignored === true) return;

                                const slideCount = (activity.slides && activity.slides.length) ? activity.slides.length : 0;
                                totalSlides += slideCount;

                                if (!foundCurrent) {
                                    if (currentActivityId && activity.id === currentActivityId) {
                                        // Clamp slide index to available range
                                        const local = Math.min(Math.max(currentSlideIndex, 0), Math.max(slideCount - 1, 0));
                                        currentGlobalSlide = slidesBeforeCurrent + local + 1; // 1-based
                                        foundCurrent = true;
                                    } else {
                                        slidesBeforeCurrent += slideCount;
                                    }
                                }
                            });
                        });
                    });
                });

                // Fallback: if we couldn't locate the current activity in the tree
                if (!foundCurrent) currentGlobalSlide = 0;

                const percentage = totalSlides > 0 ? Math.round((currentGlobalSlide / totalSlides) * 100) : 0;

                // Update bottom progress bar
                const fillElement = document.getElementById('generalProgressFill');
                const textElement = document.getElementById('generalProgressText');

                if (fillElement && textElement) {
                    fillElement.style.width = `${percentage}%`;
                    textElement.textContent = totalSlides > 0
                        ? `${percentage}% (${currentGlobalSlide}/${totalSlides} slides)`
                        : `0%`;
                    if (percentage === 100) {
                        fillElement.classList.add('complete');
                    } else {
                        fillElement.classList.remove('complete');
                    }
                }

                // Update sidebar progress bar (if present)
                const sidebarFill = document.getElementById('sidebar-progress-fill');
                const sidebarText = document.getElementById('sidebar-progress-text');

                if (sidebarFill && sidebarText) {
                    sidebarFill.style.width = `${percentage}%`;
                    sidebarText.textContent = `${percentage}%`;
                }
            },

            showGeneralProgress() {
                const generalProgress = document.getElementById('generalProgress');
                if (generalProgress) {
                    generalProgress.classList.remove('hidden');
                }
                this.updateGeneralProgress();
            },

            // ===== LOCAL STORAGE HELPERS WITH ERROR HANDLING =====

            safeLocalStorageSet(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.warn(`Failed to save to localStorage (${key}):`, error.message);
                    // Handle quota exceeded or disabled localStorage
                    if (error.name === 'QuotaExceededError') {
                        console.warn('localStorage quota exceeded. Consider clearing old data.');
                    }
                    return false;
                }
            },

            safeLocalStorageGet(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn(`Failed to read from localStorage (${key}):`, error.message);
                    return null;
                }
            },

            saveProgressState() {
                // Removed (legacy seen-state persistence)
            },

            loadProgressState() {
                // Removed (legacy seen-state persistence)
                this.clearSeenState();
            },



            // ===== TIMER METHODS =====
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },

            getTimerColor(elapsed, planned) {
                if (planned === 0) return 'green';
                const percentage = (elapsed / planned) * 100;
                if (percentage < 80) return 'green';
                if (percentage < 90) return 'orange';
                return 'red';
            },

            updateActivityTimerDisplay() {
                const display = document.querySelector('#activityTimer .timer-display');
                const elapsed = document.getElementById('activityElapsed');
                const planned = document.getElementById('activityPlanned');
                const fill = document.getElementById('activityTimeProgressFill');

                // Update top right timer
                const topElapsed = document.getElementById('topTimerElapsed');
                const topPlanned = document.getElementById('topTimerPlanned');
                const topDisplay = document.querySelector('#timerTopRight .timer-display');
                const topFill = document.getElementById('topTimerProgressFill');

                const timeElapsed = this.formatTime(this.activityTimer.elapsed);
                const timePlanned = this.formatTime(this.activityTimer.planned);

                if (elapsed) elapsed.textContent = timeElapsed;
                if (planned) planned.textContent = timePlanned;
                if (topElapsed) topElapsed.textContent = timeElapsed;
                if (topPlanned) topPlanned.textContent = timePlanned;

                const color = this.getTimerColor(this.activityTimer.elapsed, this.activityTimer.planned);

                if (display) {
                    display.className = `timer-display ${color}`;
                }
                if (topDisplay) {
                    topDisplay.className = `timer-display ${color}`;
                }

                const plannedSec = this.activityTimer.planned || 0;
                const pct = plannedSec > 0
                    ? Math.min(100, (this.activityTimer.elapsed / plannedSec) * 100)
                    : 0;

                if (fill) {
                    fill.style.width = `${pct}%`;
                    fill.className = `timer-progress-fill ${color}`;
                }

                // Update top timer progress bar
                if (topFill) {
                    topFill.style.width = `${pct}%`;
                    topFill.className = `timer-progress-fill ${color}`;
                }
            },


            toggleActivityTimer() {
                this.activityTimer.running = !this.activityTimer.running;

                const playBtn = document.getElementById('activityPlayBtn');
                const topPlayBtn = document.getElementById('topTimerPlayBtn');

                const pauseIcon = `
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                `;
                const playIcon = `
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                `;

                if (this.activityTimer.running) {
                    if (playBtn) {
                        playBtn.classList.add('playing');
                        playBtn.innerHTML = pauseIcon;
                        playBtn.title = 'Pause';
                    }
                    if (topPlayBtn) {
                        topPlayBtn.classList.add('playing');
                        topPlayBtn.innerHTML = pauseIcon;
                        topPlayBtn.title = 'Pause';
                    }
                } else {
                    if (playBtn) {
                        playBtn.classList.remove('playing');
                        playBtn.innerHTML = playIcon;
                        playBtn.title = 'Start';
                    }
                    if (topPlayBtn) {
                        topPlayBtn.classList.remove('playing');
                        topPlayBtn.innerHTML = playIcon;
                        topPlayBtn.title = 'Start';
                    }
                }

                this.saveTimerState();
            },

            resetActivityTimer() {
                this.activityTimer.elapsed = 0;
                this.activityTimer.running = false;
                
                const playBtn = document.getElementById('activityPlayBtn');
                playBtn.classList.remove('playing');
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                `;
                playBtn.title = 'Start';
                
                this.updateActivityTimerDisplay();
                this.saveTimerState();
            },

            startTimerTicks() {
                // Prevent multiple intervals
                if (this.timerIntervalId) {
                    return;
                }

                this.timerIntervalId = setInterval(() => {
                    
                    if (this.activityTimer.running) {
                        this.activityTimer.elapsed++;
                        this.updateActivityTimerDisplay();
                        
                        // Save every 10 seconds to reduce writes
                        if (this.activityTimer.elapsed % 10 === 0) {
                            this.saveTimerState();
                        }
                    }
                }, 1000);
            },

            stopTimerTicks() {
                if (this.timerIntervalId) {
                    clearInterval(this.timerIntervalId);
                    this.timerIntervalId = null;
                }
            },


            loadActivityTimer(activityId) {
                const activity = this.findActivityById(activityId);
                if (!activity) return;

                this.activityTimer.activityId = activityId;
                this.activityTimer.planned = (activity.plannedMinutes || 10) * 60;
                
                // Reset if switching activities
                const savedState = localStorage.getItem('activityTimerState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    if (state.activityId === activityId) {
                        this.activityTimer.elapsed = state.elapsed || 0;
                        this.activityTimer.running = state.running || false;
                    } else {
                        this.activityTimer.elapsed = 0;
                        this.activityTimer.running = false;
                    }
                }
                
                this.updateActivityTimerDisplay();
                
                // Update play button state
                const playBtn = document.getElementById('activityPlayBtn');
                if (this.activityTimer.running) {
                    playBtn.classList.add('playing');
                    playBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    `;
                } else {
                    playBtn.classList.remove('playing');
                    playBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    `;
                }
            },

            saveTimerState() {
                this.safeLocalStorageSet('activityTimerState', JSON.stringify({
                    activityId: this.activityTimer.activityId,
                    elapsed: this.activityTimer.elapsed,
                    running: this.activityTimer.running
                }));
            },

            loadTimerState() {
                // Timer state is loaded when activities are loaded
                // This just ensures the timer tick is running
            },

            findModuleById(moduleId) {
                if (!this.courseData || !this.courseData.modules) return null;
                return this.courseData.modules.find(m => m.id === moduleId);
            },

            getModuleIdForActivity(activityId) {
                if (!this.courseData || !this.courseData.modules) return null;
                for (const module of this.courseData.modules) {
                    for (const moment of module.moments) {
                        for (const submoment of moment.submoments) {
                            for (const activity of submoment.activities) {
                                if (activity.id === activityId) {
                                    return module.id;
                                }
                            }
                        }
                    }
                }
                return null;
            },

            // ===== EXPORT METHODS =====

            // ===== IMPORT/EXPORT METHODS =====

            openImportDialog() {
                try {
                    console.log('openImportDialog called');

                    const fileInput = document.getElementById('importFileInput');
                    if (!fileInput) {
                        console.error('File input element not found!');
                        this.setStatus('Import error: import control not configured.', 'error');
                        return;
                    }

                    console.log('Triggering file input click');
                    fileInput.click();
                } catch (error) {
                    console.error('Error in openImportDialog:', error);
                    this.setStatus('Import error: ' + error.message, 'error');
                }
            },

            openGithubImportModal() {
                try {
                    console.log('openGithubImportModal called');

                    // Show sidebar if hidden
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('hidden');
                    }

                    // Focus on GitHub URL input
                    const githubInput = document.getElementById('githubUrlInput');
                    if (githubInput) {
                        setTimeout(() => {
                            githubInput.focus();
                            githubInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                } catch (error) {
                    console.error('Error in openGithubImportModal:', error);
                }
            },

            loadFromWelcomeGithub() {
                try {
                    const input = document.getElementById('welcomeGithubUrlInput');
                    if (!input) {
                        console.error('Welcome GitHub URL input not found');
                        return;
                    }

                    const userInput = input.value.trim();
                    if (!userInput) {
                        alert('Please enter a GitHub URL or path.');
                        input.focus();
                        return;
                    }

                    // Confirm before replacing existing content
                    if (this.courseData && this.courseData.modules && this.courseData.modules.length > 0) {
                        if (!confirm('Importing new content will replace the current training content and reset all progress.\n\nContinue?')) {
                            return;
                        }
                    }

                    let rawUrl;

                    // Check if it's a full raw GitHub URL
                    if (userInput.startsWith('https://raw.githubusercontent.com/')) {
                        rawUrl = userInput;
                    } else if (userInput.startsWith('https://github.com/')) {
                        // Convert web URL to raw URL
                        rawUrl = userInput
                            .replace('github.com', 'raw.githubusercontent.com')
                            .replace('/blob/', '/');
                    } else {
                        // Parse the short URL: username/repo/branch/path/file.json
                        const parts = userInput.split('/');
                        if (parts.length < 3) {
                            alert('Format: username/repo/branch/path/file.json or paste a GitHub URL');
                            input.focus();
                            return;
                        }

                        const username = parts[0];
                        const repo = parts[1];
                        const restPath = parts.slice(2).join('/');

                        // Construct raw GitHub URL
                        rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/${restPath}`;
                    }

                    console.log('Loading from GitHub (welcome):', rawUrl);

                    // Detect file type from URL
                    const isMarkdown = rawUrl.toLowerCase().endsWith('.md');

                    // Fetch the file
                    fetch(rawUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            try {
                                if (isMarkdown) {
                                    console.log('GitHub Markdown loaded successfully from welcome');
                                    this.importMarkdown(text);
                                } else {
                                    const jsonData = JSON.parse(text);
                                    console.log('GitHub JSON loaded successfully from welcome');
                                    this.importJSON(jsonData);
                                }
                                // Clear input on success
                                input.value = '';
                            } catch (error) {
                                console.error('Parse error:', error);
                                const fileType = isMarkdown ? 'Markdown' : 'JSON';
                                alert(`Invalid ${fileType}: ` + error.message);
                            }
                        })
                        .catch(error => {
                            console.error('GitHub fetch error:', error);
                            alert('Failed to load: ' + error.message);
                        });
                } catch (error) {
                    console.error('Error in loadFromWelcomeGithub:', error);
                    alert('Error: ' + error.message);
                }
            },

            hasProgress() {
                return this.completedActivities.size > 0 || 
                       this.visitedActivities.size > 0 || 
                       this.activityTimer.elapsed > 0;
            },

            handleFileSelect(event) {
                try {
                    console.log('handleFileSelect called', event);

                    const file = event.target.files[0];
                    if (!file) {
                        console.log('No file selected');
                        return;
                    }

                    console.log('File selected:', file.name, file.size, 'bytes');

                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        this.setStatus('Import error: file is too large (max 10MB).', 'error');
                        event.target.value = '';
                        return;
                    }

                    // Confirm before replacing existing content
                    if (this.courseData && this.courseData.modules && this.courseData.modules.length > 0) {
                        if (!confirm('Importing a new file will replace the current training content and reset all progress.\n\nContinue?')) {
                            event.target.value = '';
                            return;
                        }
                    }

                    // Show loading indicator
                    this.setStatus('Loading "' + file.name + '"...', 'info');

                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            const fileContent = e.target.result;

                            // Detect file type by extension
                            if (file.name.endsWith('.md')) {
                                console.log('File loaded, parsing Markdown...');
                                this.importMarkdown(fileContent);
                            } else {
                                console.log('File loaded, parsing JSON...');
                                const jsonData = JSON.parse(fileContent);
                                console.log('JSON parsed successfully');
                                this.importJSON(jsonData);
                            }
                            event.target.value = '';
                        } catch (error) {
                            console.error('Parse error:', error);
                            this.setStatus('Import error: ' + error.message, 'error');
                            event.target.value = '';
                        }
                    };

                    reader.onerror = (error) => {
                        console.error('File read error:', error);
                        this.setStatus('Import error: could not read the file. Please try again.', 'error');
                        event.target.value = '';
                    };

                    console.log('Starting file read...');
                    reader.readAsText(file);
                } catch (error) {
                    console.error('Error in handleFileSelect:', error);
                    this.setStatus('Error: ' + error.message, 'error');
                }
            },

            loadFromGitHub() {
                try {
                    const input = document.getElementById('githubUrlInput');
                    const statusEl = document.getElementById('githubImportStatus');

                    if (!input) {
                        console.error('GitHub URL input not found');
                        this.setGitHubStatus('Error: GitHub import control not found.', 'error');
                        return;
                    }

                    const userInput = input.value.trim();
                    if (!userInput) {
                        this.setGitHubStatus('Please enter a GitHub URL or path.', 'error');
                        return;
                    }

                    // Confirm before replacing existing content
                    if (this.courseData && this.courseData.modules && this.courseData.modules.length > 0) {
                        if (!confirm('Importing new content will replace the current training content and reset all progress.\n\nContinue?')) {
                            return;
                        }
                    }

                    let rawUrl;

                    // Check if it's a full raw GitHub URL
                    if (userInput.startsWith('https://raw.githubusercontent.com/')) {
                        rawUrl = userInput;
                    } else if (userInput.startsWith('https://github.com/')) {
                        // Convert web URL to raw URL
                        rawUrl = userInput
                            .replace('github.com', 'raw.githubusercontent.com')
                            .replace('/blob/', '/');
                    } else {
                        // Parse the short URL: username/repo/branch/path/file.json
                        const parts = userInput.split('/');
                        if (parts.length < 3) {
                            this.setGitHubStatus('Paste GitHub URL or: username/repo/branch/path/file.json', 'error');
                            return;
                        }

                        const username = parts[0];
                        const repo = parts[1];
                        const restPath = parts.slice(2).join('/');

                        // Construct raw GitHub URL
                        rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/${restPath}`;
                    }

                    console.log('Loading from GitHub:', rawUrl);
                    this.setGitHubStatus('Loading from GitHub...', 'info');

                    // Store URL for refresh
                    this._lastGithubUrl = userInput;
                    this._lastGithubRawUrl = rawUrl;
                    document.getElementById('refreshGithubBtn').disabled = false;

                    // Fetch the JSON
                    fetch(rawUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            try {
                                const jsonData = JSON.parse(text);
                                console.log('GitHub JSON loaded successfully');
                                this.setGitHubStatus('Loaded successfully', 'success');
                                this.importJSON(jsonData);
                            } catch (error) {
                                console.error('JSON parse error:', error);
                                this.setGitHubStatus('Invalid JSON: ' + error.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('GitHub fetch error:', error);
                            this.setGitHubStatus('Failed to load: ' + error.message, 'error');
                        });
                } catch (error) {
                    console.error('Error in loadFromGitHub:', error);
                    this.setGitHubStatus('Error: ' + error.message, 'error');
                }
            },

            refreshFromGitHub() {
                try {
                    if (!this._lastGithubRawUrl) {
                        this.setGitHubStatus('No previous GitHub URL to refresh.', 'error');
                        return;
                    }

                    // Confirm before replacing existing content
                    if (this.courseData && this.courseData.modules && this.courseData.modules.length > 0) {
                        if (!confirm('Refreshing will replace the current training content and reset all progress.\n\nContinue?')) {
                            return;
                        }
                    }

                    const rawUrl = this._lastGithubRawUrl;
                    console.log('Refreshing from GitHub:', rawUrl);
                    this.setGitHubStatus('Refreshing from GitHub...', 'info');

                    fetch(rawUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            try {
                                const jsonData = JSON.parse(text);
                                console.log('GitHub JSON refreshed successfully');
                                this.setGitHubStatus('Refreshed successfully', 'success');
                                this.importJSON(jsonData);
                            } catch (error) {
                                console.error('JSON parse error:', error);
                                this.setGitHubStatus('Invalid JSON: ' + error.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('GitHub refresh error:', error);
                            this.setGitHubStatus('Refresh failed: ' + error.message, 'error');
                        });
                } catch (error) {
                    console.error('Error in refreshFromGitHub:', error);
                    this.setGitHubStatus('Error: ' + error.message, 'error');
                }
            },

            setGitHubStatus(message, type = 'info') {
                const el = document.getElementById('githubImportStatus');
                if (!el) return;
                const text = (message || '').toString();
                el.textContent = text;
                if (text) {
                    el.setAttribute('data-type', type);
                } else {
                    el.removeAttribute('data-type');
                }

                if (this._githubStatusTimer) {
                    clearTimeout(this._githubStatusTimer);
                    this._githubStatusTimer = null;
                }

                if (text && type !== 'error') {
                    this._githubStatusTimer = setTimeout(() => {
                        const el2 = document.getElementById('githubImportStatus');
                        if (!el2) return;
                        el2.textContent = '';
                        el2.removeAttribute('data-type');
                    }, 6000);
                }
            },

            setStatus(message, type = 'info') {
                const el = document.getElementById('importStatus');
                if (!el) return;
                const text = (message || '').toString();
                el.textContent = text;
                if (text) {
                    el.setAttribute('data-type', type);
                } else {
                    el.removeAttribute('data-type');
                }

                if (this._statusTimer) {
                    clearTimeout(this._statusTimer);
                    this._statusTimer = null;
                }

                if (text) {
                    this._statusTimer = setTimeout(() => {
                        const el2 = document.getElementById('importStatus');
                        if (!el2) return;
                        el2.textContent = '';
                        el2.removeAttribute('data-type');
                    }, 6000);
                }
            },



            importJSON(data) {
                try {
                    console.log('importJSON called with data:', data);
                    
                    // Transformation logic for the specific schema
                    let processedData = data;
                    
                    // Check if this is the "Schema 2" format (Learning Design tool)
                    // It typically has "activities" at the root instead of "modules"
                    // and "schemaVersion" set to 2.
                    if (data.schemaVersion === 2 && Array.isArray(data.activities) && data.keyParams) {
                        console.log('Detected Learning Design Schema 2 format. Transforming...');
                        processedData = this.transformSchema2(data);
                    }

                    // Validate the JSON structure
                    console.log('Validating JSON structure...');
                    const validation = this.validateCourseData(processedData);
                    
                    if (!validation.valid) {
                        console.error('Validation failed:', validation.errors);
                        this.setStatus('Import error: invalid structure. ' + validation.errors.join(' | '), 'error');
                        return;
                    }

                    console.log('Validation passed! Resetting state...');
                    // Reset all state
                    this.resetAllState();

                    console.log('Loading new data...');
                    // Load new data
                    this.courseData = processedData;

                    console.log('Rebuilding navigation...');
                    // Rebuild UI
                    this.buildNavigation();
                    
                    // Update document title if available
                    if (processedData.title) {
                        document.title = processedData.title;
                        console.log('Document title updated to:', processedData.title);
                    }

                    // Afficher la slide de chronologie au lieu de la premiÃ¨re activitÃ©
                    this.generateTimelineSlide();

                    // Masquer les contrÃ´les de slides (non applicable pour la timeline)
                    const slideControls = document.getElementById('slideControls');
                    if (slideControls) {
                        slideControls.classList.add('hidden');
                    }

                    // Zoom controls are managed by the collapsible section â€” no need to hide explicitly

                    // Import feedback (non-modal)
                    this.setStatus('Content loaded: ' + (processedData.title || 'Training content') + '.', 'success');
                    console.log('Import completed successfully');
                } catch (error) {
                    console.error('Error in importJSON:', error);
                    this.setStatus('Import error: ' + error.message, 'error');
                }
            },

            importMarkdown(content) {
                try {
                    console.log('importMarkdown called');

                    if (!content || content.trim().length === 0) {
                        this.setStatus('Import error: file is empty.', 'error');
                        return;
                    }

                    // Split by --- (handles various whitespace scenarios)
                    // Regex matches --- on its own line with optional whitespace
                    const mdSlideSeparator = /^---$/m;
                    const rawSlides = content.split(mdSlideSeparator);

                    // Filter out empty sections
                    const slideContents = rawSlides
                        .map(s => (s || '').trim())
                        .filter(s => s.length > 0);

                    if (slideContents.length === 0) {
                        this.setStatus('Import error: no slides found in markdown file.', 'error');
                        return;
                    }

                    // Convert each slide from markdown to HTML
                    const slides = slideContents.map((slideContent, idx) => ({
                        number: idx + 1,
                        content: this.simpleMarkdownToHtml(slideContent)
                    }));

                    // Extract title from first line of first slide
                    const firstSlideLines = slideContents[0].split('\n');
                    let title = 'Untitled Activity';

                    if (firstSlideLines[0].startsWith('#')) {
                        // Remove markdown heading syntax
                        title = firstSlideLines[0].replace(/^#+\s*/, '').trim();
                    } else if (firstSlideLines[0].trim().length > 0) {
                        // Use first line as title if it's not a heading
                        title = firstSlideLines[0].trim();
                    }

                    // Create course data structure
                    const generatedData = {
                        title: title,
                        description: 'Training content imported from Markdown',
                        keyParams: {},
                        modules: [{
                            id: 'md-module-1',
                            title: title,
                            plannedMinutes: Math.max(30, Math.ceil(slides.length * 5)), // Estimate 5 min per slide
                            moments: [{
                                id: 'md-moment-1',
                                title: title,
                                submoments: [{
                                    id: 'md-submoment-1',
                                    title: title,
                                    activities: [{
                                        id: 'md-activity-1',
                                        title: title,
                                        description: '',
                                        plannedMinutes: Math.max(30, Math.ceil(slides.length * 5)),
                                        slides: slides,
                                        ignored: false,
                                        groupSize: '',
                                        place: '',
                                        trainer: '',
                                        evaluation: ''
                                    }]
                                }]
                            }]
                        }]
                    };

                    console.log('Generated course data from markdown:', generatedData);

                    // Validate the generated structure
                    const validation = this.validateCourseData(generatedData);

                    if (!validation.valid) {
                        console.error('Validation failed:', validation.errors);
                        this.setStatus('Import error: invalid structure. ' + validation.errors.join(' | '), 'error');
                        return;
                    }

                    // Import using the standard JSON import path
                    this.importJSON(generatedData);

                } catch (error) {
                    console.error('Error in importMarkdown:', error);
                    this.setStatus('Import error: ' + error.message, 'error');
                }
            },

            transformSchema2(sourceData) {
                // Adapts Learning Design Schema (Schema 2) to Presentation Schema
                // Schema 2 stores "targetTime" at module level; unit is indicated in keyParams (e.g., hours).
                const globalTargetUnit = (sourceData.keyParams && (sourceData.keyParams.learningTimeUnit || sourceData.keyParams.designedTimeUnit)) 
                    ? String(sourceData.keyParams.learningTimeUnit || sourceData.keyParams.designedTimeUnit).trim() 
                    : 'minutes';

                const toMinutes = (val, unit) => {
                    const raw = (val === undefined || val === null) ? '' : String(val).trim();
                    const num = Number(raw);
                    if (!Number.isFinite(num)) return 0;
                    const u = (unit === undefined || unit === null) ? '' : String(unit).trim().toLowerCase();

                    // Check if unit is numeric (multiplier in seconds)
                    const numericUnit = Number(u);
                    if (Number.isFinite(numericUnit) && numericUnit > 0) {
                        // Unit is a numeric multiplier in seconds, convert to minutes
                        return Math.round((num * numericUnit) / 60);
                    }

                    // Check for text-based units
                    if (u.startsWith('hour') || u === 'h' || u === 'hrs' || u === 'hr') return Math.round(num * 60);
                    // Default: treat as minutes
                    return Math.round(num);
                };

                // Helper function to convert a step to an activity
                const stepToActivity = (srcStep) => {
                    let slides = [];

                    if (srcStep.presentation) {
                        if (Array.isArray(srcStep.presentation)) {
                            slides = srcStep.presentation.map((slide, idx) => ({
                                number: idx + 1,
                                title: '',
                                content: slide.content || slide.html || ''
                            }));
                        } else if (typeof srcStep.presentation === 'string') {
                            const mdSlideSeparator = /(?:^|\r?\n)\s*---\s*(?:\r?\n|$)/;

                            if (mdSlideSeparator.test(srcStep.presentation)) {
                                const rawSlides = srcStep.presentation.split(mdSlideSeparator);
                                const cleanSlides = rawSlides
                                    .map(s => (s || '').trim())
                                    .filter(s => s.length > 0);

                                if (cleanSlides.length > 0) {
                                    slides = cleanSlides.map((content, idx) => ({
                                        number: idx + 1,
                                        title: '',
                                        content: this.simpleMarkdownToHtml(content)
                                    }));
                                }
                            }

                            if (slides.length === 0) {
                                slides = [{
                                    number: 1,
                                    title: '',
                                    content: this.simpleMarkdownToHtml(srcStep.presentation)
                                }];
                            }
                        }
                    }

                    if (slides.length === 0) {
                        slides = [{
                            number: 1,
                            title: '',
                            content: '<div class="slide-content"><p><em>No presentation content defined for this activity.</em></p></div>'
                        }];
                    }

                    return {
                        id: srcStep.id || `act-${Math.random().toString(36).substr(2, 9)}`,
                        title: srcStep.title || 'Untitled Activity',
                        description: srcStep.description || srcStep.objective || '',
                        plannedMinutes: toMinutes(srcStep.duration || 0, srcStep.unit || srcStep.durationUnit || 'minutes'),
                        ignored: srcStep.ignored || false,
                        slides: slides,
                        groupSize:  srcStep.groupSize  || '',
                        place:      srcStep.place      || '',
                        trainer:    srcStep.trainer    || '',
                        evaluation: srcStep.evaluation || '',
                    };
                };

                const modules = sourceData.activities.map(srcModule => {
                    // Collect all activities from all moments, handling each moment individually
                    const moduleActivities = [];
                    const moments = [];

                    (srcModule.moments || []).forEach(srcMoment => {
                        const hasSubmoments = (srcMoment.subMoments && srcMoment.subMoments.length > 0) ||
                                             (srcMoment.submoments && srcMoment.submoments.length > 0);
                        const hasStepsDirectly = srcMoment.steps && Array.isArray(srcMoment.steps) && srcMoment.steps.length > 0;

                        if (hasStepsDirectly && !hasSubmoments) {
                            // This moment has steps directly - wrap in a single synthetic submoment
                            // so the moment appears in the nav tree
                            moments.push({
                                id: srcMoment.id || `mom-${Math.random().toString(36).substr(2, 9)}`,
                                title: srcMoment.title || 'Untitled Moment',
                                description: srcMoment.description || '',
                                ignored: srcMoment.ignored || false,
                                submoments: [{
                                    id: `sub-${srcMoment.id || Math.random().toString(36).substr(2, 9)}`,
                                    title: srcMoment.title || 'Untitled Submoment',
                                    description: srcMoment.description || '',
                                    ignored: false,
                                    activities: srcMoment.steps.map(srcStep => stepToActivity(srcStep))
                                }]
                            });
                        } else if (hasSubmoments) {
                            // This moment has proper hierarchy - keep as moment
                            moments.push({
                                id: srcMoment.id || `mom-${Math.random().toString(36).substr(2, 9)}`,
                                title: srcMoment.title || 'Untitled Moment',
                                description: srcMoment.description || '',
                                ignored: srcMoment.ignored || false,
                                submoments: (srcMoment.subMoments || srcMoment.submoments || []).map(srcSub => {
                                    return {
                                        id: srcSub.id || `sub-${Math.random().toString(36).substr(2, 9)}`,
                                        title: srcSub.title || 'Untitled Submoment',
                                        description: srcSub.description || '',
                                        ignored: srcSub.ignored || false,
                                        activities: (srcSub.steps || []).map(srcStep => stepToActivity(srcStep))
                                    };
                                })
                            });
                        }
                        // If moment has neither submoments nor steps, skip it (empty moment like lunch break)
                    });

                    // Build module object with appropriate structure
                    const moduleObj = {
                        id: srcModule.id || `mod-${Math.random().toString(36).substr(2, 9)}`,
                        title: srcModule.title || 'Untitled Module',
                        description: srcModule.description || '',
                        plannedMinutes: toMinutes(srcModule.targetTime || 0, globalTargetUnit)
                    };

                    // Add moments if any exist
                    if (moments.length > 0) {
                        moduleObj.moments = moments;
                    }

                    // Add module-level activities if any exist
                    if (moduleActivities.length > 0) {
                        moduleObj.activities = moduleActivities;
                    }

                    return moduleObj;
                });

                return {
                    title: (sourceData.keyParams && (sourceData.keyParams.title || sourceData.keyParams.name)) ? (sourceData.keyParams.title || sourceData.keyParams.name) : 'Imported Course',
                    description: (sourceData.keyParams && sourceData.keyParams.description) ? sourceData.keyParams.description : '',
                    keyParams: sourceData.keyParams || {},
                    version: sourceData.version || '',
                    schemaVersion: sourceData.schemaVersion || 2,
                    exportedAt: sourceData.exportedAt || '',
                    modules: modules
                };
            },

            simpleMarkdownToHtml(markdown) {
                if (!markdown) return '';
                let html = markdown;

                // 1) Remove lines starting with "Title:"
                html = html.replace(/^Title:\s+.*$/gim, '');

                // 2) Remove purely whitespace lines left behind
                html = html.replace(/^\s*[\r\n]/gm, '');

                // Handle malformed Base64 images (missing closing parenthesis)
                // Pattern: ![...]data:image/...base64,... without closing )
                html = html.replace(/!\[([^\]]*)\]\((data:image\/[^;]+;base64,[A-Za-z0-9+/=]+)(?!\))/gim, (m, alt, url) => {
                    console.warn('Detected malformed Base64 image (missing closing parenthesis):', m.substring(0, 100) + '...');
                    return `<div class="image-error" style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin: 10px 0; text-align: center;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2" style="margin-bottom: 10px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <h3 style="color: #856404; margin: 10px 0; font-size: 18px;">Image Data Error</h3>
                        <p style="color: #856404; margin: 5px 0;">The Base64 image data is incomplete or malformed.</p>
                        <p style="color: #856404; margin: 5px 0; font-size: 14px;">Please re-export your JSON file with complete image data.</p>
                        <details style="margin-top: 15px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <summary style="cursor: pointer; color: #856404; font-weight: bold;">Technical Details</summary>
                            <p style="color: #856404; font-size: 12px; margin-top: 10px; word-break: break-all;">The markdown image syntax is missing the closing parenthesis. Expected format: <code>![alt](data:image/...)</code></p>
                        </details>
                    </div>`;
                });

                // Images: ![alt](url) -> <img>
                // (Do this before link handling so images are not converted into anchors.)
                // Updated regex to handle long Base64 strings (including newlines)
                html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/gims, (m, alt, url) => {
                    const safeAlt = (alt || '').replace(/"/g, '&quot;');
                    // Remove any whitespace/newlines from the URL (important for Base64)
                    const safeUrl = (url || '').replace(/\s/g, '').replace(/"/g, '&quot;');
                    return `<img class="md-image" src="${safeUrl}" alt="${safeAlt}" loading="lazy">`;
                });

                // Links: [text](url) -> <a>
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/gim, (m, text, url) => {
                    const safeText = (text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeUrl = (url || '').trim().replace(/"/g, '&quot;');
                    return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>`;
                });

                // Headers (e.g., # Title -> <h1>Title</h1>)
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');

                // Bold (e.g., **bold** -> <strong>bold</strong>)
                html = html.replace(/\*\*([^*]+?)\*\*/gim, '<strong>$1</strong>');

                // Italic (e.g., *italic* -> <em>italic</em>) - avoid matching **bold**
                html = html.replace(/\*(?!\*)([^*\n]+?)\*(?!\*)/gim, '<em>$1</em>');

                // Blockquotes (e.g., > text -> <blockquote>)
                html = html.replace(/^>\s+(.*)/gim, '<blockquote>$1</blockquote>');
                // Merge consecutive blockquotes
                html = html.replace(/<\/blockquote>\s*<blockquote>/gim, '<br>');

                // Unordered lists (basic: - item)
                html = html.replace(/^\s*-\s+(.*)/gim, '<li>$1</li>');
                html = html.replace(/(?:<li>.*?<\/li>\s*)+/gim, (m) => `<ul>${m}</ul>`);

                // Ordered lists (e.g., 1. item)
                html = html.replace(/^\s*\d+\.\s+(.*)/gim, '<oli>$1</oli>');
                html = html.replace(/(?:<oli>.*?<\/oli>\s*)+/gim, (m) => {
                    const items = m.replace(/<\/?oli>/g, (t) => t === '<oli>' ? '<li>' : '</li>');
                    return `<ol>${items}</ol>`;
                });

                // Simple tables (pipe-delimited)
                html = html.replace(/((?:^\|.+\|$\n?)+)/gim, (tableBlock) => {
                    const rows = tableBlock.trim().split('\n').filter(r => r.trim());
                    if (rows.length === 0) return tableBlock;

                    // Separator row: every cell between pipes contains only -, :, spaces
                    const isSeparator = row => /^\|(\s*:?-+:?\s*\|)+$/.test(row.trim());

                    const dataRows = rows.filter(r => !isSeparator(r));
                    if (dataRows.length === 0) return tableBlock;

                    const headerRow = dataRows[0];
                    const bodyRows = dataRows.slice(1);

                    const parseRow = (row, tag) => {
                        const cells = row.trim().split('|').filter((_, i, arr) => i > 0 && i < arr.length - 1);
                        return '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
                    };

                    let result = '<table><thead>' + parseRow(headerRow, 'th') + '</thead>';
                    if (bodyRows.length > 0) {
                        result += '<tbody>' + bodyRows.map(r => parseRow(r, 'td')).join('') + '</tbody>';
                    }
                    result += '</table>';
                    return result;
                });

                // Line breaks
                html = html.replace(/\n/g, '<br>');

                return html;
            },

            validateCourseData(data) {
                const errors = [];

                // Check root structure
                if (!data || typeof data !== 'object') {
                    return { valid: false, errors: ['Data must be an object'] };
                }

                if (!Array.isArray(data.modules)) {
                    errors.push('Missing or invalid "modules" array');
                    return { valid: false, errors };
                }

                if (data.modules.length === 0) {
                    errors.push('At least one module is required');
                }

                // Validate each module
                data.modules.forEach((module, moduleIndex) => {
                    const prefix = `Module ${moduleIndex + 1}`;

                    if (!module.id) errors.push(`${prefix}: Missing "id"`);
                    if (!module.title) errors.push(`${prefix}: Missing "title"`);

                    // Module must have either moments or activities
                    const hasMoments = Array.isArray(module.moments) && module.moments.length > 0;
                    const hasActivities = Array.isArray(module.activities) && module.activities.length > 0;

                    if (!hasMoments && !hasActivities) {
                        errors.push(`${prefix}: Must have either "moments" or "activities" array`);
                        return;
                    }

                    // Validate module-level activities if they exist
                    if (hasActivities) {
                        module.activities.forEach((activity, actIndex) => {
                            const actPrefix = `${prefix} > Activity ${actIndex + 1}`;

                            if (!activity.id) errors.push(`${actPrefix}: Missing "id"`);
                            if (!activity.title) errors.push(`${actPrefix}: Missing "title"`);
                            if (!Array.isArray(activity.slides)) {
                                errors.push(`${actPrefix}: Missing or invalid "slides" array`);
                            } else if (activity.slides.length === 0) {
                                errors.push(`${actPrefix}: At least one slide is required`);
                            } else {
                                activity.slides.forEach((slide, slideIndex) => {
                                    const slidePrefix = `${actPrefix} > Slide ${slideIndex + 1}`;
                                    if (slide.number === undefined) errors.push(`${slidePrefix}: Missing "number"`);
                                    if (!slide.content) errors.push(`${slidePrefix}: Missing "content"`);
                                });
                            }
                        });
                    }

                    // Validate moments if they exist
                    if (hasMoments) {
                        module.moments.forEach((moment, momentIndex) => {
                        const momentPrefix = `${prefix} > Moment ${momentIndex + 1}`;
                        
                        if (!moment.id) errors.push(`${momentPrefix}: Missing "id"`);
                        if (!moment.title) errors.push(`${momentPrefix}: Missing "title"`);
                        if (!Array.isArray(moment.submoments)) {
                            errors.push(`${momentPrefix}: Missing or invalid "submoments" array`);
                            return;
                        }

                            moment.submoments.forEach((submoment, subIndex) => {
                                const subPrefix = `${momentPrefix} > Submoment ${subIndex + 1}`;

                                if (!submoment.id) errors.push(`${subPrefix}: Missing "id"`);
                                if (!submoment.title) errors.push(`${subPrefix}: Missing "title"`);
                                if (!Array.isArray(submoment.activities)) {
                                    errors.push(`${subPrefix}: Missing or invalid "activities" array`);
                                    return;
                                }

                                submoment.activities.forEach((activity, actIndex) => {
                                    const actPrefix = `${subPrefix} > Activity ${actIndex + 1}`;

                                    if (!activity.id) errors.push(`${actPrefix}: Missing "id"`);
                                    if (!activity.title) errors.push(`${actPrefix}: Missing "title"`);
                                    if (!Array.isArray(activity.slides)) {
                                        errors.push(`${actPrefix}: Missing or invalid "slides" array`);
                                        return;
                                    }

                                    if (activity.slides.length === 0) {
                                        errors.push(`${actPrefix}: At least one slide is required`);
                                    }

                                    activity.slides.forEach((slide, slideIndex) => {
                                        const slidePrefix = `${actPrefix} > Slide ${slideIndex + 1}`;

                                        if (slide.number === undefined) errors.push(`${slidePrefix}: Missing "number"`);
                                        if (!slide.content) errors.push(`${slidePrefix}: Missing "content"`);
                                    });
                                });
                            });
                        });
                    }
                });

                return {
                    valid: errors.length === 0,
                    errors
                };
            },

            resetAllState() {
                // Clear progress
                this.completedActivities = new Set();
                this.visitedActivities = new Set();
                this.visitedSlides = new Set();

                // Reset timers
                this.stopTimerTicks();
this.activityTimer = {
                    elapsed: 0,
                    planned: 0,
                    running: false,
                    interval: null,
                    activityId: null
                };
                this.timerIntervalId = null;

                // Invalidate activity cache
                this._cachedActivitiesInOrder = null;

                // Reset UI state
                this.currentActivity = null;
                this.currentSlideIndex = 0;
                this.searchQuery = '';
                this.expandedNodes = new Set();
                this.zoomLevel = 100;
                this.detailsPanelExpanded = false;

                // Clear localStorage
                localStorage.clear();

                // Hide slide controls
                const slideControls = document.getElementById('slideControls');
                if (slideControls) {
                    slideControls.classList.add('hidden');
                }

                // Clear content
                const slideContainer = document.getElementById('slideContainer');
                if (slideContainer) {
                    slideContainer.innerHTML = '<div class="slide" style="text-align: center; padding: 60px 20px;"><h2>Welcome!</h2><p style="margin-top: 12px; color: var(--color-text-secondary);">Select an activity from the navigation to begin.</p></div>';
                }

                // Restart timer ticks
                this.startTimerTicks();
            },

            exportAsJSON() {
                if (!this.courseData) {
                    alert('âŒ No content to export. Please import content first.');
                    return;
                }

                const exportData = Object.assign({}, this.courseData, {
                    modules: this.getFilteredModules()
                });
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `training-content-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.closeExportModal();
            },

            // ===== ABOUT MODAL (DYNAMIC FROM IMPORTED JSON) =====
            formatMinutes(mins) {
                const m = Math.max(0, parseInt(mins || 0, 10));
                const h = Math.floor(m / 60);
                const r = m % 60;
                if (h <= 0) return `${m} min`;
                if (r === 0) return `${h} h`;
                return `${h} h ${r} min`;
            },

            populateAboutModal() {
                const titleEl = document.getElementById('aboutTitleValue');
                const authorsEl = document.getElementById('aboutAuthorsValue');
                const trainersEl = document.getElementById('aboutTrainersValue');
                const levelEl = document.getElementById('aboutLevelValue');
                const modeEl = document.getElementById('aboutModeValue');
                const cohortEl = document.getElementById('aboutCohortValue');
                const audienceEl = document.getElementById('aboutAudienceValue');
                const prereqEl = document.getElementById('aboutPrerequisitesValue');
                const learningEl = document.getElementById('aboutLearningTimeValue');
                const licenceEl = document.getElementById('aboutLicenceValue');
                const versionEl = document.getElementById('aboutVersionValue');

                const modulesEl = document.getElementById('aboutModulesValue');
                const activitiesEl = document.getElementById('aboutActivitiesValue');
                const slidesEl = document.getElementById('aboutSlidesValue');
                const plannedEl = document.getElementById('aboutPlannedValue');
                const descEl = document.getElementById('aboutDescriptionValue');
                const modulesListEl = document.getElementById('aboutModulesList');

                if (!titleEl || !modulesEl || !activitiesEl || !slidesEl || !plannedEl || !descEl || !modulesListEl) return;

                const setText = (el, value, fallback = 'â€“') => {
                    if (!el) return;
                    const v = (value === undefined || value === null) ? '' : String(value);
                    const clean = v.trim();
                    el.textContent = clean ? clean : fallback;
                };

                const formatValUnit = (val, unit) => {
                    const raw = (val === undefined || val === null) ? '' : String(val).trim();
                    if (!raw) return '';
                    const num = Number(raw);
                    const u = (unit === undefined || unit === null) ? '' : String(unit).trim().toLowerCase();

                    if (Number.isFinite(num) && u) {
                        if (u.startsWith('hour') || u === 'h') return `${num} ${num === 1 ? 'hour' : 'hours'}`;
                        if (u.startsWith('min')) return `${num} ${num === 1 ? 'minute' : 'minutes'}`;
                        return `${num} ${u}`;
                    }

                    if (u) return `${raw} ${u}`;
                    return raw;
                };

                // Reset UI
                modulesListEl.innerHTML = '';

                if (!this.courseData || !Array.isArray(this.courseData.modules)) {
                    titleEl.textContent = 'No content loaded';
                    setText(authorsEl, '', 'â€“');
                    setText(trainersEl, '', 'â€“');
                    setText(levelEl, '', 'â€“');
                    setText(modeEl, '', 'â€“');
                    setText(cohortEl, '', 'â€“');
                    setText(audienceEl, '', 'â€“');
                    setText(prereqEl, '', 'â€“');
                    setText(learningEl, '', 'â€“');
                    setText(licenceEl, '', 'â€“');
                    setText(versionEl, '', 'â€“');

                    modulesEl.textContent = 'â€“';
                    activitiesEl.textContent = 'â€“';
                    slidesEl.textContent = 'â€“';
                    plannedEl.textContent = 'â€“';
                    descEl.textContent = 'Import a JSON file to populate this section.';
                    descEl.style.display = 'block';
                    return;
                }

                const cd = this.courseData;
                const meta = (cd && typeof cd === 'object' && cd.keyParams && typeof cd.keyParams === 'object') 
                    ? cd.keyParams 
                    : ((cd && typeof cd === 'object' && cd.meta && typeof cd.meta === 'object') ? cd.meta : {});

                // Title & description (prefer keyParams when available)
                const titleText = meta.title || meta.name || cd.title || 'Training content';
                titleEl.textContent = titleText;

                const descCandidate = meta.description || cd.description || cd.summary || cd.context || '';
                if (descCandidate) {
                    descEl.textContent = String(descCandidate);
                    descEl.style.display = 'block';
                } else {
                    descEl.textContent = '';
                    descEl.style.display = 'none';
                }

                // Minimal upgrade fields (from keyParams if present)
                setText(authorsEl, meta.authors || cd.authors);
                setText(trainersEl, meta.trainers || cd.trainers);
                setText(levelEl, meta.level || cd.level);
                setText(modeEl, meta.mode || cd.mode);
                setText(cohortEl, meta.cohortSize || cd.cohortSize);

                setText(audienceEl, meta.targetAudience || cd.targetAudience);
                setText(prereqEl, meta.prerequisites || cd.prerequisites);
                const learningTimeText = formatValUnit(
                    meta.learningTimeVal || cd.learningTimeVal || cd.learningTime,
                    meta.learningTimeUnit || cd.learningTimeUnit
                );
                setText(learningEl, learningTimeText);

                const licenceText = meta.licence || meta.license || cd.licence || cd.license || '';
                setText(licenceEl, licenceText);

                const versionText = meta.versionNumber || cd.versionNumber || cd.version || '';
                setText(versionEl, versionText);

                // Counts
                const moduleCount = cd.modules.length;
                let activityCount = 0;
                let slideCount = 0;

                // Planned minutes: prefer module.plannedMinutes if provided, else sum activity.plannedMinutes
                let plannedFromModules = 0;
                let plannedFromActivities = 0;

                cd.modules.forEach((module) => {
                    plannedFromModules += parseInt(module.plannedMinutes || 0, 10) || 0;

                    // Count module-level activities
                    if (module.activities && Array.isArray(module.activities)) {
                        module.activities.forEach((activity) => {
                            // Skip ignored activities
                            if (activity.ignored === true) return;

                            activityCount += 1;
                            plannedFromActivities += parseInt(activity.plannedMinutes || 0, 10) || 0;
                            const slides = Array.isArray(activity.slides) ? activity.slides : [];
                            slideCount += slides.length;
                        });
                    }

                    // Count activities within moments and submoments
                    (module.moments || []).forEach((moment) => {
                        // Skip ignored moments
                        if (moment.ignored === true) return;

                        (moment.submoments || []).forEach((submoment) => {
                            // Skip ignored submoments
                            if (submoment.ignored === true) return;

                            (submoment.activities || []).forEach((activity) => {
                                // Skip ignored activities
                                if (activity.ignored === true) return;

                                activityCount += 1;
                                plannedFromActivities += parseInt(activity.plannedMinutes || 0, 10) || 0;
                                const slides = Array.isArray(activity.slides) ? activity.slides : [];
                                slideCount += slides.length;
                            });
                        });
                    });
                });

                const plannedMinutes = plannedFromModules > 0 ? plannedFromModules : plannedFromActivities;

                modulesEl.textContent = String(moduleCount);
                activitiesEl.textContent = String(activityCount);
                slidesEl.textContent = String(slideCount);
                plannedEl.textContent = plannedMinutes > 0 ? this.formatMinutes(plannedMinutes) : 'â€“';

                // Build module cards directly from imported JSON
                cd.modules.forEach((module, moduleIndex) => {
                    const card = document.createElement('div');
                    card.className = 'about-module-card';

                    const title = document.createElement('div');
                    title.className = 'about-module-title';
                    title.textContent = `${moduleIndex + 1}. ${module.title || 'Untitled module'}`;

                    const desc = document.createElement('div');
                    desc.className = 'about-module-desc';
                    const moments = Array.isArray(module.moments) ? module.moments.length : 0;

                    // Count submoments and activities for quick scan
                    let submoments = 0;
                    let activities = 0;

                    // Count module-level activities
                    if (Array.isArray(module.activities)) {
                        activities += module.activities.filter(act => act.ignored !== true).length;
                    }

                    // Count activities within moments and submoments
                    if (Array.isArray(module.moments)) {
                        module.moments.forEach(m => {
                            // Skip ignored moments
                            if (m.ignored === true) return;

                            const nonIgnoredSubs = Array.isArray(m.submoments)
                                ? m.submoments.filter(s => s.ignored !== true)
                                : [];
                            submoments += nonIgnoredSubs.length;

                            if (Array.isArray(m.submoments)) {
                                m.submoments.forEach(s => {
                                    // Skip ignored submoments
                                    if (s.ignored === true) return;

                                    const nonIgnoredActivities = Array.isArray(s.activities)
                                        ? s.activities.filter(act => act.ignored !== true)
                                        : [];
                                    activities += nonIgnoredActivities.length;
                                });
                            }
                        });
                    }

                    const parts = [];
                    if (moments) parts.push(`${moments} moment${moments !== 1 ? 's' : ''}`);
                    if (submoments) parts.push(`${submoments} sub-moment${submoments !== 1 ? 's' : ''}`);
                    if (activities) parts.push(`${activities} activit${activities !== 1 ? 'ies' : 'y'}`);
                    desc.textContent = parts.length ? parts.join(' â€¢ ') : '';

                    const metaLine = document.createElement('div');
                    metaLine.className = 'about-module-meta';
                    const pm = parseInt(module.plannedMinutes || 0, 10) || 0;
                    metaLine.textContent = pm > 0 ? `Planned: ${this.formatMinutes(pm)}` : '';

                    card.appendChild(title);
                    card.appendChild(desc);
                    if (metaLine.textContent) card.appendChild(metaLine);

                    modulesListEl.appendChild(card);
                });
            },

            // ===== TIMELINE INTRO SLIDE =====

            generateTimelineSlide() {
                if (!this.courseData || !this.courseData.modules) {
                    return; // Pas de donnÃ©es Ã  afficher
                }

                const data = this.courseData;
                const container = document.getElementById('slideContainer');

                // Calculer les statistiques globales
                let totalModules = data.modules.length;
                let totalActivities = 0;
                let totalMinutes = 0;

                // Fonction helper pour calculer la durÃ©e d'un sous-moment
                const calculateSubmomentDuration = (submoment) => {
                    if (!submoment.activities) return 0;
                    return submoment.activities.reduce((sum, act) => {
                        // Skip ignored activities
                        if (act.ignored === true) return sum;
                        return sum + (act.plannedMinutes || 0);
                    }, 0);
                };

                // Fonction helper pour calculer la durÃ©e d'un moment
                const calculateMomentDuration = (moment) => {
                    if (!moment.submoments) return 0;
                    return moment.submoments.reduce((sum, sub) => {
                        // Skip ignored submoments
                        if (sub.ignored === true) return sum;
                        return sum + calculateSubmomentDuration(sub);
                    }, 0);
                };

                // Compter activitÃ©s et durÃ©e totale
                data.modules.forEach(module => {
                    let moduleDuration = module.plannedMinutes || 0;

                    // Count module-level activities
                    if (module.activities && Array.isArray(module.activities)) {
                        const nonIgnoredActivities = module.activities.filter(act => act.ignored !== true);
                        totalActivities += nonIgnoredActivities.length;
                        if (!moduleDuration) {
                            moduleDuration += module.activities.reduce((sum, act) => {
                                if (act.ignored === true) return sum;
                                return sum + (act.plannedMinutes || 0);
                            }, 0);
                        }
                    }

                    if (!moduleDuration && module.moments) {
                        // Calculer depuis les moments si plannedMinutes n'existe pas
                        moduleDuration = module.moments.reduce((sum, mom) => {
                            // Skip ignored moments
                            if (mom.ignored === true) return sum;
                            return sum + calculateMomentDuration(mom);
                        }, 0);
                    }

                    totalMinutes += moduleDuration;

                    // Compter activitÃ©s dans moments/submoments
                    module.moments?.forEach(mom => {
                        // Skip ignored moments
                        if (mom.ignored === true) return;
                        mom.submoments?.forEach(sub => {
                            // Skip ignored submoments
                            if (sub.ignored === true) return;
                            const nonIgnoredActivities = (sub.activities || []).filter(act => act.ignored !== true);
                            totalActivities += nonIgnoredActivities.length;
                        });
                    });
                });

                // GÃ©nÃ©rer HTML de la timeline
                let html = `
                    <div class="timeline-intro-slide">
                        <div class="timeline-header">
                            <h1 class="timeline-title">${this.escapeHTML(data.title || 'Training')}</h1>
                            <p class="timeline-subtitle">Training overview</p>
                            <div class="timeline-stats">
                                <span class="timeline-stat-item">
                                    <strong>${totalModules}</strong> module${totalModules > 1 ? 's' : ''}
                                </span>
                                <span class="timeline-stat-item">â€¢</span>
                                <span class="timeline-stat-item">
                                    <strong>${totalActivities}</strong> activit${totalActivities > 1 ? 'ies' : 'y'}
                                </span>
                                <span class="timeline-stat-item">â€¢</span>
                                <span class="timeline-stat-item">
                                    <strong>${this.formatMinutes(totalMinutes)}</strong> total
                                </span>
                            </div>
                            <div style="margin-top: 24px;">
                                <button class="btn btn-primary timeline-start-btn" onclick="app.startTraining()" aria-label="Start training">
                                    Start
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="timeline-content">
                `;

                // GÃ©nÃ©rer chaque module
                data.modules.forEach((module, modIndex) => {
                    const moduleNum = modIndex + 1;
                    let moduleDuration = module.plannedMinutes || 0;

                    if (!moduleDuration && module.moments) {
                        moduleDuration = module.moments.reduce((sum, mom) => {
                            return sum + calculateMomentDuration(mom);
                        }, 0);
                    }

                    html += `
                        <div class="timeline-module">
                            <div class="timeline-module-header">
                                <h2 class="timeline-module-title">Module ${moduleNum}. ${this.escapeHTML(module.title)}</h2>
                                <span class="timeline-module-duration">${this.formatMinutes(moduleDuration)}</span>
                            </div>
                    `;

                    // Show module-level activities if they exist
                    if (module.activities && Array.isArray(module.activities) && module.activities.length > 0) {
                        const nonIgnoredActivities = module.activities.filter(act => act.ignored !== true);
                        if (nonIgnoredActivities.length > 0) {
                            html += `<div class="timeline-submoments">`;
                            let actIndex = 0;
                            module.activities.forEach((activity) => {
                                // Skip ignored activities
                                if (activity.ignored === true) return;

                                actIndex++;
                                const actNum = `${moduleNum}.${actIndex}`;
                                const actDuration = activity.plannedMinutes || 0;
                                const slideCount = (activity.slides && activity.slides.length) ? activity.slides.length : 0;

                                html += `
                                    <div class="timeline-submoment">
                                        <span class="timeline-submoment-title">${actNum} ${this.escapeHTML(activity.title)}</span>
                                        <div class="timeline-submoment-info">
                                            <span class="timeline-submoment-activities">${slideCount} slide${slideCount !== 1 ? 's' : ''}</span>
                                            <span class="timeline-submoment-duration">${this.formatMinutes(actDuration)}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            html += `</div>`;
                        }
                    }

                    // GÃ©nÃ©rer les moments
                    if (module.moments && module.moments.length > 0) {
                        html += `<div class="timeline-moments">`;

                        let momIndex = 0;
                        module.moments.forEach((moment) => {
                            // Skip ignored moments
                            if (moment.ignored === true) return;

                            momIndex++;
                            const momentNum = `${moduleNum}.${momIndex}`;
                            const momentDuration = calculateMomentDuration(moment);

                            html += `
                                <div class="timeline-moment">
                                    <div class="timeline-moment-header">
                                        <h3 class="timeline-moment-title">${momentNum} ${this.escapeHTML(moment.title)}</h3>
                                        <span class="timeline-moment-duration">${this.formatMinutes(momentDuration)}</span>
                                    </div>
                            `;

                            // GÃ©nÃ©rer les sous-moments
                            if (moment.submoments && moment.submoments.length > 0) {
                                html += `<div class="timeline-submoments">`;

                                let subIndex = 0;
                                moment.submoments.forEach((submoment) => {
                                    // Skip ignored submoments
                                    if (submoment.ignored === true) return;

                                    subIndex++;
                                    const subNum = `${momentNum}.${subIndex}`;
                                    const subDuration = calculateSubmomentDuration(submoment);
                                    const nonIgnoredActivities = (submoment.activities || []).filter(act => act.ignored !== true);
                                    const actCount = nonIgnoredActivities.length;

                                    html += `
                                        <div class="timeline-submoment">
                                            <span class="timeline-submoment-title">${subNum} ${this.escapeHTML(submoment.title)}</span>
                                            <div class="timeline-submoment-info">
                                                <span class="timeline-submoment-activities">${actCount} activit${actCount > 1 ? 'ies' : 'y'}</span>
                                                <span class="timeline-submoment-duration">${this.formatMinutes(subDuration)}</span>
                                            </div>
                                        </div>
                                    `;
                                });

                                html += `</div>`; // .timeline-submoments
                            }

                            html += `</div>`; // .timeline-moment
                        });

                        html += `</div>`; // .timeline-moments
                    }

                    html += `</div>`; // .timeline-module
                });

                html += `
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            },

            startTraining() {
                // Aller Ã  la premiÃ¨re activitÃ©
                const allActivities = this.getAllActivitiesInOrder();
                if (allActivities.length > 0) {
                    this.loadActivity(allActivities[0]);
                }
            },

            showTimeline() {
                this.generateTimelineSlide();

                // Masquer contrÃ´les
                const slideControls = document.getElementById('slideControls');
                if (slideControls) slideControls.classList.add('hidden');

                // Zoom controls are managed by the collapsible section â€” no need to hide explicitly
            },

            escapeHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // ===== DARK MODE =====

            toggleDarkMode() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const newTheme = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                this.updateDarkModeButton(newTheme);
                this.safeLocalStorageSet('theme', newTheme);
            },

            updateDarkModeButton(theme) {
                const icon = document.getElementById('darkModeIcon');
                const btn = document.getElementById('darkModeToggle');
                if (icon) {
                    icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
                }
                if (btn) {
                    btn.setAttribute('data-tooltip', theme === 'dark' ? 'Light Mode' : 'Dark Mode');
                }
            },

            loadThemePreference() {
                const saved = this.safeLocalStorageGet('theme');
                // Default to light mode (no longer respecting system preference by default)
                const theme = saved || 'light';
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                this.updateDarkModeButton(theme);
            },

            // ===== SIDEBAR TOGGLE =====
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const isCollapsed = sidebar.classList.contains('collapsed');

                if (isCollapsed) {
                    sidebar.classList.remove('collapsed');
                    this.safeLocalStorageSet('sidebarCollapsed', 'false');
                } else {
                    sidebar.classList.add('collapsed');
                    this.safeLocalStorageSet('sidebarCollapsed', 'true');
                }
            },

            loadSidebarState() {
                const saved = this.safeLocalStorageGet('sidebarCollapsed');
                const sidebar = document.getElementById('sidebar');
                if (saved === 'true' && sidebar) {
                    sidebar.classList.add('collapsed');
                }
            },

            // ===== MODAL FOCUS TRAPPING =====
            _focusTrapHandler: null,
            _lastFocusedElement: null,

            trapFocus(modalEl) {
                this._lastFocusedElement = document.activeElement;
                const focusable = modalEl.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                if (focusable.length === 0) return;

                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                this._focusTrapHandler = (e) => {
                    if (e.key !== 'Tab') return;
                    if (e.shiftKey) {
                        if (document.activeElement === first) {
                            e.preventDefault();
                            last.focus();
                        }
                    } else {
                        if (document.activeElement === last) {
                            e.preventDefault();
                            first.focus();
                        }
                    }
                };

                modalEl.addEventListener('keydown', this._focusTrapHandler);
                first.focus();
            },

            releaseFocus(modalEl) {
                if (this._focusTrapHandler) {
                    modalEl.removeEventListener('keydown', this._focusTrapHandler);
                    this._focusTrapHandler = null;
                }
                if (this._lastFocusedElement && this._lastFocusedElement.focus) {
                    this._lastFocusedElement.focus();
                    this._lastFocusedElement = null;
                }
            },

            openAboutModal() {
                this.populateAboutModal();
                const modal = document.getElementById('aboutModal');
                modal.classList.add('visible');
                this.trapFocus(modal);
            },

            closeAboutModal() {
                const modal = document.getElementById('aboutModal');
                this.releaseFocus(modal);
                modal.classList.remove('visible');
            },

            openExportModal() {
                this.exportPendingFormat = null;
                this.exportSelectedModuleIds = new Set();
                const step1 = document.getElementById('exportStep1');
                const step2 = document.getElementById('exportStep2');
                const backBtn = document.getElementById('exportBackBtn');
                const confirmBtn = document.getElementById('exportConfirmBtn');
                const title = document.getElementById('exportModalTitle');
                const content = document.querySelector('#exportModal .export-modal-content');
                if (step1) step1.classList.remove('export-step--hidden');
                if (step2) step2.classList.add('export-step--hidden');
                if (backBtn) backBtn.classList.add('export-back-btn--hidden');
                if (confirmBtn) { confirmBtn.classList.add('export-confirm-btn--hidden'); confirmBtn.disabled = true; }
                if (content) content.classList.remove('export-step2-active');
                if (title) title.textContent = 'Export Content';
                const modal = document.getElementById('exportModal');
                modal.classList.add('visible');
                this.trapFocus(modal);
            },

            closeExportModal() {
                const modal = document.getElementById('exportModal');
                this.releaseFocus(modal);
                modal.classList.remove('visible');
            },

            beginExport(format) {
                if (!this.courseData) {
                    alert('No content to export. Please import content first.');
                    return;
                }
                this.exportPendingFormat = format;
                this.exportSelectedModuleIds = new Set(
                    this.courseData.modules.map(m => m.id)
                );
                this.renderExportModuleList();
                this.goToExportStep(2);
            },

            goToExportStep(step) {
                const step1 = document.getElementById('exportStep1');
                const step2 = document.getElementById('exportStep2');
                const backBtn = document.getElementById('exportBackBtn');
                const confirmBtn = document.getElementById('exportConfirmBtn');
                const title = document.getElementById('exportModalTitle');
                const content = document.querySelector('#exportModal .export-modal-content');
                if (step === 1) {
                    step1.classList.remove('export-step--hidden');
                    step2.classList.add('export-step--hidden');
                    backBtn.classList.add('export-back-btn--hidden');
                    confirmBtn.classList.add('export-confirm-btn--hidden');
                    if (content) content.classList.remove('export-step2-active');
                    title.textContent = 'Export Content';
                    const firstOption = step1.querySelector('.export-option');
                    if (firstOption) firstOption.focus();
                } else {
                    step1.classList.add('export-step--hidden');
                    step2.classList.remove('export-step--hidden');
                    backBtn.classList.remove('export-back-btn--hidden');
                    confirmBtn.classList.remove('export-confirm-btn--hidden');
                    if (content) content.classList.add('export-step2-active');
                    title.textContent = 'Select Modules';
                    const selectAllBtn = document.getElementById('exportSelectAllBtn');
                    if (selectAllBtn) selectAllBtn.focus();
                }
                this.updateExportConfirmState();
            },

            renderExportModuleList() {
                const list = document.getElementById('exportModuleList');
                if (!list || !this.courseData) return;
                list.innerHTML = '';
                this.courseData.modules.forEach((module) => {
                    const isChecked = this.exportSelectedModuleIds.has(module.id);
                    const checkboxId = `exportModule_${module.id}`;
                    const item = document.createElement('div');
                    item.className = 'export-module-item' + (isChecked ? ' is-checked' : '');
                    item.setAttribute('role', 'listitem');
                    item.innerHTML = `
                        <input type="checkbox"
                               id="${checkboxId}"
                               name="exportModule"
                               value="${module.id}"
                               ${isChecked ? 'checked' : ''}
                               aria-label="${this.escapeHTML(module.title)}">
                        <label class="export-module-item-label" for="${checkboxId}">
                            <div class="export-module-item-title">${this.escapeHTML(module.title)}</div>
                            ${module.plannedMinutes
                                ? `<div class="export-module-item-meta">${module.plannedMinutes} min</div>`
                                : ''}
                        </label>`;
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            this.exportSelectedModuleIds.add(module.id);
                            item.classList.add('is-checked');
                        } else {
                            this.exportSelectedModuleIds.delete(module.id);
                            item.classList.remove('is-checked');
                        }
                        this.updateExportConfirmState();
                        this.updateSelectAllButtonLabel();
                    });
                    item.addEventListener('click', (e) => {
                        if (e.target === checkbox || e.target.tagName === 'LABEL' || e.target.closest('label')) return;
                        checkbox.click();
                    });
                    list.appendChild(item);
                });
                this.updateExportConfirmState();
                this.updateSelectAllButtonLabel();
            },

            updateExportConfirmState() {
                const confirmBtn = document.getElementById('exportConfirmBtn');
                const countEl = document.getElementById('exportModuleCount');
                if (!this.courseData) return;
                const total = this.courseData.modules.length;
                const selected = this.exportSelectedModuleIds.size;
                if (countEl) countEl.textContent = `${selected} of ${total} selected`;
                if (confirmBtn) confirmBtn.disabled = selected === 0;
            },

            toggleSelectAllModules() {
                if (!this.courseData) return;
                const total = this.courseData.modules.length;
                const allSelected = this.exportSelectedModuleIds.size === total;
                if (allSelected) {
                    this.exportSelectedModuleIds.clear();
                } else {
                    this.courseData.modules.forEach(m => this.exportSelectedModuleIds.add(m.id));
                }
                const list = document.getElementById('exportModuleList');
                if (list) {
                    list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        const isNowChecked = this.exportSelectedModuleIds.has(cb.value);
                        cb.checked = isNowChecked;
                        cb.closest('.export-module-item').classList.toggle('is-checked', isNowChecked);
                    });
                }
                this.updateExportConfirmState();
                this.updateSelectAllButtonLabel();
            },

            updateSelectAllButtonLabel() {
                const btn = document.getElementById('exportSelectAllBtn');
                if (!btn || !this.courseData) return;
                const allSelected = this.exportSelectedModuleIds.size === this.courseData.modules.length;
                btn.textContent = allSelected ? 'Deselect all' : 'Select all';
            },

            getFilteredModules() {
                if (!this.courseData) return [];
                if (!this.exportSelectedModuleIds || this.exportSelectedModuleIds.size === 0) {
                    return this.courseData.modules;
                }
                return this.courseData.modules.filter(m => this.exportSelectedModuleIds.has(m.id));
            },

            confirmExport() {
                const format = this.exportPendingFormat;
                if (!format) return;
                switch (format) {
                    case 'markdown': this.exportAsMarkdown(); break;
                    case 'rtf':      this.exportAsRTF();      break;
                    case 'json':     this.exportAsJSON();      break;
                    case 'html':     this.exportAsHTML();      break;
                    case 'pdf':      this.exportAsPDF();      break;
                }
            },

            exportAsMarkdown() {
                if (!this.courseData) {
                    alert('âŒ No content to export. Please import content first.');
                    return;
                }
                
                let markdown = `# ${this.courseData.title || 'Training Content'}\n\n`;
                markdown += `*Generated on ${new Date().toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}*\n\n`;
                markdown += `---\n\n`;

                this.getFilteredModules().forEach(module => {
                    markdown += `## ${module.title}\n\n`;
                    if (module.plannedMinutes) {
                        markdown += `**Planned Duration:** ${module.plannedMinutes} minutes\n\n`;
                    }

                    module.moments.forEach(moment => {
                        markdown += `### ${moment.title}\n\n`;

                        moment.submoments.forEach(submoment => {
                            markdown += `#### ${submoment.title}\n\n`;

                            submoment.activities.forEach(activity => {
                                markdown += `##### ${activity.title}\n\n`;
                                if (activity.plannedMinutes) {
                                    markdown += `**Planned Duration:** ${activity.plannedMinutes} minutes\n\n`;
                                }

                                activity.slides.forEach((slide, index) => {
                                    markdown += `**SLIDE ${index + 1}**`;
                                    if (slide.title) {
                                        markdown += `: ${slide.title}`;
                                    }
                                    markdown += `\n\n`;

                                    // Convert HTML content to markdown
                                    const content = this.htmlToMarkdown(slide.content);
                                    markdown += content + '\n\n';
                                });

                                markdown += `---\n\n`;
                            });
                        });
                    });
                });

                this.downloadFile(markdown, 'AI_Training_Content.md', 'text/markdown');
                this.closeExportModal();
            },

            exportAsRTF() {
                if (!this.courseData) {
                    alert('âŒ No content to export. Please import content first.');
                    return;
                }
                
                let rtf = `{\\rtf1\\ansi\\deff0\n`;
                
                // Font table
                rtf += `{\\fonttbl{\\f0\\fswiss\\fcharset0 Arial;}{\\f1\\fmodern\\fcharset0 Courier New;}}\n`;
                
                // Color table
                rtf += `{\\colortbl;\\red25\\green118\\blue210;\\red33\\green33\\blue33;\\red117\\green117\\blue117;}\n`;
                
                // Title
                rtf += `{\\pard\\qc\\b\\fs32\\cf1 ${this.escapeRTF(this.courseData.title || 'Training Content')}\\par}\n`;
                rtf += `{\\pard\\qc\\fs20\\cf3\\i Generated on ${new Date().toLocaleDateString('en-GB')}\\par}\n`;
                rtf += `\\par\\par\n`;

                this.getFilteredModules().forEach(module => {
                    // Module title
                    rtf += `{\\pard\\b\\fs28\\cf1 ${this.escapeRTF(module.title)}\\par}\n`;
                    if (module.plannedMinutes) {
                        rtf += `{\\pard\\fs20\\cf2 Planned Duration: ${module.plannedMinutes} minutes\\par}\n`;
                    }
                    rtf += `\\par\n`;

                    (module.moments || []).forEach(moment => {
                        rtf += `{\\pard\\b\\fs24\\cf2 ${this.escapeRTF(moment.title)}\\par}\n`;
                        rtf += `\\par\n`;

                        (moment.submoments || []).forEach(submoment => {
                            rtf += `{\\pard\\b\\fs22\\cf2 ${this.escapeRTF(submoment.title)}\\par}\n`;
                            rtf += `\\par\n`;

                            (submoment.activities || []).forEach(activity => {
                                rtf += `{\\pard\\b\\fs20\\cf2 ${this.escapeRTF(activity.title)}\\par}\n`;
                                if (activity.plannedMinutes) {
                                    rtf += `{\\pard\\fs18\\cf3 Planned Duration: ${activity.plannedMinutes} minutes\\par}\n`;
                                }
                                rtf += `\\par\n`;

                                (activity.slides || []).forEach((slide, index) => {
                                    rtf += `{\\pard\\b\\fs20 SLIDE ${index + 1}`;
                                    if (slide.title) {
                                        rtf += `: ${this.escapeRTF(slide.title)}`;
                                    }
                                    rtf += `\\par}\n`;
                                    rtf += `\\par\n`;

                                    // Convert HTML content to RTF
                                    const content = this.htmlToRTF(slide.content);
                                    rtf += content;
                                    rtf += `\\par\n`;
                                });

                                rtf += `{\\pard\\qc ---\\par}\n`;
                                rtf += `\\par\n`;
                            });
                        });
                    });
                });

                rtf += `}`;

                this.downloadFile(rtf, 'AI_Training_Content.rtf', 'application/rtf');
                this.closeExportModal();
            },

            exportAsHTML() {
                if (!this.courseData) {
                    alert('âŒ No content to export. Please import content first.');
                    return;
                }

                let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.escapeHTML(this.courseData.title || 'Training')}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #333;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1565C0;
            border-bottom: 3px solid #E3F2FD;
            padding-bottom: 16px;
            margin-bottom: 24px;
        }
        h2 {
            color: #4527A0;
            margin-top: 32px;
            margin-bottom: 16px;
            border-left: 4px solid #F5F5F5;
            padding-left: 16px;
        }
        h3 {
            color: #00695C;
            margin-top: 24px;
            margin-bottom: 12px;
        }
        h4 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 8px;
        }
        .slide {
            background: #fafafa;
            padding: 20px;
            margin: 16px 0;
            border-left: 3px solid #2196F3;
            border-radius: 4px;
        }
        .slide-title {
            font-weight: 600;
            color: #1976D2;
            margin-bottom: 12px;
        }
        .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 32px;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${this.escapeHTML(this.courseData.title || 'Training')}</h1>
        <div class="meta">Generated on ${new Date().toLocaleDateString('en-GB', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })}</div>
`;

                this.getFilteredModules().forEach((module, modIndex) => {
                    html += `\n        <h2>Module ${modIndex + 1}. ${this.escapeHTML(module.title)}</h2>\n`;
                    if (module.plannedMinutes) {
                        html += `        <p class="meta">Planned duration: ${module.plannedMinutes} minutes</p>\n`;
                    }

                    if (module.moments && Array.isArray(module.moments)) {
                        module.moments.forEach((moment, momIndex) => {
                            if (moment.ignored === true) return;
                            html += `\n        <h3>Moment ${modIndex + 1}.${momIndex + 1} ${this.escapeHTML(moment.title)}</h3>\n`;

                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                moment.submoments.forEach((submoment, subIndex) => {
                                    if (submoment.ignored === true) return;
                                    html += `\n        <h4>Sub-moment ${modIndex + 1}.${momIndex + 1}.${subIndex + 1} ${this.escapeHTML(submoment.title)}</h4>\n`;

                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        submoment.activities.forEach((activity) => {
                                            if (activity.ignored === true) return;
                                            html += `\n        <div style="margin: 20px 0;">\n`;
                                            html += `            <strong>${this.escapeHTML(activity.title)}</strong>\n`;
                                            if (activity.plannedMinutes) {
                                                html += ` <span class="meta">(${activity.plannedMinutes} min)</span>`;
                                            }
                                            html += `\n`;

                                            if (activity.slides && Array.isArray(activity.slides)) {
                                                activity.slides.forEach((slide, slideIndex) => {
                                                    html += `            <div class="slide">\n`;
                                                    if (slide.title) {
                                                        html += `                <div class="slide-title">Slide ${slideIndex + 1}: ${this.escapeHTML(slide.title)}</div>\n`;
                                                    } else {
                                                        html += `                <div class="slide-title">Slide ${slideIndex + 1}</div>\n`;
                                                    }
                                                    html += `                <div>${slide.content || ''}</div>\n`;
                                                    html += `            </div>\n`;
                                                });
                                            }
                                            html += `        </div>\n`;
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                html += `
    </div>
</body>
</html>`;

                this.downloadFile(html, 'AI_Training_Content.html', 'text/html');
                this.closeExportModal();
            },

            exportAsPDF() {
                if (!this.courseData) {
                    alert('No content to export. Please import content first.');
                    return;
                }

                let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>${this.escapeHTML(this.courseData.title || 'Training')} â€” PDF Export</title>
    <style>
        @page {
            margin: 18mm 15mm;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.55;
            max-width: 820px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            font-size: 11pt;
        }
        h1 {
            color: #1565C0;
            border-bottom: 3px solid #E3F2FD;
            padding-bottom: 12px;
            margin-bottom: 16px;
            font-size: 22pt;
        }
        h2 {
            color: #4527A0;
            margin-top: 28px;
            margin-bottom: 12px;
            border-left: 4px solid #E8EAF6;
            padding-left: 14px;
            font-size: 16pt;
            page-break-before: always;
        }
        h2:first-of-type {
            page-break-before: avoid;
        }
        h3 {
            color: #00695C;
            margin-top: 20px;
            margin-bottom: 8px;
            font-size: 13pt;
        }
        h4 {
            color: #555;
            margin-top: 16px;
            margin-bottom: 6px;
            font-size: 11.5pt;
        }
        .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 24px;
        }
        .slide {
            background: #fafafa;
            padding: 14px 16px;
            margin: 10px 0;
            border-left: 3px solid #2196F3;
            border-radius: 3px;
            page-break-inside: avoid;
        }
        .slide-title {
            font-weight: 600;
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 10.5pt;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
            font-weight: 600;
        }
        code {
            background: #f5f5f5;
            padding: 1px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 9pt;
        }
        a {
            color: #1565C0;
        }
        @media print {
            body { padding: 0; }
        }
    </style>
</head>
<body>
    <h1>${this.escapeHTML(this.courseData.title || 'Training')}</h1>
    <div class="meta">Generated on ${new Date().toLocaleDateString('en-GB', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    })}</div>
`;

                this.getFilteredModules().forEach((module, modIndex) => {
                    html += `\n    <h2>Module ${modIndex + 1}. ${this.escapeHTML(module.title)}</h2>\n`;
                    if (module.plannedMinutes) {
                        html += `    <p class="meta">Planned duration: ${module.plannedMinutes} minutes</p>\n`;
                    }

                    if (module.moments && Array.isArray(module.moments)) {
                        module.moments.forEach((moment, momIndex) => {
                            if (moment.ignored === true) return;
                            html += `\n    <h3>Moment ${modIndex + 1}.${momIndex + 1} ${this.escapeHTML(moment.title)}</h3>\n`;

                            if (moment.submoments && Array.isArray(moment.submoments)) {
                                moment.submoments.forEach((submoment, subIndex) => {
                                    if (submoment.ignored === true) return;
                                    html += `\n    <h4>Sub-moment ${modIndex + 1}.${momIndex + 1}.${subIndex + 1} ${this.escapeHTML(submoment.title)}</h4>\n`;

                                    if (submoment.activities && Array.isArray(submoment.activities)) {
                                        submoment.activities.forEach((activity) => {
                                            if (activity.ignored === true) return;
                                            html += `\n    <div style="margin: 14px 0;">\n`;
                                            html += `        <strong>${this.escapeHTML(activity.title)}</strong>`;
                                            if (activity.plannedMinutes) {
                                                html += ` <span class="meta">(${activity.plannedMinutes} min)</span>`;
                                            }
                                            html += `\n`;

                                            if (activity.slides && Array.isArray(activity.slides)) {
                                                activity.slides.forEach((slide, slideIndex) => {
                                                    html += `        <div class="slide">\n`;
                                                    if (slide.title) {
                                                        html += `            <div class="slide-title">Slide ${slideIndex + 1}: ${this.escapeHTML(slide.title)}</div>\n`;
                                                    } else {
                                                        html += `            <div class="slide-title">Slide ${slideIndex + 1}</div>\n`;
                                                    }
                                                    html += `            <div>${slide.content || ''}</div>\n`;
                                                    html += `        </div>\n`;
                                                });
                                            }
                                            html += `    </div>\n`;
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                html += `
</body>
</html>`;

                // Open in new window and trigger print dialog
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('Pop-up blocked. Please allow pop-ups for this site and try again.');
                    return;
                }
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.addEventListener('load', () => {
                    printWindow.focus();
                    printWindow.print();
                });

                this.closeExportModal();
            },

            htmlToMarkdown(html) {
                if (!html) return '';
                
                // Create a temporary div to parse HTML
                const temp = document.createElement('div');
                temp.innerHTML = html;

                let markdown = '';

                // Process each child node
                const processNode = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        return node.textContent;
                    }

                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const tag = node.tagName.toLowerCase();

                        switch (tag) {
                            case 'p':
                                return Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '\n\n';
                            
                            case 'ul':
                                return '\n' + Array.from(node.children)
                                    .map(li => '- ' + Array.from(li.childNodes)
                                        .map(child => processNode(child))
                                        .join('')
                                        .trim())
                                    .join('\n') + '\n\n';
                            
                            case 'ol':
                                return '\n' + Array.from(node.children)
                                    .map((li, index) => `${index + 1}. ` + Array.from(li.childNodes)
                                        .map(child => processNode(child))
                                        .join('')
                                        .trim())
                                    .join('\n') + '\n\n';
                            
                            case 'strong':
                            case 'b':
                                return '**' + Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '**';
                            
                            case 'em':
                            case 'i':
                                return '*' + Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '*';
                            
                            case 'a':
                                const href = node.getAttribute('href');
                                const text = Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('');
                                return `[${text}](${href})`;
                            
                            case 'br':
                                return '\n';
                            
                            default:
                                return Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('');
                        }
                    }

                    return '';
                };

                markdown = Array.from(temp.childNodes)
                    .map(node => processNode(node))
                    .join('');

                return markdown.trim();
            },

            htmlToRTF(html) {
                if (!html) return '';
                
                const temp = document.createElement('div');
                temp.innerHTML = html;

                let rtf = '';

                const processNode = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        return this.escapeRTF(node.textContent);
                    }

                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const tag = node.tagName.toLowerCase();

                        switch (tag) {
                            case 'p':
                                return '{\\pard\\fs20 ' + Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '\\par}\n';
                            
                            case 'ul':
                            case 'ol':
                                return Array.from(node.children)
                                    .map(li => '{\\pard\\li360\\fs20 \\\'b7  ' + 
                                        Array.from(li.childNodes)
                                            .map(child => processNode(child))
                                            .join('') + '\\par}\n')
                                    .join('');
                            
                            case 'strong':
                            case 'b':
                                return '{\\b ' + Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '}';
                            
                            case 'em':
                            case 'i':
                                return '{\\i ' + Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('') + '}';
                            
                            case 'a':
                                const text = Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('');
                                return `{\\field{\\*\\fldinst{HYPERLINK "${node.getAttribute('href')}"}}` +
                                       `{\\fldrslt{\\ul\\cf1 ${text}}}}`;
                            
                            case 'br':
                                return '\\line ';
                            
                            default:
                                return Array.from(node.childNodes)
                                    .map(child => processNode(child))
                                    .join('');
                        }
                    }

                    return '';
                };

                rtf = Array.from(temp.childNodes)
                    .map(node => processNode(node))
                    .join('');

                return rtf;
            },

            escapeRTF(text) {
                if (!text) return '';
                return text
                    .replace(/\\/g, '\\\\')
                    .replace(/{/g, '\\{')
                    .replace(/}/g, '\\}')
                    .replace(/\n/g, '\\line ')
                    .replace(/[\u00A0-\uFFFF]/g, (char) => {
                        return '\\u' + char.charCodeAt(0) + '?';
                    });
            },

            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        };

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>

    <!-- ENHANCEMENT 7: Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle" onclick="if(event.target === this) toggleShortcutsModal()">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2 class="shortcuts-title" id="shortcutsTitle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                        <path d="M6 8h.01M10 8h.01M14 8h.01M6 12h.01M10 12h.01M14 12h.01M6 16h.01M10 16h.01M14 16h.01"></path>
                    </svg>
                    Keyboard Shortcuts
                </h2>
                <button class="shortcuts-close" onclick="toggleShortcutsModal()" aria-label="Close shortcuts">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span class="shortcut-label">Next Slide</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">â†’</span>
                        <span class="shortcut-key">Space</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Previous Slide</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">â†</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Next Section</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">N</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Search</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Ctrl</span>
                        <span class="shortcut-key">F</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Toggle Dark Mode</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">D</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Presentation Mode</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">P</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Keyboard Shortcuts</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">?</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Zoom In</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">+</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Zoom Out</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">-</span>
                    </div>
                </div>
                <div class="shortcut-item">
                    <span class="shortcut-label">Reset Zoom</span>
                    <div class="shortcut-keys">
                        <span class="shortcut-key">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCEMENT 8: Presentation Mode Toggle Button -->
    <button class="presentation-toggle" id="presentationToggle" onclick="togglePresentationMode()" title="Toggle Presentation Mode (P)" aria-label="Toggle presentation mode">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
    </button>


    <!-- ENHANCEMENT 8: Laser Pointer Effect -->
    <div class="laser-pointer-effect" id="laserPointer"></div>

    <script>
        // ===== ENHANCEMENT FUNCTIONS =====

        // Enhancement 7: Keyboard Shortcuts Modal
        function toggleShortcutsModal() {
            const modal = document.getElementById('shortcutsModal');
            modal.classList.toggle('visible');
        }

        // Enhancement 8: Presentation Mode
        function togglePresentationMode() {
            document.body.classList.toggle('presentation-mode');
            const btn = document.getElementById('presentationToggle');
            if (document.body.classList.contains('presentation-mode')) {
                btn.title = 'Exit Presentation Mode (P)';
                // Clear inline padding so the CSS-variable lateral margin takes effect
                const sc = document.querySelector('.slide-container');
                if (sc) sc.style.removeProperty('padding');
            } else {
                btn.title = 'Toggle Presentation Mode (P)';
                // Re-apply zoom padding for normal mode
                if (window.app && app.applyZoom) app.applyZoom();
            }
        }

        // Enhancement 8: Laser Pointer
        let laserActive = false;
        const laserPointer = document.getElementById('laserPointer');

        document.addEventListener('mousemove', (e) => {
            if (laserActive && document.body.classList.contains('presentation-mode')) {
                laserPointer.style.left = e.clientX + 'px';
                laserPointer.style.top = e.clientY + 'px';
            }
        });

        // Enhanced Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case '?':
                    e.preventDefault();
                    toggleShortcutsModal();
                    break;
                case 'p':
                case 'P':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        togglePresentationMode();
                    }
                    break;
                case 'n':
                case 'N':
                    if (!e.ctrlKey && !e.metaKey && app.goToNextSection) {
                        e.preventDefault();
                        app.goToNextSection();
                    }
                    break;
                case 'd':
                case 'D':
                    if (!e.ctrlKey && !e.metaKey && app.toggleTheme) {
                        e.preventDefault();
                        app.toggleTheme();
                    }
                    break;
                case 'l':
                case 'L':
                    if (document.body.classList.contains('presentation-mode')) {
                        e.preventDefault();
                        laserActive = !laserActive;
                        document.body.classList.toggle('laser-active', laserActive);
                    }
                    break;
                case 'Escape':
                    if (document.getElementById('shortcutsModal').classList.contains('visible')) {
                        toggleShortcutsModal();
                    } else if (document.body.classList.contains('presentation-mode')) {
                        togglePresentationMode();
                    }
                    break;
            }
        });

        // Enhancement 2: Update slide number indicator
        if (typeof app !== 'undefined') {
            const originalNavigateToSlide = app.navigateToSlide;
            app.navigateToSlide = function(...args) {
                if (originalNavigateToSlide) {
                    originalNavigateToSlide.apply(this, args);
                }
                updateSlideNumberIndicator();
            };
        }

        function updateSlideNumberIndicator() {
            let indicator = document.querySelector('.slide-number-indicator');
            if (!indicator && app.currentActivity && app.currentSlide !== undefined) {
                indicator = document.createElement('div');
                indicator.className = 'slide-number-indicator';
                document.querySelector('.slide-container')?.appendChild(indicator);
            }

            if (indicator && app.currentActivity && app.currentSlide !== undefined) {
                const currentSlideNum = app.currentSlide + 1;
                const totalSlides = app.currentActivity.slides?.length || 0;
                indicator.textContent = `${currentSlideNum} / ${totalSlides}`;
            }
        }

        // Enhancement 3: Enhanced breadcrumbs with clickable segments
        function enhanceBreadcrumbs() {
            const breadcrumb = document.getElementById('activityBreadcrumb');
            if (!breadcrumb || !app.currentModule || !app.currentActivity) return;

            const moduleName = app.currentModule.name;
            const activityName = app.currentActivity.name;

            breadcrumb.innerHTML = `
                <span class="breadcrumb-segment" onclick="app.navigateToModule('${app.currentModule.id}')">${moduleName}</span>
                <span class="breadcrumb-separator">â€º</span>
                <span class="breadcrumb-segment active">${activityName}</span>
            `;
        }

        // Enhancement 6: Time estimate display
        function addTimeEstimate() {
            const footer = document.querySelector('.sidebar-footer .progress-wrapper');
            if (footer && !document.querySelector('.time-estimate') && app.data) {
                let totalMinutes = 0;
                app.data.modules?.forEach(module => {
                    module.activities?.forEach(activity => {
                        if (activity.duration) {
                            totalMinutes += parseInt(activity.duration) || 0;
                        }
                    });
                });

                if (totalMinutes > 0) {
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    const timeText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                    const timeEstimate = document.createElement('div');
                    timeEstimate.className = 'time-estimate';
                    timeEstimate.innerHTML = `
                        <svg class="time-estimate-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span class="time-estimate-text">Est. ${timeText} total</span>
                    `;
                    footer.appendChild(timeEstimate);
                }
            }
        }

        // Initialize enhancements when app is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addTimeEstimate();
            }, 1000);
        });
    </script>
</body>
</html>
